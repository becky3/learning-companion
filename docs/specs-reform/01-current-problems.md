# 仕様書の現在の問題点

Issue: #572

`docs/specs/` 配下の全30ファイルを総点検した結果をまとめる。

---

## 1. 文書の種類が区別されていない

全て `docs/specs/` にフラットに配置されているが、実際には異なる性質の文書が混在している:

- **プロダクト機能**: f1(チャット), f2(情報収集), f3(プロファイリング) など
- **基盤機能**: f5(MCP統合), f9(RAG)
- **開発ツール**: f11(CLIアダプター)
- **出力整形**: f10(Slack mrkdwn)
- **ワークフロー**: git-flow, auto-progress, copilot-auto-fix
- **エージェント定義**: test-runner-agent, code-review-agent 等
- **スキル定義**: doc-gen-skill, handoff-skill 等
- **チーム定義**: agent-teams/*

種類が違うのに同じテンプレートを適用しようとした結果、合わない仕様書が肥大化している。

## 2. f番号による通し管理の問題

f1〜f11 で通し番号を振ることで「全て同じ種類の機能」という前提が生まれている。実際には:

- f1〜f4: ユーザー向けコア機能
- f5, f9: 基盤機能（ユーザーは直接意識しない）
- f6, f7, f8: Bot動作の拡張
- f10: 出力フォーマット変換
- f11: 開発用テストツール

番号管理の弊害:

- 異なる性質のものが同列に見える
- 追加時に「次は何番？」という無意味な判断が発生
- 欠番・振り直し時に、コミットメッセージ・テスト名・docstring 等の参照が壊れる

## 3. 実装の直接記述

多くの仕様書に Python コード（dataclass定義、クラス実装、関数シグネチャ）がそのまま記載されている。

**深刻なファイル:**

- `f5-mcp-integration.md` — 全クラスの骨格・メソッドシグネチャ・疑似コード（600行超）
- `f8-thread-support.md` — `ThreadHistoryService` の完全実装、ハンドラのコード（400行超）
- `f9-rag.md` — ABC定義・全継承クラスの実装・数式・パラメータチューニングガイド（1000行超）
- `bot-process-guard.md` — PIDFile管理クラス・プロセス確認の疑似コード全体

`planner-agent.md` が「関数名・クラス名・コードスニペットの記載を禁止」と定義しているにもかかわらず、多くの仕様書が違反している。

## 4. 設定値の直接記述

仕様変更時に仕様書とコードの両方を更新する必要が生じ、乖離リスクが高い。

**例:**

- ポート番号・URL: `http://localhost:1234`
- 数値定数: `TOOL_LOOP_MAX_ITERATIONS = 10`, タイムアウト値
- テーブル名・カラム名: `conversations`, `user_profiles`
- ユーザー名: `becky3`
- モデル名: `Claude Sonnet 4.5`
- パラメータ閾値: `α = 0.8 ~ 0.95`, `fetch_count: max(n_results * 3, 30)`

## 5. 過去の仕様の残存

### 完了済み情報の蓄積

- 取り消し線付きの旧AC（`~~AC5-old~~` 等）が複数残存
- 完了済みACが `[x]` のまま残り、仕様書としてのガイド機能を喪失
- 実装ステータスやPR番号が仕様書内に直接記述（`PR #217 で実装済み` 等）
- 廃止ファイルへの参照が残存

## 6. 受け入れ条件(AC)の問題

### ACの使い方の問題

ACは本来 Issue（作業単位）に書くべきもの。仕様書に書くべきは「要件・制約」（常に真であるべき記述）。現状は仕様書が Issue の役割を兼ねており、完了済みACが蓄積して肥大化の原因になっている。

### AC番号の混乱

- `f2-feed-collection.md`: AC番号が非連続に配置（AC7→AC13→AC8の順で、番号順と記載順が一致しない）
- `code-review-agent.md`: AC1〜13の後にAC20が出現し、AC14〜19はその後方にまとめて配置（番号順と記載順が不一致）
- `doc-review-agent.md`: AC10が欠番

### ACの内容の問題

- 実装詳細がACになっている（パラメータリネーム等）
- 検証不能・主観的なAC（「認識される」「優先」等の曖昧表現）
- 完了/未完了の中間状態で放置されたAC

## 7. セクション名の揺れ

同じ意味の内容に異なるセクション名が使われている:

- **技術内容**: 「技術仕様」「技術設計」「入出力仕様」「設計方針」「アーキテクチャ」（5種類）
- **制約系**: 「考慮事項」「注意事項」「技術的な注意点」「やらないこと」「スコープ境界」（5種類）

## 8. 仕様書に不要な内容の混入

本来は仕様書ではなく別の場所で管理すべき内容:

| 混入している内容 | 本来の置き場 |
|----------------|------------|
| 実装ステップ・タスクリスト | Issue / PR |
| 導入ロードマップ（Phase 1完了、Phase 2未実装 等） | プロジェクト管理（Issue/Milestone） |
| コスト見積もり・実験データ | 意思決定記録（ADR等） |
| 変更履歴 | Git |
| 関連Issue番号 | GitHub Issue のリンク |

## 9. その他

- `agent-teams/mixed-genius.md`: 「デフォルトキャラクター」というプレースホルダーが7箇所に未置換のまま残存
- `overview.md` と `README.md` の内容重複（SSOTが不明）
- `doc-review-agent.md` の許容/禁止基準がプロジェクト全体のルールとして明文化されていない
