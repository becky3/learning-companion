# 改善予定案

Issue: #572

仕様書改革で目指す姿と改善方針をまとめる。

**凡例**: `<<未決（Phase N）: ...>>` は、該当 Phase で決定する予定の未確定事項を示す。

---

## 1. スタイルガイドの策定

全仕様書が従うべきルールを明文化する。

### 1.1 文書種別の定義

仕様書を種別ごとに分類し、それぞれに適したテンプレートを定義する。

**分類の方針**: 全体を見ながら適切な分類を決めていく。現時点で見えている軸:

- ユーザー向け機能 vs 内部基盤
- プロダクトコード vs 開発ツール・プロセス
- エージェント / スキル / チーム

**決定済みの方針**: 文書種別ごとにディレクトリで分類する（`docs/specs/{カテゴリ}/`）。ファイル名は名前ベース（番号なし）とし、`{カテゴリ}/{ファイル名}` で一意性を担保する。

<<未決: 具体的なカテゴリ分類（カテゴリ名・各仕様書の所属）。各仕様書を実際に見ながら Phase 1 で決定する>>

### 1.2 種別ごとのテンプレート

各種別に必要なセクションを定義する。

**共通原則**:

- セクション名を統一する（「技術仕様」「技術設計」「設計方針」等の揺れを解消）
- 不要なセクションの混入を防ぐルールを設ける

<<未決（Phase 1）: 各種別のテンプレート詳細（必須セクション・任意セクション・禁止セクション）>>

Phase 1 のスコープには以下も含める:

- ファイル命名規則（名前の付け方の統一基準）
- `doc-review-agent.md` で定義されている許容/禁止基準のプロジェクト全体ルールとしての明文化

### 1.3 記述ルール

- **要件・制約**: 仕様書に書く（「常にこうあるべき」という恒久的な記述）
- **AC**: 仕様書には書かない。Issue に記載する
- **技術詳細**: What/Why 中心。How は反応的に追加（DD-3 参照）
- **設定値**: 具体値を仕様書にハードコードしない。設定ファイルや環境変数の存在と意味のみ記述
- **コード**: プロダクションコード（Python クラス・関数定義・疑似コード等）を仕様書に書かない。以下は許容する:
  - mermaid 図
  - CLIコマンド例（`git checkout -b`, `gh pr create` 等）
  - 設定ファイルの構造例（JSON, YAML 等）
  - shellcheck ディレクティブ等の書式例
- **過去情報**: 変更履歴・実装ステータス・PR番号・関連Issue番号を仕様書に書かない。関連Issueの紐付けは GitHub Issue のリンク機能で管理する
- **実験データ・コスト見積もり**: 仕様書に書かない。意思決定の根拠として残す場合は設計判断記録（DD文書等）に記載する
- **過去仕様の残存物**: 取り消し線付き旧AC・完了済みAC・廃止ファイルへの参照は、各仕様書リファクタリング時（セクション3）に除去する。除去後の再発防止は上記ルールで担保する

## 2. f番号の廃止とディレクトリ分類 + 名前ベースへの移行

- ファイルパス: `docs/specs/f9-rag.md` → `docs/specs/{カテゴリ}/rag.md`
- コミットメッセージ: `feat(f9):` → `feat(rag):`
- ブランチ名: `feature/f9-rag-#123` → `feature/rag-#123`
- docstring: `仕様: docs/specs/f9-rag.md` → 新パスに更新
- テスト名: `test_ac1_...` → 名前ベースに変更（AC廃止と連動）

<<未決（Phase 1）: 名前ベースのコミットプレフィックスの命名規則（例: feat(rag), feat(chat) のように仕様書名と一致させるか）>>

### 2.1 影響を受けるファイル一覧

f番号廃止・AC廃止により更新が必要なファイルの全体像:

| カテゴリ | ファイル群 | 箇所数 | 内容 |
|---------|----------|--------|------|
| 仕様書 | `docs/specs/f*.md` (11ファイル) | — | ファイルリネーム |
| ソースコード | `src/` 配下 (18ファイル) | 36箇所 | docstring のパス参照 |
| MCPサーバー | `mcp_servers/` 配下 (15ファイル) | 45箇所 | docstring のパス参照 |
| テスト | `tests/` 配下 (33ファイル) | 406箇所 | `test_ac{N}_` テスト名 |
| 開発ガイドライン | `CLAUDE.md` | 2箇所 | テスト名規約・ブランチ命名 |
| CI/レビュー | `.github/copilot-instructions.md` | 1箇所 | テスト名規約 |
| エージェント定義 | `.claude/agents/planner.md` | 4箇所 | F番号・AC番号テンプレート |
| スキル定義 | `.claude/skills/doc-gen/SKILL.md` | 1箇所 | f番号ファイル例示 |
| スキル定義 | `.claude/skills/doc-edit/SKILL.md` | 1箇所 | f番号ファイル例示 |
| スキル定義 | `.claude/skills/test-run/SKILL.md` | 1箇所 | テスト名例示 |
| Git運用 | `docs/specs/git-flow.md` | 3箇所 | ブランチ命名・コミット規約 |

**テスト名リネームの規模**: 33ファイル・406箇所のテスト関数名を変更する必要がある。仕様書ごとにマッピングテーブルを作成し、スクリプトで一括変換するアプローチを推奨する。

## 3. 各仕様書のリファクタリング

スタイルガイドを基準に、各ファイルを個別に修正する。

**修正内容**:

- スタイルガイドのテンプレートに合わせた構成変更
- コードスニペット・設定値の除去
- ACセクションの廃止 → 要件・制約セクションへの置き換え
- 過去情報（変更履歴・実装ステータス等）の除去
- f番号の除去、ファイルリネーム
- 対応するテスト名・docstring の更新

<<未決（Phase 3）: 各仕様書の具体的な修正内容リスト（スタイルガイド確定後にサブIssue化）>>

## 4. 休止中・陳腐化した文書の整理

- `auto-fix-structure.md`: 全体が休止中 → アーカイブまたは削除
- `auto-progress.md`: PRKit方式の記述を除去し、Copilot方式のみに整理
- `agent-teams/mixed-genius.md`: 「デフォルトキャラクター」プレースホルダーの解決

<<未決（Phase 4）: アーカイブの方法（削除 vs docs/archive/ に移動 vs ファイル内に休止中を明記）>>

## 5. overview.md と関連文書の整合性

- `overview.md` の仕様書テンプレートを新スタイルガイドに合わせて更新
- `overview.md` と `README.md` の内容重複を解消（SSOTを明確にする）
- `doc-gen-skill.md` のテンプレート参照を新スタイルガイドに更新
- CLAUDE.md の命名規約・参照パスを更新

<<未決（Phase 5）: overview.md 自体の位置づけ（スタイルガイドと統合するか、別に残すか）>>

## 6. トレーサビリティマトリクス

01の問題点と、本文書の改善策・04の実施フェーズの対応関係:

| 01の問題 | 改善策 | 04のPhase |
|---------|--------|----------|
| 1. 文書種類の混在 | 1.1 文書種別の定義 | Phase 1 |
| 2. f番号の問題 | 2. f番号廃止・ディレクトリ分類 | Phase 2, 3 |
| 3. 実装の直接記述 | 1.3 記述ルール（コード禁止） | Phase 3 |
| 4. 設定値の直接記述 | 1.3 記述ルール（設定値禁止） | Phase 3 |
| 5. 過去仕様の残存 | 1.3 記述ルール（過去情報禁止）+ 3. リファクタリング + 4. 休止中文書整理 | Phase 3, 4 |
| 6. AC問題 | 1.3 記述ルール（AC→Issue）+ 2. テスト名移行 | Phase 2, 3 |
| 7. セクション名の揺れ | 1.2 テンプレート（セクション名統一） | Phase 1 |
| 8. 不要な内容の混入 | 1.3 記述ルール（過去情報・実験データ・Issue番号禁止） | Phase 3 |
| 9. その他 | 4. 休止中文書整理 + 5. overview.md整合性 + 1.2 許容/禁止基準の明文化 | Phase 1, 3, 5 |
