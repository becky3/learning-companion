# 設計判断の記録

Issue: #572

仕様書改革に関する設計判断とその理由を記録する。

---

## DD-1: 受け入れ条件(AC)を仕様書から廃止する

**決定**: 仕様書からACセクションを廃止し、「要件・制約」セクションに置き換える。ACは今後 Issue に記載する。

**理由**:

- ACは本来「この作業が完了したか」の判定基準であり、Issue（一時的な作業単位）に紐づくもの
- 仕様書に書くべきは「このシステムは常にこうあるべき」という恒久的な要件・制約
- 仕様書にACを書いた結果、完了済みACが蓄積して文書が肥大化した
- 業界の一般的な使い分け: Issue=AC（一時的）、仕様書=要件（恒久的）、テスト=要件の検証（恒久的）

**影響**:

- 既存テスト名 `test_ac1_...` は名前ベースに移行する（各仕様書リファクタリング時にセットで対応）
- docstring の AC参照も同様に更新
- **規約の同期更新が必須**: CLAUDE.md・copilot-instructions.md・planner.md 等にテスト名規約（`test_ac{N}_...`）が明記されている。テスト名変更の開始前に、これらの規約文書を先行更新する（移行手順の Phase 2 参照）

## DD-2: f番号を廃止しディレクトリ分類 + 名前ベースに移行する

**決定**: `f1-chat.md` のような f番号による命名を廃止する。文書種別ごとにディレクトリで分類し（`docs/specs/{カテゴリ}/`）、ファイル名は名前ベース（`chat.md`）とする。

**理由**:

- 番号は異なる性質のものを同列に見せてしまう
- 追加・削除時に番号の振り直しが発生する
- 名前ベースの方が「何の仕様書か」が一目で分かる
- ディレクトリ分類により文書の性質が構造で表現される

**影響**:

- ファイルパス: `docs/specs/f9-rag.md` → `docs/specs/{カテゴリ}/rag.md`
- コミットメッセージ: `feat(f9):` → `feat(rag):` のように変更
- ファイルパス参照（CLAUDE.md, docstring等）の一括更新が必要
- 過去のコミット履歴は変更不可（割り切り）
- ブランチ命名規約の更新: `feature/f{N}-{機能名}` → `feature/{機能名}`
- 名前の一意性は `{カテゴリ}/{ファイル名}` で担保する

**未決事項**: 具体的なカテゴリ分類は Phase 1（スタイルガイド策定）で確定する。

## DD-3: 技術詳細は What/Why 中心、How は反応的に追加

**決定**: 仕様書には「何をするか（What）」「なぜそうするか（Why）」を中心に書く。「どう実装するか（How）」は原則書かず、AIが誤った実装判断をした実績がある箇所のみ制約として追記する。

**理由**:

- 業界調査の結果、主要フレームワークが Requirements → Design → Tasks の階層分離を採用しており、仕様書（What/Why）と実装詳細（How）の分離が業界標準となっている
- 本プロジェクトの実績から、仕様書に Requirements と Design と Tasks が1ファイルに混在していることが肥大化の根本原因と判明した
- 上記を踏まえ、How は「AIが誤った実装判断をした実績」をトリガーとして反応的に追加する方針を採用する

**参考資料**:

- [GitHub Spec Kit](https://github.com/github/spec-kit) — `/specify` → `/plan` → `/tasks` の三段階フロー
- [AWS Kiro](https://kiro.dev/docs/specs/) — requirements.md → design.md → tasks.md の三段階構造
- [JetBrains Junie: Spec-Driven Approach](https://blog.jetbrains.com/junie/2025/10/how-to-use-a-spec-driven-approach-for-coding-with-ai/) — requirements → plan の二段階構造
- [Thoughtworks: Understanding Spec-Driven-Development](https://martinfowler.com/articles/exploring-gen-ai/sdd-3-tools.html) — 上記ツールの比較分析

**仕様書に書くもの / 書かないもの**:

| 書く | 書かない |
|------|---------|
| 振る舞いの要件（入出力、制約、不変条件） | 疑似コード・メソッド実装 |
| コンポーネント間の関係（mermaid図） | クラス名・メソッドシグネチャ |
| 具体例（エッジケースを含む） | 設定値のハードコード |
| 「こうしてはいけない」制約 | 実装ステップ |

**How を追加する場合の記録ルール**:

AIが誤った実装判断をした実績に基づき How を追加する際は、追加理由をHTMLコメントで記録する。これにより将来の削除判断も可能になる。

```markdown
<!-- How追加理由: PR #140 で os.kill の Windows 非互換が検出 -->
```

## DD-4: 仕様書の種別ごとにテンプレートを変える

**決定**: 全仕様書に同一テンプレートを適用するのではなく、文書の種類に応じた適切なテンプレートを定義する。

**理由**:

- 現状は `overview.md` に定義されたテンプレート（概要/ユーザーストーリー/入出力仕様/受け入れ条件/...）を全文書に適用しようとしている
- プロダクト機能・エージェント定義・ワークフロー定義では必要なセクションが根本的に異なる
- 合わないテンプレートに無理に従った結果、不要なセクションの追加や、本来不要な技術詳細の記述が発生した

## DD-5: 改革計画は docs/specs-reform/ で管理する

**決定**: Issue ではなく `docs/specs-reform/` 配下の文書群で改革計画を管理する。

**理由**:

- Issue には大きすぎる内容
- 今後何度も参照する長期的な計画文書
- 改革完了後にこのフォルダは役目を終える
