# Bot プロセスガード — レトロスペクティブ

## 何を実装したか

PIDファイル（`bot.pid`）による重複起動検知と、シャットダウン時の子プロセスクリーンアップを実装した。

主な機能:
- PIDファイルの排他作成（`O_EXCL`）による重複起動検知
- プラットフォーム分岐によるプロセス生存確認（Windows: `tasklist` / Unix: `os.kill`）
- シャットダウン時の子プロセスクリーンアップ（Windows: `wmic`+`taskkill` / Unix: `pgrep`+`SIGTERM`）

関連PR: #137（リバート済み）, #139（リバート）, #140（再実装）

## うまくいったこと

- **再実装方針の明確化**: PR #137 のリバート後、Issue #136 のコメントに再実装方針を詳細に記載してから着手したことで、スコープの絞り込み（自動killしない、スクリプト不要）が明確になった
- **手動検証スクリプト**: 3パターン（生存プロセス / stale PID / PIDファイルなし）の検証をスクリプト化し、Windows環境での実動作を確認できた
- **仕様書の先行作成**: 仕様書を先に書いてから実装した流れは機能し、ACベースのテストで品質を担保できた

## 改善点・ハマったこと

### 1. Windows環境での `os.kill(pid, 0)` 問題（PR #137）

**問題**: 初回実装（PR #137）で `os.kill(pid, 0)` をプロセス生存確認に使用したが、Windowsでは `SystemError` が発生して動作しなかった。

**原因**: Windows の `os.kill` は Unix とセマンティクスが異なる。signal 0 はプロセス存在確認としてWindowsでは機能しない。

**対応**: PR #137 をリバート（PR #139）し、Windows向けに `tasklist /FI "PID eq {pid}" /NH` を使うプラットフォーム分岐で再実装（PR #140）。

**教訓**: プロセス管理系のAPIはOS間の差異が大きい。`os.kill` のようなPOSIX由来のAPIは、Windowsでの振る舞いを必ずドキュメントで確認する。

### 2. Copilotレビューで6件の指摘（PR #140）

**問題**: PR作成後のCopilotレビューで以下の問題が指摘された:
- テスト名とテスト内容の不一致（`pgrep` vs `wmic`）
- docstring の typo（`taslist`）
- `except ... pass` のサイレントエラー
- PID <= 0 のバリデーション漏れ（`os.kill(0, 0)` は自プロセスグループへのシグナルチェックになる）
- TOCTOU 競合状態の未考慮（`check` → `write` の間に別プロセスが割り込む可能性）
- `try/finally` スコープ不足（初期化失敗時にPIDファイルが残る）

**原因**: コミット前のセルフレビューが不十分。コードを書いた直後にそのままコミットしていた。

**対応**: 全6件を修正。特に TOCTOU 対策として `O_CREAT | O_EXCL` による排他作成に変更。`try/finally` スコープを `write_pid_file()` 直後から全体を包む構造に変更。

**教訓**:
- コミット前にdiffを読み直すセルフレビュー工程が必要
- プロセス管理コードでは競合状態（TOCTOU）を常に意識する
- `except ... pass` は原則禁止。最低でも `logger.debug()` を入れる

### 3. レトロスペクティブの作成忘れ

**問題**: PR作成・レビュー対応まで完了したが、CLAUDE.mdで必須とされているレトロスペクティブの作成を忘れていた。ユーザーに指摘されて初めて気づいた。

**原因**: 実装→テスト→PR→レビュー対応の流れに集中し、最後のドキュメント作成ステップを見落とした。

**教訓**: CLAUDE.mdの「実装完了時の必須手順」を最後まで確実に実行する。特にレトロは手順の最後にあるため見落としやすい。

## 次に活かすこと

1. **コミット前セルフレビュー**: diffを読み直し、テスト名・docstring・エラーハンドリングの妥当性を確認する。コードレビュワーエージェント（Issue #141）の導入で自動化を検討
2. **プラットフォーム差異の事前調査**: OS依存のAPI（プロセス管理、ファイルシステム等）はWindowsとUnixの振る舞いの差をドキュメントで確認してから実装する
3. **競合状態の考慮**: ファイルベースのロック・PID管理ではTOCTOUを常に意識し、アトミックな操作（`O_EXCL`等）を使う
4. **実装完了チェックリストの遵守**: PR作成後にCLAUDE.mdの必須手順（特にレトロ作成）を最後まで確実に実行する
5. **サイレントエラーの禁止**: `except ... pass` は使わない。最低でもログ出力を入れる
