# doc-reviewerサブエージェント最適化 — レトロスペクティブ

## 何を実装したか

doc-reviewerサブエージェントのレビュー時間・粒度を最適化するため、差分レビューモードと許容パターン機能を追加した。

主な機能:

- **差分レビューモード（diff）**: 変更箇所のみをレビュー（目標30秒以下）
- **フルレビューモード（full）**: 従来通りファイル全体をレビュー（目標60秒以下、デフォルト）
- **許容パターン**: プロジェクト方針として許容される項目を指摘対象外に
- **CLAUDE.mdのスキップ基準**: 誤字脱字のみはスキップ可、レビュー指摘対応時は差分レビュー推奨

関連PR: #148

## うまくいったこと

- **事前設計の活用**: Issue #144 のコメントでClaude（GitHub Actions経由）が設計書を作成し、その設計を元に実装を進められた。設計と実装のフェーズが分離されていたことで、実装がスムーズに進んだ
- **既存ファイルの拡張**: 新規specファイルを作成せず、既存の `docs/specs/doc-review-agent.md` を拡張する形で対応。ユーザーの指示「specを作成する必要はない」を適切に反映できた
- **整合性の確保**: code-reviewerサブエージェントが `model: sonnet` の不整合を指摘し、仕様書のメタデータ例と使用LLMプロバイダーセクションを実態（modelフィールド省略）に合わせて修正できた

## 改善点・ハマったこと

### 1. 設計書の重複作成

**問題**: GitHub Actions のClaudeが `docs/specs/doc-reviewer-optimization.md` という新規specファイルを作成していたが、ユーザーは既存の `doc-review-agent.md` を更新する形を望んでいた。

**原因**: GitHub Actions のClaudeはプロジェクトの文脈（「エージェント定義がspecと同義」）を十分に把握していなかった。

**対応**: ユーザーの明示的な指示に従い、設計書の内容は採用しつつ、ファイルは既存の `docs/specs/doc-review-agent.md` を更新する形で実装した。

**教訓**: 設計フェーズと実装フェーズが分かれる場合、設計者（GitHub Actions Claude）と実装者（Claude Code）の間で「どのファイルを変更するか」の認識合わせが重要。

### 2. .gitignore による .claude/agents のステージング問題

**問題**: `git add .claude/agents/doc-reviewer.md` でエラーが発生。`.claude/` がgitignoreされていた。

**原因**: `.gitignore` に `.claude/` が含まれており、`!.claude/agents/` の除外ルールが正しく機能していなかった（または git のキャッシュ問題）。

**対応**: `git add -f` オプションで強制的にステージング。

**教訓**: `.gitignore` の除外ルール（`!` パターン）は、親ディレクトリが無視されている場合に期待通り動作しないことがある。既にトラッキングされているファイルなら問題ないが、新規追加時は注意が必要。

### 3. 差分レビューで未ステージ変更を検出できない問題

**問題**: 差分レビューモードで、編集直後（未ステージ・未コミット）のファイルをレビューしても「変更なし」と判定されたり、前回コミットの差分を拾ってしまうことがあった。

**原因**: 差分取得の優先順位が以下の順序だった:

1. ベースブランチとの比較（`git diff $(merge-base) HEAD`）
2. ステージング済み（`git diff --cached`）
3. 直近コミット（`git show HEAD`）

**問題点**: 「作業ツリーの変更（`git diff`）」が含まれていなかったため、未ステージの変更を検出できなかった。

**対応**: 差分取得の最優先に「作業ツリーの変更（未ステージ）: `git diff -- <file>`」を追加。

**教訓**: サブエージェントの差分取得ロジックを設計する際は、以下の全状態を考慮する必要がある:

- 未ステージ（編集中）: `git diff`
- ステージング済み: `git diff --cached`
- コミット済み（ベースブランチ比較）: `git diff $(merge-base) HEAD`
- フォールバック（直近コミット）: `git show HEAD`

test-runnerは正しく設計されていたが、doc-reviewerには漏れがあった。

## 次に活かすこと

1. **設計と実装の引き継ぎ**: GitHub Actions Claude による設計を Claude Code で実装する場合、「どのファイルを変更するか」を事前に明確化する
2. **レビューモードの効果測定**: 今後、差分レビューモードの実際の効果（時間短縮、指摘の質）を測定し、目標値（30秒以下）を達成しているか検証する
3. **許容パターンの拡充**: 実運用で「プロジェクト方針として許容されるべきだが指摘されている」項目があれば、許容パターンに追加していく
