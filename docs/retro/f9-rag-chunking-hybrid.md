# F9: RAGチャンキング改善・ハイブリッド検索 — レトロスペクティブ

## 概要

RAG検索精度向上のため、コンテンツタイプ別チャンキング（テーブル・見出し・散文）とBM25キーワード検索を追加し、ベクトル検索と組み合わせたハイブリッド検索の基盤コンポーネントを実装した。

## 実装範囲

| Issue/PR | タイトル | 状態 |
|----------|---------|------|
| #195 | チャンキング改善・ハイブリッド検索 | 基盤実装完了 |
| #211 | feat(f9): RAGチャンキング改善とハイブリッド検索の実装 | マージ済み |
| #216 | ハイブリッド検索のRAGKnowledgeService統合 | **完了（PR #217）** |

PR #211 で基盤コンポーネントを実装し、PR #217 で `RAGKnowledgeService` への統合を完了。

## 主なコンポーネント

```
src/rag/
├── content_detector.py    — コンテンツタイプ検出（テーブル/見出し/散文）
├── table_chunker.py       — テーブル行分割（ヘッダー保持）
├── heading_chunker.py     — 見出しベースチャンキング
├── bm25_index.py          — BM25キーワードインデックス（fugashi日本語トークナイザー）
└── hybrid_search.py       — RRFベースハイブリッド検索
```

**依存パッケージ追加**:

- `rank-bm25>=0.2,<1` — BM25アルゴリズム
- `fugashi>=1.3,<2` — 日本語形態素解析
- `unidic-lite>=1.0,<2` — 辞書データ

## うまくいったこと

### 1. エージェントチームによる並行開発

エージェントチームを編成し、レビュー対応を分担。Copilotレビュー指摘に効率的に対応できた。

### 2. モジュラー設計

各コンポーネントを独立してテスト可能な形で実装：

| コンポーネント | テスト数 | 特徴 |
|---------------|---------|------|
| ContentTypeDetector | 6 | 境界値テストを含む |
| TableChunker | 4 | ヘッダー保持確認 |
| HeadingChunker | 4 | 見出し階層処理 |
| BM25Index | 7 | 日本語トークン化 |
| HybridSearch | 5 | RRFスコア計算 |

### 3. セキュリティ脆弱性の早期発見と修正

運用テスト中にユーザーがMcAfeeのブロック警告で異常を発見し、即座に修正対応できた。

## 改善点・ハマったこと

### 1. 外部ドメインクローリングのセキュリティ脆弱性（Critical）

**問題**: `crawl_index_page()` がインデックスページ内の全リンクを抽出しており、外部ドメイン（`cheatcodes.web.fc2.com` 等）へのアクセスが発生した。

**発見経緯**: ユーザーの運用テスト中にMcAfeeが外部サイトへのアクセスをブロックし、警告画面を表示。

**根本原因分析**:

ユーザーは Issue #195 の**コメント**で以下のように明言していた：

> 検証のために何度も外部サイトを取り込むのは問題があるので、
> 色んなパターンを評価できるページを作ってテストケースとする

しかし、この要件が仕様書の受け入れ条件（AC）に反映されなかった：

| AC | 書かれていた内容 | 本来書くべきだった内容 |
|----|----------------|---------------------|
| AC12 | URLリストを抽出できること | **同一ドメインの** URLリストを抽出できること |

**なぜ見落としたか**: 要件がIssue本文ではなく**コメント**に書かれていたため、設計・実装時に参照されなかった。

**対応**:

```python
# インデックスページのホスト名を取得
index_hostname = urlparse(validated_url).hostname or ""

# 同一ドメインチェック
link_hostname = urlparse(normalized_url).hostname or ""
if link_hostname != index_hostname:
    logger.debug("Skipping external domain link: %s", link_hostname)
    continue
```

**教訓**:

- **クローラーの外部リンク処理は最初から制限すべき** — SSRF対策（IPアドレス検証）とは別に、ドメイン制限も必要
- **リンク抽出と検証の順序を明確にする** — DNS解決（コスト高）の前にドメインチェック（コスト低）を実施

### 2. BM25テストの失敗

**問題**: `test_update_existing_document` が失敗。日本語キーワード（ゾーマ/りゅうおう）で検索しても結果が返らない。

**原因分析**:

1. fugashiのトークン化でカタカナ語が期待通りに分割されない
2. 英語キーワードに変更しても失敗が続く
3. **根本原因**: BM25の IDF計算式 `log((N-n+0.5)/(n+0.5))` で、N=2, n=1 の場合に IDF=0 となり、スコアが0になる

**対応**: テストのドキュメント数を2から3に変更（N=3, n=1 → IDF > 0）

**教訓**:

- **BM25は少数ドキュメントでの評価に不向き** — IDF計算の特性上、テストには十分なドキュメント数が必要
- **数式の特性を理解してテストデータを設計する**

### 3. mypy の型チェック設定

**問題**: `fugashi` と `rank_bm25` が型スタブを提供しておらず、mypy strict モードでエラー。

**試行錯誤**:

1. `ignore_missing_imports = true` → 効果なし
2. `follow_untyped_imports = "silent"` → mypyバージョンがサポートしていない

**最終的な対応**:

```toml
[tool.mypy]
untyped_calls_exclude = ["fugashi", "rank_bm25"]

[[tool.mypy.overrides]]
module = ["fugashi", "fugashi.*", "rank_bm25", "rank_bm25.*"]
ignore_missing_imports = true
follow_imports = "skip"
```

**教訓**:

- **型スタブのないパッケージは事前に確認する** — ML/NLP系ライブラリは型サポートが弱いことが多い
- **mypy overrides の設定は複数オプションの組み合わせが必要なことがある**

### 4. 基盤コンポーネントのみで統合未完了

**問題**: PR #211 は各コンポーネントの実装のみであり、`RAGKnowledgeService` への統合がなされていない。そのため、マージしても検索精度の改善は発生しない。

**対応**: Issue #216 を作成し、統合作業を別途追跡。仕様書に「基盤実装のみ」である旨を明記。

**教訓**:

- **部分実装の場合は仕様書とIssueで明確に範囲を記載する**
- **統合なしでは価値が発揮されないことをステークホルダーに伝える**

### 5. Copilotレビュー指摘の多発（計41件）

**問題**: PR #211 に対するCopilotレビューで、3回にわたり計41件の指摘を受けた。

| ラウンド | 指摘件数 | 主な内容 |
|---------|---------|---------|
| 第1回 | 21件 | 未使用import、仕様書と実装の不一致、実装バグ |
| 第2回 | 9件 | テスト名規約違反、line-length超過、正規表現問題 |
| 第3回 | 11件 | テスト名規約違反（追加分）、RRF計算の一貫性 |

**根本原因**:

1. **テスト名を最初からAC番号形式で書かなかった** — CLAUDE.mdに規約があるにもかかわらず守られなかった
2. **実装後に仕様書を更新しなかった** — 閾値やシグネチャの乖離が放置された
3. **コミット前にlint/markdownlintを実行しなかった** — 最後にまとめてエラー発覚
4. **最終チェック担当がいなかった** — 実装者がセルフチェックするだけでは見落としが多い

**対応**: エージェントチームに「最終チェック担当」を追加し、実装完了後にruff/mypy/pytest/markdownlintを実行する体制を構築。

**教訓**:

- **テスト名は最初からAC番号形式（`test_ac{N}_...`）で書く**
- **実装したら即座に仕様書も更新する**（後回しにしない）
- **コミット前にlint/mypy/markdownlintを毎回実行する**
- **チームに最終チェック担当を置く**（実装者とは別の目でチェック）

## Issue #216 統合作業の記録（PR #217）

### 実装内容

| コンポーネント | 変更内容 |
|---------------|---------|
| `RAGKnowledgeService.__init__` | `bm25_index`, `hybrid_search_enabled` パラメータ追加、`HybridSearchEngine` インスタンス化 |
| `_smart_chunk()` | コンテンツタイプに応じたチャンキング（TABLE/HEADING/MIXED/PROSE） |
| `_ingest_crawled_page()` | BM25インデックスへの連携追加 |
| `retrieve()` | ハイブリッド検索分岐（`_retrieve_hybrid` / `_retrieve_vector_only`） |
| `delete_source()` | BM25インデックスからの削除連携 |
| `main.py` | `rag_hybrid_search_enabled` 設定に応じたBM25Index作成・注入 |

### テスト追加

`tests/test_rag_knowledge_hybrid.py` に13件のテストを追加:

- `TestHybridSearchDisabled` — AC9: `hybrid_enabled=false` 時の従来動作
- `TestHybridSearchEnabled` — ハイブリッド検索有効時の動作
- `TestBM25IndexIntegration` — BM25連携（ingest/delete）
- `TestTableDataSearch` — AC12: テーブル内データ検索
- `TestKeywordExactMatch` — AC13: キーワード完全一致
- `TestSmartChunking` — `_smart_chunk()` メソッド
- `TestHybridSearchEngineInitialization` — 初期化確認

### 統合作業でうまくいったこと

1. **エージェントチームによる並行作業**
   - 実装担当（メルリン）と品質担当（セージ）で役割分担
   - 実装完了後すぐにテスト作成・品質検証に移行できた

2. **設計案の事前準備**
   - Issue #216 のコメントに詳細な設計案があり、実装がスムーズに進んだ
   - アーキテクチャ図、コード例、実装ステップが明確だった

3. **既存テストパターンの活用**
   - `tests/test_rag_knowledge.py` のパターンを踏襲
   - テスト設計が効率的に進んだ

### 統合作業での改善点

1. **既存テストのログメッセージ変更対応**
   - `retrieve()` のログメッセージ形式変更により既存テストが1件失敗
   - ログメッセージをテストでアサートする場合、変更時の影響を考慮する必要がある

## 次に活かすこと

1. **Issue のコメントも仕様に反映する** — Issue本文だけでなく、コメントで追加された要件・制約も見落とさない。今回の脆弱性は「外部サイトを取り込むのは問題」というコメントが仕様書のACに反映されなかったことが原因。

2. **クローラーの外部リンク制限は最初から実装する** — SSRF対策（IP検証）とドメイン制限は別レイヤー。両方必要。

3. **テストデータは数式の特性を考慮して設計する** — BM25のIDF計算のように、少数データで評価できないアルゴリズムがある。

4. **型スタブのないパッケージは導入前に確認する** — mypy strict で問題になる。overrides設定の準備が必要。

5. **部分実装は範囲を明示する** — 「基盤のみ」「統合は別Issue」をドキュメントとIssueに明記し、期待値を合わせる。

6. **セキュリティ関連の問題は即座に対応する** — 今回は発見から数時間以内に修正完了。外部ドメインへの意図しないアクセスは深刻なリスク。

7. **テスト名は最初からAC番号形式で書く** — 後から修正すると大量の手戻りが発生する。CLAUDE.mdの規約を実装開始時に確認する。

8. **実装と仕様書は同時に更新する** — 実装後に仕様書を更新しないと乖離が蓄積する。閾値やシグネチャが変わったら即座に仕様書も修正。

9. **コミット前チェックを習慣化する** — ruff/mypy/markdownlintをコミット前に毎回実行。CIで落ちてから直すのは非効率。

10. **チームに最終チェック担当を置く** — 実装者のセルフチェックだけでは見落としが多い。別の目でチェックする体制が有効。

## 参考

- 仕様書: [docs/specs/f9-rag-chunking-hybrid.md](../specs/f9-rag-chunking-hybrid.md)
- 関連レトロ: [f9-rag-knowledge.md](./f9-rag-knowledge.md)（RAG機能全体）
- 基盤実装PR: [#211](https://github.com/becky3/ai-assistant/pull/211)
- 統合Issue/PR: [#216](https://github.com/becky3/ai-assistant/issues/216) → [#217](https://github.com/becky3/ai-assistant/pull/217)
