# PR Review Toolkit 導入のレトロスペクティブ

## 概要

Anthropic 公式の PR Review Toolkit プラグインを導入し、PR 作成時の自動レビュー機能を実装した。

## 関連Issue/PR

- Issue #130: PR Review Toolkit 導入検討
- PR #223: PR Review Toolkit 導入

---

## 2026-02-11: 導入作業

### 何を実装したか

**Phase 1: プラグイン導入**

- 6つの専門レビューエージェント（`prt-*` プレフィックス）を追加
  - `prt-code-reviewer`: CLAUDE.md 準拠・バグ検出（信頼度スコア付き）
  - `prt-test-analyzer`: テストカバレッジ品質分析
  - `prt-silent-failure-hunter`: サイレント障害検出
  - `prt-type-design-analyzer`: 型設計・不変条件評価
  - `prt-comment-analyzer`: コメント正確性分析
  - `prt-code-simplifier`: コード簡素化
- `/review-pr` 統合コマンドを追加
- CLAUDE.md に使用方法を追記

**Phase 2: GitHub Actions 自動レビュー**

- `pull_request` トリガー（`types: [opened]`）を追加
- `pr-review` ジョブを新設
  - `claude-sonnet-4-5` モデルを使用（コスト効率）
  - PR Review Toolkit エージェントを活用するプロンプト設計
- 既存の `@claude` メンションとの共存（イベント種別で分岐）

### うまくいったこと

1. **Anthropic 公式プラグインの調査が効率的だった**
   - GitHub リポジトリから直接プラグイン構造を調査
   - 各エージェントの仕様を正確に把握

2. **既存サブエージェントとの役割分担を明確化**
   - `prt-` プレフィックスで命名の衝突を回避
   - 既存の `code-reviewer` / `doc-reviewer` との使い分けを CLAUDE.md に記載

3. **GitHub Actions の共存設計**
   - `github.event_name` でイベントを分岐
   - 既存の `@claude` メンションワークフローを維持しつつ新機能を追加

4. **段階的な導入設計**
   - Issue #130 のコメントで事前に Phase 1/2 の設計を議論済み
   - 設計に従った実装でスムーズに進行

### 改善点

1. **markdownlint エラーが32件発生**
   - 新規作成したエージェント定義ファイルにエラーが多数あった
   - 品質レビューフェーズで検出・修正

2. **`.gitignore` で `.claude` が無視されていた**
   - `git add -f` で強制追加が必要だった
   - 今後の Claude Code 関連ファイル追加時は注意が必要

### 技術的な判断

1. **モデル選択: `claude-sonnet-4-5-20250929` を使用**
   - 自動レビューはコスト効率を重視
   - `@claude` メンションによる実装支援は引き続き `claude-opus-4-5` を使用

2. **Slack 通知: 自動レビューは失敗時のみ**
   - 成功時の通知は冗長と判断
   - 既存の `@claude` ジョブは引き続き `always()` で通知

3. **セキュリティガード: `becky3` ユーザーのみ**
   - 既存の `@claude` ジョブと同様の制限を適用

---

## 次に活かすこと

### PR Review Toolkit の活用

- **`/review-pr` コマンド**: PR 作成前に包括的なレビューを実行できる
- **信頼度スコア**: `prt-code-reviewer` は 80 以上の問題のみ報告し、ノイズを削減
- **専門エージェント**: 型設計やサイレント障害など、汎用レビューでは見落としやすい問題を検出

### GitHub Actions 設計

- **イベント分岐**: `github.event_name` で複数のワークフローを共存させる
- **モデル使い分け**: 自動処理には `sonnet`、対話的作業には `opus` を使用してコスト最適化
- **fetch-depth: 0**: 正確な差分取得のため履歴全体を取得

### プラグイン導入時の注意

- **`.gitignore` の確認**: `.claude` ディレクトリが無視されている場合は `git add -f` が必要
- **命名規則**: 既存の定義との衝突を避けるためプレフィックスを付ける
- **markdownlint**: 新規 Markdown ファイルは作成後に必ず lint を実行

---

## 2026-02-11: コード行コメント対応（Issue #229, PR #231）

### 何を実装したか

PR Review Toolkit の指摘を check-pr スキルで検出可能にするため、レビュー結果をコード行コメント（reviewThreads）として投稿するよう修正した。

**主な変更点**:

1. **コード行コメント投稿機能**
   - `gh api repos/.../pulls/.../comments` でコード行にコメント投稿
   - check-pr スキルの GraphQL クエリで検出可能に

2. **エラーハンドリング強化**
   - `set -euo pipefail` をシェルスクリプトに追加
   - 変数の空チェックとエラー終了

3. **トリガー条件改善**
   - `/re-review` → `/review` に短縮
   - `contains` → `startsWith` で誤発動防止

### うまくいったこと

1. **reviewThreads として正しく認識された**
   - REST API `/pulls/{number}/comments` で投稿したコメントが GraphQL の reviewThreads で取得可能なことを確認
   - check-pr スキルとの整合性が保たれた

2. **PR Review Toolkit 自身がレビュー指摘**
   - 今回の変更に対して PR Review Toolkit が自動レビューを実行
   - コード行コメントとして投稿され、実際の動作を確認できた

3. **エージェントチームでの効率的な作業**
   - 虎杖（実装）、伏黒（品質チェック）、釘崎（ストーリーテラー）の分担で並行作業
   - 8回のコミットを1時間以内で完了

### 改善点・ハマったこと

1. **GitHub Actions に `trim` 関数は存在しない**
   - `trim(github.event.comment.body)` でワークフローエラー
   - 調査の結果、`startsWith` で代替

2. **PRコメント内の `/re-review` 文字列で誤発動**
   - `contains` を使っていたため、レビュー対応コメント内の `/re-review` で再実行がトリガーされた
   - `startsWith` に変更して解決

3. **diff 範囲外の指摘**
   - 変更していないコードへの指摘は対応が困難
   - プロンプトに「diff 範囲内のみレビュー対象」を明記

4. **プレースホルダーの不明瞭さ**
   - `行番号` を `<行番号>` に変更して置換が必要であることを明示

### 技術的な判断

1. **REST API vs GraphQL**
   - コメント投稿は REST API（`gh api`）を使用
   - 読み取りは GraphQL（check-pr スキル）
   - 両方で reviewThreads として扱われることを確認

2. **スラッシュコマンドのトリガー**
   - 外部アクション（slash-command-dispatch 等）は依存関係が増えるため見送り
   - `startsWith` で十分な精度が得られると判断

3. **エラーハンドリングの粒度**
   - シェルスクリプトには `set -euo pipefail` + 空チェック
   - プロンプト内の gh api 失敗はサマリーに記載するよう指示（Claude の判断に委ねる）

---

## 次に活かすこと

### GitHub Actions 式の制限

- **`trim` 関数は存在しない**: `startsWith`、`endsWith`、`contains` 等で代替
- **スラッシュコマンドには `startsWith`**: 文中の誤発動を防ぎつつ、先頭一致で十分な精度
- **外部アクション導入前に調査**: 標準機能で対応可能か確認

### PR Review Toolkit の運用

- **diff 範囲内のみレビュー**: 対応可能な指摘に集中させる
- **プレースホルダーは `<>` で囲む**: Claude が置換すべき部分を明確に
- **エラーハンドリングはプロンプトで指示**: シェルの厳格モード + プロンプトでの対応指示

### シェルスクリプトのベストプラクティス

- **`set -euo pipefail`**: エラー時即座に終了、未定義変数でエラー、パイプラインエラー伝播
- **空チェック**: 変数が空の場合は明示的にエラー終了
- **stderr への出力**: エラーメッセージは `>&2` で標準エラー出力へ

---

## 2026-02-11: エラーハンドリング強化（Issue #233, PR #234）

### 何を実装したか

PR #231 のレビューで検出されたエラーハンドリングの問題を修正した。

**主な変更点**:

1. **`|| { ... }` パターンでエラー捕捉**
   - `if ! VAR=$(cmd)` パターンから `OUTPUT=$(cmd) || { ... }` パターンに変更
   - 終了コード（`EXIT_CODE=$?`）を明示的に保存
   - エラー情報の損失を防止

2. **ステップ順序の最適化**
   - `Get PR number` を先頭に移動
   - 不正なPR番号の場合は `gh pr view` 呼び出し前に早期失敗

3. **正規表現の改善**
   - `^[0-9]+$` → `^[1-9][0-9]*$` に変更
   - PR番号 0 を無効として除外

### うまくいったこと

1. **PR Review Toolkit が自身の問題を検出**
   - Issue #229 で実装したコード行コメント機能が正常に動作
   - 9件の指摘がコード行コメントとして投稿された
   - check-pr スキルで検出可能であることを実証

2. **段階的なレビュー対応**
   - 最初のレビューで2件（`set +e` 明示、正規表現修正）を対応
   - 追加レビューで4件（エラー情報保持、ステップ順序等）を対応
   - 各対応後にコメントで状況を報告

### 改善点・ハマったこと

1. **`set +e` vs `|| { ... }` の選択**
   - 最初は `set +e` で全体の `-e` を無効化
   - レビュー指摘により `|| { ... }` で局所化する方が安全と判断

2. **`if ! VAR=$(cmd)` パターンの問題**
   - 失敗時に変数にエラー出力が入るが、直後に上書きされる可能性
   - `OUTPUT=$(cmd) || { EXIT_CODE=$?; ... }` パターンで解決

### 技術的な判断

1. **エラーハンドリングパターンの選択**
   - `set -euo pipefail` をベースに維持
   - 個別のコマンドは `|| { ... }` で捕捉
   - `echo ... >> $GITHUB_OUTPUT` は `set -e` で自動停止

2. **早期バリデーションの実装**
   - 入力値（PR番号）の**型バリデーション**（正の整数）は最初に実行
   - 存在確認は `gh pr view` 実行時に暗黙的に行われる
   - 後続ステップは型検証済みの値を使用

### 次に活かすこと

#### シェルスクリプトのエラーハンドリング

- **`|| { ... }` パターン**: `set -e` と共存しつつ、特定コマンドのエラーを詳細に処理
- **終了コードの保存**: `EXIT_CODE=$?` でエラーコードを保存してからログ出力
- **早期バリデーション**: 入力値の検証は処理の最初に実行し、後続ステップの前提条件を確立

#### PR Review Toolkit の自己検証

- **自動レビューが自身のコードを検証**: 新機能の動作確認として有効
- **コード行コメント**: reviewThreads として投稿され、check-pr スキルで検出可能
