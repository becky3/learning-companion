# 自動進行管理（auto-progress） — レトロスペクティブ

## 概要

Issue #253「リポジトリ自動進行管理」の議論を通じて、IssueからPRマージまでの全工程を自動化する仕様書（`docs/specs/auto-progress.md`）を策定した。

- Issue: #253

## 実装の概要

- エージェントチーム（ONE PIECE テーマ）で多角的に議論
  - ナミ（ユーザー・運用視点）: コスト意識、運用負荷、事後拒否権モデルの提案
  - フランキー（技術・アーキテクチャ視点）: ワークフロー設計、git-flow 評価、安全弁設計
  - ニコ・ロビン（ストーリーテラー）: 議論の俯瞰、見落とし指摘
- 仕様書に記載した主要な設計判断:
  - `auto-implement` ラベルによるトリガー方式
  - auto-fix.yml によるレビュー→修正→再レビューの自動ループ
  - 簡易 git-flow（develop + main）の採用
  - 事後拒否権モデル（仕様書の事前承認不要）
  - 11層の安全弁設計
  - 自動マージレビューIssue方式（`auto:review-batch`）
  - GitHub 通知への統一（カスタム Slack 通知は不採用）

## うまくいったこと

### 1. チームでの多角的議論

ユーザー・運用視点（ナミ）と技術視点（フランキー）の役割分担により、単一視点では見落としがちな論点を洗い出せた。特に以下が議論で改善された:

- 事後拒否権モデル: 承認ステップがボトルネックになる問題をナミが指摘し、「デフォルトは進む、止めたい時だけ止める」方式に
- git-flow 採用: develop ブランチをサンドボックスにすることで自動マージのリスクを軽減
- コスト見積もり: Phase 1/Phase 2 の段階的なコスト試算

### 2. ユーザーの随時フィードバックによる仕様改善

ユーザーが議論中に随時フィードバックを入れることで、方向性のズレを早期に修正できた。具体例:

- 「Slack通知は不要、GitHub通知で十分」→ カスタム Slack 通知を全削除
- 「Slackチェックリストより集約Issue方式が良い」→ 自動マージレビューIssue方式に変更
- 「機械可読フラグでレビュー結果をパースすべき」→ `<!-- auto-fix:no-issues -->` HTML コメント方式に

### 3. 段階的ロードマップ

Phase 0（最小構成）→ Phase 1（自動ループ）→ Phase 2（フルサイクル）の段階設計により、リスクを抑えつつ導入できる計画になった。

## ハマったこと・改善点

### 1. メンバーのコンテキスト切れによるファイル編集の遅延

**問題**: 長時間の議論でコンテキストウィンドウが圧迫され、ファイル編集タスクの着手が遅れた。分析メッセージの送信と実際のファイル編集が分離し、「分析は送ったがファイルはまだ」という状態が発生した。

**教訓**: ファイル編集タスクは、分析フェーズと分離せず「Read → 分析 → Edit」を一連の流れで実行させるべき。プロンプトに「分析メッセージを送る前にファイルを編集せよ」と明示する。

### 2. 分析メッセージの送り直しループ

**問題**: メッセージ配信のタイミングにより、リーダーに分析結果が届かず、同じ分析を複数回送り直すループが発生した。コンテキストを大量に消費する原因になった。

**教訓**: メンバーへの指示は「メッセージで分析を送れ」ではなく「ファイルを直接編集せよ」にすべき。ファイル編集は成果物として残るため、メッセージ配信の問題に影響されない。

### 3. 複数メンバーによる同一ファイル編集の競合

**問題**: フランキー（技術担当）とライター（記述担当）が同じ仕様書を編集し、セクション内容やAC番号に不整合が発生した（AC5.1/5.2 と AC24-28 の重複など）。

**教訓**: 同一ファイルの編集は1名に集約する。複数メンバーが関わる場合は、セクション単位で明確に分担を決める。

## 次に活かすこと

1. **ファイル編集タスクは「Read → Edit → 完了報告」を一連の流れで実行させる**: 分析メッセージの送信とファイル編集を分離しない。プロンプトに「メッセージでの分析は不要、ファイルを直接編集せよ」と明示する

2. **同一ファイルの編集担当は1名に限定する**: 複数メンバーが同じファイルを編集すると不整合が発生する。担当者を明確にし、他メンバーは意見をメッセージで送る

3. **議論フェーズと記述フェーズを分ける**: 議論中にファイル編集を並行すると混乱する。議論で方針を固めてから、記述担当がまとめて反映する方が効率的

4. **ユーザーの随時フィードバックは仕様品質を大幅に向上させる**: 議論の途中でもユーザーが方向修正できる仕組み（チーム議論へのリアルタイム参加）は効果的

5. **カスタム通知より既存の通知インフラを活用する**: GitHub 通知 → Slack 連携など、ユーザーが既に構築済みの通知パイプラインを尊重し、ワークフロー内でのカスタム通知は避ける

## 参考

- 仕様書: [docs/specs/auto-progress.md](../specs/auto-progress.md)
- 関連Issue: #253
