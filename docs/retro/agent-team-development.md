# エージェントチーム開発 — レトロスペクティブ

## 概要

Claude Codeのエージェントチーム機能を活用した開発手法の知見をまとめる。

## 初回適用: Issue #169 エンコーディング問題の修正（PR #172）

### 背景

RAG検索結果がチャット回答に反映されない問題（#169）を調査・修正した。

**根本原因**: Shift_JISエンコーディングのWebページがUTF-8として誤デコードされ、日本語テキストが文字化け状態でChromaDBに保存されていた。

### チーム構成

| 役割 | 担当タスク |
|------|-----------|
| リーダー | 統括・方針決定・PR作成 |
| 実装担当 | `web_crawler.py`のエンコーディング検出実装 |
| テスト担当 | テストコード作成（5件） |
| 依存関係担当 | `pyproject.toml`への依存追加 |

### 結果

- **Copilotレビュー指摘: ゼロ**（従来のPRでは毎回指摘があった）
- 全テスト通過（404 passed）
- ruff / mypy / markdownlint 違反なし

## うまくいったこと

### 1. 役割分離による専門性

- 各エージェントが専門タスクに集中
- 実装者とテスト作成者が別なので、第三者視点でテストが書かれた
- 「自分の実装をテストする」バイアスが排除された

### 2. タスク依存関係の制御

```mermaid
graph LR
    A[タスク#1: 実装] --> B[タスク#2: テスト作成]
    C[タスク#3: 依存関係] --> B
```

- テストタスクが実装タスクにブロックされる設定
- 実装完了後にテスト作成という流れが保証された
- 並行作業可能なタスク（実装と依存関係追加）は同時進行

### 3. 複数視点によるカバレッジ向上

- 単独作業では見落としがちなポイントが事前にカバーされた
- リーダーが方針を明示することで、実装のブレがなく一貫性のあるコードに

### 4. 最終品質ゲート

- test-runnerで全チェック（pytest/mypy/ruff/markdownlint）を通してからコミット
- チーム作業完了後に品質確認という流れが自然に組み込まれた

## 改善点・ハマったこと

### 1. レビュープロセスの抜け漏れ

**問題**: チーム解散後、レトロ作成時にdoc-reviewerを呼び忘れた。

**原因**: チーム開発では複数視点が入るが、チーム解散後の単独作業では従来通りの見落としが発生。

**対応**: ユーザーからの指摘で気づき、doc-reviewerを実行。

**教訓**: チーム開発でもCLAUDE.mdの手順（特にレビュー工程）は遵守が必要。

### 2. 初回適用のため手探り

**問題**: エージェントチーム機能の初回適用で、最適なタスク分割や依存関係設定が手探りだった。

**対応**: `docs/specs/agent-teams.md` を参照しながら実施。

**教訓**: 新機能適用前に仕様書を熟読することが重要。

## 単独作業との比較

```mermaid
graph LR
    subgraph 単独作業
        S1[実装] --> S2[テスト] --> S3[見落とし] --> S4[Copilot指摘]
    end
```

```mermaid
graph LR
    subgraph チーム作業
        T1[実装 A] --> T4[テスト B]
        T2[依存関係 C] --> T4
        T4 --> T5[test-runner] --> T6[Copilot指摘なし]
    end
```

## チーム開発が有効なケース

| シナリオ | 推奨 | 理由 |
|----------|------|------|
| 単純なテスト実行 | サブエージェント | 結果報告のみ |
| 単一ファイルのレビュー | サブエージェント | 焦点を絞ったタスク |
| 複数ファイルにまたがる機能実装 | **チーム** | 並行作業、相互調整が必要 |
| 調査 + 実装 + テストが必要な修正 | **チーム** | 役割分離の効果大 |

## 次に活かすこと

1. **複数ファイルにまたがる機能実装では、積極的にエージェントチームを検討する**

2. **リーダー役が実装方針を事前にチームメンバーに共有する** — ヘルパーメソッド名、処理フローなど

3. **依存関係のないタスクは並列実行を設定し、時間短縮を図る**

4. **実装者とテスト作成者を分けることで、第三者視点のテストを確保する**

5. **チーム解散後もCLAUDE.mdの手順（レビュー工程）は遵守する**

## キャラクター演出ガイドライン追加: Issue #190 / PR #193

### 背景

エージェントチームでキャラクターテーマを使用した際、キャラクターらしさの表現にばらつきがあった。原作の雰囲気を再現するための詳細なガイドラインを追加した。

### 実施内容

1. **キャラクター演出の基本方針**: 原作の表現をふんだんに使うことを明記
2. **リーダーもキャラクターとして振る舞う**: 無個性な「リーダー」役を廃止
3. **リーダーの統率責任**: 品質担保、ペナルティの仕組みを追加
4. **進捗報告ルール**: 作業開始時・中間・問題発見時の報告を義務化
5. **長時間返信がないメンバーへの対応**: リーダーの反応パターンを追加

### 動作確認

2つの異なるテーマでテスト実施:

| テスト | 進捗報告 | 結果 |
|--------|----------|------|
| 1回目（ガイドライン追加前） | 最終報告のみ | 物語感不足、作業状況が把握しづらい |
| 2回目（ガイドライン追加後） | 作業開始・中間・完了 | 物語感向上、リアルタイムで状況把握可能 |

### うまくいったこと

1. **進捗報告の義務化が効果的**: 作業開始時・中間報告により、メンバーが何をしているか把握可能に
2. **キャラクターらしい表現**: 各キャラクターの性格や口癖が自然に反映された
3. **リーダーのキャラクター化**: リーダーもキャラクターとして応答することで一体感が向上

### 改善点

1. **最初のテストでは報告が不足**: ガイドラインで明示する前は中間報告がなかった
2. **具体的な台詞サンプルは著作権リスク**: レビュー指摘を受けて削除し、方針のみ記載する形式に変更

### 次に活かすこと

1. **ガイドラインは「どう表現するか」を言葉で示す**: 具体的な台詞例は避け、Claudeの知識を活用
2. **進捗報告を明示的に指示する**: 「細かく報告して物語感を出す」と伝えると効果的
3. **リーダーは沈黙にも反応する**: メンバーの沈黙を放置せず、キャラクターらしく声をかける

## テーマ履歴管理＋物語構造ルール追加: Issue #198 / PR #200

### 背景

「チームで開発して」でランダム選択する際、特定のテーマが頻出しやすく、多様性が損なわれていた。また、チーム作業中の物語演出が「ただの作業報告」になりがちだった。

### 実施内容

1. **テーマ履歴管理機能**: `~/.claude/team-theme-history.json` に使用履歴を保存し、直近10件との重複を避ける
2. **物語構造の適用ルール**: 課題を「敵」「ライバル」として擬人化し、倒すストーリーとして進める
3. **リーダーによる物語オープニング**: チーム開始時に敵を命名・紹介する手順を追加
4. **外部成果物への物語演出禁止**: コミット・PR・Issueにキャラクター名を含めないルール
5. **レビュー担当役割の必須ルール**: チームに必ず1名以上のレビュー担当を含める

### チーム構成

| 役割 | 担当タスク |
|------|-----------|
| リーダー | 統括・コミット・PR対応 |
| 仕様修正担当 | フィールド表修正、ルール追加 |
| レビュー担当 | doc-reviewer、markdownlint実行 |

### うまくいったこと

1. **物語構造の導入**: レビュー指摘を「敵スタンド使い」として擬人化することで、作業に物語感が生まれた
   - Copilot指摘 → 敵「コピロット」
   - 管理者指摘 → 敵「レビュー・ルール」
   - 仕様不備 → 敵「ルール・ブレイカー」

2. **リアルタイムの仕様改善**: 作業中にユーザーから「物語が足りない」という指摘を受け、即座に仕様を追加・改善できた

3. **レビュー担当の分離**: レビュー担当が専任として機能し、仕様修正担当の成果物を第三者視点で確認

### 改善点・ハマったこと

1. **外部成果物への演出漏れ**
   - **問題**: PRコメントにキャラクター名を含むチーム名・メンバー名を記載してしまった
   - **原因**: 物語の熱量がそのまま外部出力に流れた
   - **対応**: 「外部成果物への物語演出禁止」ルールを仕様に追加

2. **物語オープニングの欠如**
   - **問題**: チーム開始時に「敵」を紹介するターンがなく、いきなり作業に入った
   - **対応**: 「リーダーによる物語オープニング」手順を追加

3. **意識的な切り替えの必要性**
   - **問題**: キャラクターを演じながら外部出力を書く際、無意識にキャラクター要素が混入
   - **対応**: `git commit`や`gh pr`実行時に「ここから外部出力」と意識するトリガーを設定

### 次に活かすこと

1. **チーム開始時に必ず「物語オープニング」を行う**: 敵の命名・能力説明・作戦宣言

2. **外部出力の前に一時停止**: コミット・PR・Issueを書く前にキャラクター要素がないか確認

3. **課題を「敵」として擬人化**: ジャンルに応じた物語構造（バトル系なら敵、スポーツ系ならライバル）を適用

4. **レビュー担当を必ず1名以上配置**: チーム構成時に品質担保の役割を明確化

5. **仕様は運用しながら改善**: 問題が発生したら即座にルール化し、仕様書に刻む

## ストーリーテラー役の追加: Issue #220 / PR #221

### 背景

エージェントチームでの開発において以下の問題が発生していた:

1. **リーダーの負荷集中**: メンバーからの報告待ち、進捗把握、ユーザー報告で手一杯
2. **見落としの発生**: ルール違反（キャラ名の成果物混入）、ドキュメント参照漏れ、履歴更新忘れ
3. **品質担当の役割限界**: code-reviewer/doc-reviewer/test-runner は成果物の品質チェックに特化しており、プロセス全体の監視は範囲外

当初は「メタレビュアー」という監視役を提案したが、チームで議論した結果「ストーリーテラー（語り部）」として再設計した。

### 議論プロセス

チーム構成で検討:

| 役割 | 視点 | 主な意見 |
|------|------|---------|
| リーダー | 論点整理 | 両者の意見を統合 |
| メンバーA | 科学的・分析的 | 心理学的な観点で「指示」と「想起」の違いを分析 |
| メンバーB | 実務者・現場感覚 | 複雑化への懸念、既存品質担当の拡張を優先すべきと主張 |

**転換点**: ユーザーから「ストーリーテラーとして物語を語らせ、想起のきっかけにする」というアイデアが出された。これにより:

- 「指示」→「気づき」への転換で心理的抵抗を解消
- キャラクターテーマとの親和性が向上
- 「報告」と「指示」の境界問題を解消（物語は指示にならない）

### 実施内容

1. **役割定義**: プロセス全体を見守り、物語として状況を語る
2. **介入パターン**: 問題レベルに応じてテンションを変える
   - Medium: 静かな伏線（「一方その頃...」）
   - High: 不穏な予兆
   - Critical: 大事件発生＋具体的対象を明示
3. **テーマ別バリエーション**: ナレーター/吟遊詩人/実況者など
4. **受け入れ条件追加**: AC6, AC7

### うまくいったこと

1. **チーム議論による視点の多様化**: 賛成派（分析的視点）と慎重派（実務的視点）の対立から、より良い案が生まれた

2. **ユーザーからのアイデア取り込み**: 「監視」→「見守り」への転換は、チーム内議論だけでは出なかった発想

3. **Critical対応の演出**: 「物語を中断する」のではなく「大事件として演出する」という発想で、世界観を壊さず緊急性を伝えられる設計に

### 次に活かすこと

1. **「監視」より「見守り」**: 指摘ではなく気づきを促すアプローチが効果的

2. **問題の深刻度をテンションで表現**: 別途ルールを覚えるより、語りの熱量で直感的に伝わる

3. **Critical時は具体的対象を明示**: 曖昧な語りでは対応が遅れる。「何が」「どう問題か」を含める

4. **議論はチームで、転換点はユーザーから**: チーム内で煮詰まっても、ユーザーの一言で視点が変わることがある

## 参考

- エージェントチーム仕様: [docs/specs/agent-teams.md](../specs/agent-teams.md)
- 関連PR: #172（エンコーディング自動検出修正）、#193（キャラクター演出ガイドライン）、#200（テーマ履歴管理＋物語構造ルール）、#221（ストーリーテラー役追加）
- 関連Issue: #169（RAG検索結果がチャット回答に反映されない）、#190（キャラクター演出）、#198（チームビルディングの偏りを防ぐ）、#220（メタレビュアー役の検討）
