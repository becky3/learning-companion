# F9: RAGインフラ（チャンキング・ベクトルストア） — レトロスペクティブ

## 何を実装したか

RAG（Retrieval-Augmented Generation）の基盤となるテキストチャンキングとChromaDBベクトルストアを実装した。

主なコンポーネント:

- **テキストチャンキング** (`src/rag/chunker.py`): 段落→文→文字数の優先順で分割、オーバーラップ付き
- **ベクトルストア** (`src/rag/vector_store.py`): ChromaDBラッパー（add_documents, search, delete_by_source, get_stats）
- **Embeddingプロバイダー** (`src/embedding/`): ローカル（sentence-transformers）とオンライン（OpenAI）の切り替え対応

関連PR: #120 (仕様書), #121 (Embedding実装), #151 (チャンキング・ベクトルストア)

## うまくいったこと

- **外部依存の最小化**: LangChainを使わず、純粋なPythonでチャンキングロジックを実装。依存関係がシンプルになり、デバッグしやすい
- **既存パターンの活用**: `asyncio.to_thread()` による同期APIラップは `feed_collector.py` と同じパターンを踏襲し、一貫性を保てた
- **テスト設計**: `chromadb.EphemeralClient()` を使うことでファイルシステム副作用なしにテストできた
- **AC番号ベースのテスト命名**: `test_ac5_...` 形式で仕様書の受け入れ条件と対応づけ、トレーサビリティを確保

## 改善点・ハマったこと

### 1. 依存パッケージによるPythonバージョン変更（PR #151）

**問題**: `onnxruntime==1.24.1`（sentence-transformersの依存）がPython 3.11以上を要求。テスト実行時にエラーが発生。

**対応**:

- `.python-version`: 3.10 → 3.11
- `pyproject.toml`: `requires-python`, ruff/mypy の `target-version` を 3.11 に更新
- `README.md`: 動作環境・技術スタックのバージョン記載を更新
- `uv.lock`: 依存関係の再解決

**教訓**:

- 新しい依存パッケージを追加する際は、Pythonバージョン要件を事前に確認する
- バージョン変更は影響範囲が大きい（README, pyproject.toml, CI設定など複数ファイル）。ドキュメントレビューを必ず実施する

### 2. レビュー指摘対応時のcode-reviewer/doc-reviewer実施漏れ

**問題**: Copilotレビュー指摘への対応をコミット・プッシュした後、code-reviewerとdoc-reviewerを実施していなかった。Pythonバージョン変更という大きな変更があったにもかかわらず、ドキュメント整合性チェックが抜けていた。

**対応**: ユーザーに指摘されてから実施し、README.mdとpyproject.tomlの追加修正が必要になった。

**教訓**:

- CLAUDE.mdの「実装完了時の必須手順」を厳守する。特にレビュー指摘対応でも同じ手順を踏む
- 大きな変更（Pythonバージョン、依存関係）があった場合は特にドキュメントレビューを重視する

### 3. 引数バリデーション追加時のテスト影響

**問題**: `chunk_text()` に引数バリデーション（`chunk_size > 0`, `chunk_overlap < chunk_size`）を追加したところ、既存テストの一部がデフォルトの `chunk_overlap=50` を使っており、小さい `chunk_size` を指定したテストで `ValueError` が発生。

**対応**: テストで `chunk_overlap` を明示的に指定するよう修正。

**教訓**:

- バリデーション追加時は、既存のテストケースがそのバリデーションに抵触しないか確認する
- 特にデフォルト値を持つパラメータは、様々な組み合わせで使われている可能性がある

### 4. コメントと実装の不一致

**問題**: `_split_by_sentences()` のコメントに「ピリオド後にスペースまたは改行がある場合のみ」と記載されていたが、実装の正規表現 `\s*` は空白なしでも分割する仕様だった。

**対応**: コメントを実装に合わせて修正（「句点後の空白があれば含めて分割、なくても分割する」）。

**教訓**:

- コメントを書く際は実装と正確に一致させる。特に正規表現など複雑なロジックは要注意
- コードレビュー時はコメントと実装の整合性も確認する

## 次に活かすこと

1. **依存パッケージ追加時はPythonバージョン要件を確認する** — 特にML系ライブラリ（onnxruntime, torch等）はバージョン制約が厳しい傾向がある

2. **レビュー指摘対応でもCLAUDE.mdの手順を完全に実行する** — テスト実行だけでなく、code-reviewer/doc-reviewerも必ず実施する。特に影響範囲の大きい変更は重点的に

3. **バリデーション追加前に既存テストへの影響を確認する** — 新しい制約を追加すると、既存のテストがその制約に違反している可能性がある

4. **コメントは実装と同時に検証する** — 実装を変更したらコメントも更新。レビュー時はコメントと実装の一致を確認項目に含める
