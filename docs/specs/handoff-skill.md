# セッション引き継ぎスキル（/handoff）

## 概要

セッション終了時の引き継ぎ処理を `/handoff` コマンドでワンアクション化するClaude Codeスキル。MEMORY.mdの更新、ジャーナル記録、次セッションへの申し送りを一括で行う。

## 背景

セッション終了時に毎回「引き継ぎメモリお願い」と手動で打ち込み、MEMORY.mdの更新を依頼している。この定型処理をスキル化することで:

- 引き継ぎ作業の手間を削減（手動依頼 → コマンド1発）
- 記録内容のフォーマットを統一
- ジャーナルによるセッション履歴の蓄積（1エントリ1ファイル方式）
- 次セッションの開始点を明確にする

## ユーザーストーリー

- 開発者として、`/handoff` でセッション引き継ぎ処理を一括実行したい
- 開発者として、`/handoff "次のタスクのヒント"` でカスタムメッセージを添えて引き継ぎしたい
- 開発者として、過去のセッション履歴をジャーナルで振り返りたい

## 技術仕様

### スキル定義

```yaml
name: handoff
description: セッション引き継ぎ（MEMORY.md更新・ジャーナル記録・次セッション申し送り）
user-invocable: true
allowed-tools: Bash, Read, Edit, Write, Grep, Glob
argument-hint: "[メッセージ]"
```

### コマンド体系

| コマンド | 用途 |
|---------|------|
| `/handoff` | セッション引き継ぎを実行 |
| `/handoff "メッセージ"` | カスタムメッセージ付きで引き継ぎ |

### ファイル構成

| ファイル | パス | 役割 |
|---------|------|------|
| MEMORY.md | `{MEMORY_DIR}/MEMORY.md` | Claude Codeの永続メモリ（セッション横断） |
| journal/ | `{MEMORY_DIR}/journal/` | ジャーナルディレクトリ（1エントリ1ファイル） |
| journal-guidelines.md | `{MEMORY_DIR}/journal-guidelines.md` | ジャーナル運用ガイドライン |

> `{MEMORY_DIR}` は Claude Code のシステムプロンプトで提供されるプロジェクトメモリディレクトリパス。
>
> ジャーナルファイル命名規則: `YYYYMMDD-HHMMSS-タイトルスラッグ.md`

### 処理フロー

```mermaid
flowchart TD
    A[/handoff 実行] --> B[セッション情報の収集]
    B --> C[MEMORY.md 更新]
    C --> D[journal/ に新規ファイル作成]
    D --> E[ユーザーへの報告]
```

### ステップ1: セッション情報の収集

以下の情報を収集し、引き継ぎの材料とする:

1. **今日のコミット履歴**

   ```bash
   git log --oneline --since="midnight" --author="$(git config user.name)"
   ```

2. **現在のブランチとステータス**

   ```bash
   git branch --show-current
   git status --short
   ```

3. **今日マージされたPR**（あれば）

   ```bash
   gh pr list --state merged --search "merged:>=$(date -I)" --json number,title
   ```

4. **未完了のタスク**
   - 未コミットの変更があるか
   - 作業中のIssue/PRがあるか

### ステップ2: MEMORY.md の確認

MEMORY.md に新たなプロジェクト知見があれば追記する。

**更新ルール:**

- **進行中タスクは MEMORY.md に書かない**（ジャーナルに記録する）
- MEMORY.md に書くもの: **頻繁に行う作業で、間違うと実害があり、lint やテストでは検知できないもの**（環境固有の罠、操作上の禁止事項など）
- 新たな知見があれば追記、なければ変更なし
- MEMORY.mdが存在しない場合は新規作成
- 200行を超えないよう簡潔に記述する（Claude Codeのシステムプロンプトに読み込まれるため）

### ステップ3: journal/ に新規ファイル作成

セッションの記録をジャーナルディレクトリに個別ファイルとして作成する。既存の `journal-guidelines.md` のフォーマットに従う。

**ファイル名の生成:**

```bash
TIMESTAMP=$(date '+%Y%m%d-%H%M%S')
SLUG="タイトルのスラッグ"
FILENAME="${TIMESTAMP}-${SLUG}.md"
```

- タイトルスラッグ: Issue番号 `(#NNN)` や副題（`—` 以降）を除去し、スペースをハイフンに置換。パス区切り文字（`/`, `\`）や制御文字は除去する
- 例: `20260218-153000-ジャーナル個別ファイル化.md`

**ファイル内容:**

```markdown
## YYYY-MM-DD HH:MM:SS - 一言タイトル

- **やったこと**: 概要（1-2行）
- **判断**: 迷った点・選んだ選択肢・理由
- **結果**: 良かった / 悪かった / 未検証
- **気づき**: 次に活かすこと、ユーザーへの提案候補
```

カスタムメッセージ（引数）がある場合は「**気づき**」の末尾に追記する。

**追加ルール:**

- ジャーナルディレクトリが存在しない場合は作成する
- 日時はスキル実行時の日時を使用（`date '+%Y-%m-%d %H:%M:%S'`）
- ローリングは不要（個別ファイル方式のため）

### ステップ4: ユーザーへの報告

引き継ぎ結果をユーザーにわかりやすく表示する。

**出力形式:**

```text
✅ セッション引き継ぎ完了

📝 MEMORY.md を更新しました
📓 ジャーナルを作成しました: {ファイル名}

---
🔜 次のセッションで:
- [次にやることの箇条書き]
```

## 使用LLMプロバイダー

**Claude Code (Claude Sonnet 4.5)** — スキル実行環境で使用

**選定理由:**

- セッション情報の要約・構造化にはLLMの推論力が必要
- Claude Codeのスキル機能はメインのClaude Sonnet 4.5エージェントによって実行される

## 受け入れ条件

- [ ] AC1: `/handoff` で MEMORY.md に新たな知見があれば追記される（進行中タスクは書かない）
- [ ] AC2: `/handoff` で `journal/` ディレクトリに個別ファイルとしてセッションエントリが作成される（journal-guidelines.md の形式に準拠）
- [ ] AC3: 引き継ぎ結果がユーザーに報告される（次セッションの開始点が明示される）
- [ ] AC4: `/handoff "メッセージ"` でカスタムメッセージがジャーナルに含まれる
- [ ] AC5: MEMORY.md・`journal/` ディレクトリが存在しない場合、新規作成される
- [ ] AC6: MEMORY.md が200行を超えないよう簡潔に記述される

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `.claude/skills/handoff/SKILL.md` | handoffスキル定義 |
| `{MEMORY_DIR}/MEMORY.md` | 永続メモリ |
| `{MEMORY_DIR}/journal/` | ジャーナルディレクトリ（1エントリ1ファイル） |
| `{MEMORY_DIR}/journal-guidelines.md` | ジャーナル運用ガイドライン |
| `CLAUDE.md` | スキル一覧への登録 |

## テスト方針

Claude Codeスキルは実行時テストが中心となるため、手動テストで確認:

- [ ] `/handoff` でMEMORY.md に進行中タスクが書かれないことを確認（AC1）
- [ ] `journal/` に個別ファイルとしてエントリが作成される（AC2）
- [ ] 結果報告に次セッションの開始点が含まれる（AC3）
- [ ] カスタムメッセージが反映される（AC4）

## 拡張性

将来的に以下の機能を追加可能:

- Slack/Discord への引き継ぎ通知
- チーム開発時のメンバー間引き継ぎ
- セッション統計（作業時間、コミット数等）の自動計算

## 参考資料

- Issue #389 — 本機能の議論
- [Claude Code Skills公式ドキュメント](https://code.claude.com/docs/ja/skills)
