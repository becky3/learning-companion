# エージェントチーム機能

## 概要

エージェントチームは Claude Code の実験的機能で、リーダー1名とチームメンバー（独立した Claude Code インスタンス）で構成される協調作業システムである。

> **注意**: 本機能は実験的であり、将来の Claude Code アップデートで仕様変更の可能性がある。

## 背景

### 課題

- 複雑な機能実装では、仕様・実装・テストが相互に依存し、単一エージェントでの逐次処理では効率が悪い
- バグ調査では複数の仮説を並行して検証したいが、サブエージェントでは相互通信ができない
- PRレビューでは複数の観点（セキュリティ、パフォーマンス、テスト）を同時に確認したい

### 解決策

エージェントチームにより、複数の専門エージェントが並行して作業し、相互に調整しながらタスクを完了できる。

## ユーザーストーリー

- 開発者として、大規模な機能実装を仕様・実装・テストの3チームに分割して並行開発したい
- 開発者として、バグの原因を複数の仮説で同時に調査し、最も可能性の高い原因を特定したい
- 開発者として、PRを複数の観点から同時にレビューし、包括的なフィードバックを得たい

## 技術仕様

### 有効化

`.claude/settings.json` の `env` セクションで有効化する。設定変更後、Claude Code を再起動して反映する。

```json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  }
}
```

### サブエージェントとの違い

| 特性 | サブエージェント | エージェントチーム |
|------|-----------------|-------------------|
| 通信 | リーダーとのみ | チームメンバー同士も可能（共有ファイル、タスクリスト経由） |
| タスク管理 | 個別 | 共有タスクリスト |
| 調整 | リーダーが指示 | 自己調整機能あり |
| コンテキスト | リーダーの一部を継承 | 独立した完全なコンテキスト |
| 適したタスク | 単一の専門タスク | 複雑な並行作業 |

### 適したユースケース

- **調査とレビュー**: 複数視点での並行調査
- **新しいモジュール・機能**: 干渉しない並行開発
- **競合仮説でのデバッグ**: 異なる理論の並列テスト
- **クロスレイヤー調整**: フロントエンド、バックエンド、テストの同時開発

## 推奨チーム構成

このプロジェクトの「仕様駆動開発」ワークフローに最適化したチーム構成:

| ロール | 名前 | 責務 | モデル |
|--------|------|------|--------|
| **リーダー** | Architect | 全体調整、タスク分割、結果統合（デリゲートモードで調整に専念） | Opus |
| **仕様担当** | Spec-Writer | 仕様書の作成・更新（docs/specs/ の管理） | Sonnet |
| **実装担当** | Implementer | src/ のコード実装（planner の出力を実装） | Sonnet |
| **品質担当** | QA-Lead | テスト作成、コードレビュー、型チェック | Sonnet |

> **モデル選定について**: リーダーには高度な判断力が必要なため Opus を推奨。チームメンバーは専門タスクに集中するため、コスト効率の良い Sonnet で十分。サブエージェント定義（`.claude/agents/`）のモデル指定とは独立した設定となる。

## ユースケース別プロンプトテンプレート

### 新機能実装チーム

```text
Issue #42 の新機能を実装してください。以下のチームメンバーを作成:
- Spec-Writer: docs/specs/ の仕様書作成
- Implementer: src/ の実装
- QA-Lead: tests/ のテスト作成とレビュー
各メンバーはプラン承認を必要とします。
```

### バグ調査チーム

```text
バグ #123 を調査してください。3人のチームメンバーを作成:
- 各メンバーは異なる仮説を調査
- 互いの仮説に異議を唱えながら真因を特定
- 結論が出たら FINDINGS.md に記録
```

### コードレビューチーム

```text
PR #456 をレビューしてください。3人のレビュアーを作成:
- Security-Reviewer: セキュリティの観点
- Performance-Reviewer: パフォーマンスの観点
- Test-Reviewer: テストカバレッジの観点
各自がレビュー結果を報告
```

### リファクタリングチーム

```text
モジュール chat_service をリファクタリングしてください。以下のチームメンバーを作成:
- Analyzer: 現状の問題点を洗い出し
- Designer: 新しい設計を提案
- Implementer: 設計に基づいて実装
- Tester: リグレッションテストを実行
```

## 既存機能との使い分け

| シナリオ | 推奨 | 理由 |
|----------|------|------|
| 単純なテスト実行 | test-runner サブエージェント | 結果報告のみ、通信不要 |
| 単一ファイルのレビュー | code-reviewer サブエージェント | 焦点を絞ったタスク |
| 仕様書の新規作成 | /doc-gen スキル | 定型的なワークフロー |
| 複数ファイルにまたがる機能実装 | **エージェントチーム** | 並行作業、相互調整が必要 |
| 複数視点でのバグ調査 | **エージェントチーム** | 仮説の議論が必要 |
| PR全体のマルチ視点レビュー | **エージェントチーム** | 異なる観点での並行レビュー |

## 注意事項・制限事項

- **トークンコスト増大**: 各チームメンバーが独立したコンテキストを持つため、コストは増加する
- **ファイル競合回避**: 同じファイルを複数メンバーが編集しないようタスク分割を明確にする
- **セッション再開不可**: in-process モードではチームメンバーは再開されない
- **1セッション1チーム**: リーダーは一度に1つのチームのみ管理可能

## チームのライフサイクル

### 「プロンプトを返す」と「チームを解散する」は別

この2つを混同しないこと:

| 操作 | 意味 | メンバーの状態 |
|------|------|----------------|
| **プロンプトを返す** | リーダーがユーザーに制御を戻す | メンバーはバックグラウンドで待機中（アイドル状態） |
| **チームを解散する** | 全メンバーをシャットダウンしチームを削除 | メンバーは終了 |

### 待機モード（通常運用）

タスクが一段落したら、**メンバーをシャットダウンせずに**プロンプトを返す:

1. メンバーが `idle_notification` を送ってきたら、メンバーは待機状態
2. リーダーは「チーム待機中です。追加の指示があればお知らせください」と報告
3. プロンプトをユーザーに返す（リーダーの応答を終了する）
4. 追加作業が発生したら `SendMessage` でメンバーに依頼

**メンバーはバックグラウンドで待機中**なので、追加タスク（レビュー対応、修正など）にすぐ対応できる。

### 解散（明示的な指示があった場合のみ）

**チームはユーザーから明示的な解散指示があるまで維持する。**

解散するのは以下のような指示があった場合のみ:

- 「チーム解散」「解散して」「終了」
- 「もう大丈夫」「ありがとう、終わり」など明確な終了意思

### 解散手順

1. 全チームメンバーに `shutdown_request` を送信
2. 全メンバーの `shutdown_approved` を確認
3. `TeamDelete` でチームリソースをクリーンアップ

### 待機中のメンバー活用例

- PRへのレビューコメント確認・対応
- 追加の修正作業
- ドキュメント更新
- 別の関連タスク

## 受け入れ条件 (AC)

- [ ] AC1: `.claude/settings.json` に `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS: "1"` が設定されている
- [ ] AC2: Claude Code 再起動後、チーム作成プロンプトが認識される
- [ ] AC3: 新機能実装チームのテンプレートでチームメンバーが作成できる
- [ ] AC4: チームメンバー間で共有タスクリストが機能する
- [ ] AC5: 各チームメンバーが独立したコンテキストで作業できる

## 関連ファイル

| ファイル | 役割 |
|----------|------|
| `.claude/settings.json` | エージェントチーム有効化の環境変数設定 |
| `.claude/agents/*.md` | 既存サブエージェント定義（使い分けの参照） |
| `CLAUDE.md` | エージェントチームセクションの概要 |

## テスト方針

本機能は Claude Code の実験的機能であり、自動テストではなく手動確認で検証する:

1. **有効化確認**: `.claude/settings.json` 編集後、Claude Code を再起動してエラーが発生しないこと
2. **チーム作成確認**: 簡単な調査タスクでチーム作成プロンプトを実行し、チームメンバーが作成されること
3. **動作確認**: チームメンバーがそれぞれ独立して作業を開始すること

## 導入ステップ

1. **Phase 1: 有効化と動作確認**
   - `.claude/settings.json` に環境変数を追加
   - 簡単な調査タスクでチーム作成を試行

2. **Phase 2: レビュータスクで運用**
   - PRレビューでマルチ視点チームを使用
   - バグ調査で仮説検証チームを使用

3. **Phase 3: 機能実装への拡張**
   - 大きな機能で仕様・実装・QAチームを使用
   - ワークフローの最適化

## 参考リンク

- [公式ドキュメント](https://code.claude.com/docs/ja/agent-teams)（検索キーワード: "Claude Code agent teams"）
- [参考記事: SOS団方式](https://zenn.dev/sakasegawa/articles/e6a8aa168a7d19)
