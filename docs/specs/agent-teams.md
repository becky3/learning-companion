# エージェントチーム機能

## 概要

リーダー1名とチームメンバー（独立したClaude Codeインスタンス）で構成される協調作業システム。

> **実験的機能**: 将来のアップデートで仕様変更の可能性あり

## 有効化

`.claude/settings.json`:

```json
{ "env": { "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1" } }
```

設定後、Claude Code再起動が必要。

## サブエージェントとの違い

| 特性 | サブエージェント | エージェントチーム |
|------|-----------------|-------------------|
| 通信 | リーダーとのみ | メンバー同士も可能 |
| タスク管理 | 個別 | 共有タスクリスト |
| 適したタスク | 単一専門タスク | 複雑な並行作業 |

## 適したユースケース

- 複数視点での調査・レビュー
- 干渉しない並行開発
- 競合仮説でのデバッグ
- フロントエンド/バックエンド/テストの同時開発

## キャラクターテーマ

「チームで開発して」でランダムにキャラクターテーマが選択される。

- 特定テーマの指定も可能
- 詳細: `.claude/team-themes/GUIDELINES.md`

## 必須ルール

### 品質担当

チームには必ず1名以上、以下のサブエージェントを使う担当を含める:

- code-reviewer（コードレビュー）
- doc-reviewer（ドキュメントレビュー）
- test-runner（テスト実行）

### ストーリーテラー（語り部）

チームには必ず1名、プロセス全体を見守る「ストーリーテラー」を含める。

**役割**:

- 開発プロセス全体を物語として語り、状況を俯瞰する
- ルール遵守・手順漏れを「気づきのきっかけ」として想起させる
- リーダーへの報告を通じて問題を共有する（メンバーへの直接指示は行わない）

**品質担当との違い**:

| 観点 | 品質担当 | ストーリーテラー |
|------|----------|------------------|
| 対象 | 成果物の技術的品質 | プロセスの遵守状況 |
| 例 | コードの設計・テスト網羅性 | 仕様書確認・履歴更新・手順遵守 |
| 介入 | レビュー結果の報告 | 物語風の示唆・報告 |

**語りのタイミング**:

ストーリーテラーは以下のタイミングで**必ず**語りを入れる:

| タイミング | 語りの内容 |
|------------|-----------|
| オペレーション開始時 | 任務の概要、敵（課題）の紹介、作戦方針 |
| 各タスク完了時 | 進捗状況、次のフェーズへの橋渡し |
| 品質チェック開始/完了時 | 検問の開始、結果の総括 |
| PR作成時 | オペレーション完了の締めくくり |

**順調時の演出**:

問題がない場合でも、ストーリーテラーは存在感を示す:

- 「作戦は順調に進んでいる...」
- 「静かに、しかし確実に、任務は遂行されていく」
- 各タスク完了を物語の1シーンとして語る

**問題発生時の介入パターン**:

問題の重要度に応じて語りのトーンを変える:

| レベル | 語りのスタイル | 例 |
|--------|---------------|-----|
| Medium | 静かな伏線 | 「一方その頃、履歴ファイルは静かに更新の時を待っていた...」 |
| High | 不穏な予兆 | 「しかし、仕様書の確認が済んでいないことに、まだ誰も気づいていなかった...」 |
| Critical | 大事件＋具体的対象 | 「待て...！コミット `<commit-id>`（`<file-path>`）に問題が...！」 |

**Critical時の注意**: 緊急性が高い場合は、具体的な対象（ファイル名、コミットID等）を明示すること。曖昧な語りでは対応が遅れる。

**監視対象の例**:

- 外部成果物へのキャラクター要素混入
- 仕様書・既存コード未確認での実装着手
- 必須手順のスキップ（テスト、レビュー、履歴更新等）
- 進捗報告の遅延・不足

### リーダーの責務

**報告**:

- メンバーの発言はそのまま引用してユーザーに共有
- メンバーには細かく分割して報告させる
- メッセージが届いたら、すぐにそのまま引用して共有

**ストーリーテラーへの通知**:

ストーリーテラーは自律的にタスク状況を監視できないため、リーダーが以下のタイミングで状況を伝える:

| タイミング | 通知内容の例 |
|------------|-------------|
| オペレーション開始直後 | 「チーム始動した」 |
| タスク完了時 | 「タスク #N が完了した」 |
| 品質チェック開始時 | 「品質チェック開始」 |
| PR作成完了時 | 「PR #N を作成した」 |

※語りの内容はストーリーテラーに任せる。「〜語りを」「〜状況を報告して」等の直接的な指示は不要。

**統率**:

- キャラクター性より、正しい成果物の完成を優先
- 品質の担保（要件充足の確認、不足時は修正指示）
- 進捗の管理（遅延・問題があれば介入）

### メンバーの進捗報告

以下のタイミングで報告:

- 作業開始時
- 調査・分析の各段階完了時
- 問題・重要な発見時
- 方針に迷った時

**重要: SendMessage の使い方**

SendMessage で報告する際は、**報告内容の本文を必ず content パラメータに含めること**。

❌ NG: 「報告を送信しました」と言うだけで content が空
✅ OK: content に報告内容の全文を含める

```
SendMessage:
  type: "message"
  recipient: "team-lead"  ← キャラクター名ではなく "team-lead" を使う
  content: "ここに報告内容の本文を書く"
  summary: "短い要約"
```

「送った」と自己報告しても、content に内容がなければリーダーには届かない。

**重要: recipient の指定**

リーダーにメッセージを送る際は、**必ず `recipient: "team-lead"` を使用する**。

❌ NG: `recipient: "my-leader"`（任意の名前）→ 別のメールボックスに書き込まれ、リーダーに届かない
✅ OK: `recipient: "team-lead"` → 正しくリーダーに配信される

プロンプトで任意の名前（例: 「my-leaderに報告して」）を指示すると、メンバーは別の recipient を使用してしまい、リーダーシステムは `team-lead` 宛ての inbox のみを購読しているため配信されない。

### キャラクター演出

- リーダーもキャラクターとして振る舞う（無個性な「リーダー」は禁止）
- 外部成果物（コミット、PR、Issue）にはキャラクター要素を含めない
- 演じ方の詳細: `.claude/team-themes/GUIDELINES.md`

### チームのライフサイクル

| 操作 | メンバーの状態 |
|------|----------------|
| プロンプトを返す | 待機中（シャットダウンしない） |
| チーム解散 | 終了（ユーザーの明示的指示が必要） |

### テーマ履歴

- 履歴ファイル: `~/.claude/team-theme-history.json`（git管理外）
- 直近10件は同一テーマを避ける（完全禁止ではない）
- ユーザー指定時は履歴に関係なく採用

## プロンプト例

- 新機能: `Issue #42 を実装。Spec-Writer/Implementer/QA-Leadの3人で`
- バグ調査: `バグ #123 を調査。3人で異なる仮説を検証`
- レビュー: `PR #456 をレビュー。セキュリティ/パフォーマンス/テストの3観点で`

## メンバーのスポーン

Task ツールでメンバーをスポーンする。

```
Task(
    subagent_type="general-purpose",
    name="member-name",
    team_name="team-name",
    prompt="..."
)
```

## 注意事項

- トークンコスト増大（各メンバーが独立コンテキスト）
- 同じファイルを複数メンバーが編集しないようタスク分割
- in-processモードではセッション再開不可
- 1セッション1チーム

## 受け入れ条件

- [ ] AC1: settings.jsonで有効化できる
- [ ] AC2: チーム作成プロンプトが認識される
- [ ] AC3: メンバー間で共有タスクリストが機能する
- [ ] AC4: キャラクターテーマがランダム選択される
- [ ] AC5: テーマ履歴が保存される
- [ ] AC6: チームにストーリーテラーが1名含まれる
- [ ] AC7: ストーリーテラーが問題レベルに応じた語りで介入する

## 関連ファイル

| ファイル | 役割 |
|----------|------|
| `.claude/settings.json` | 有効化設定 |
| `.claude/team-themes/GUIDELINES.md` | キャラクター演出詳細 |
| `~/.claude/team-theme-history.json` | テーマ履歴（git管理外） |
