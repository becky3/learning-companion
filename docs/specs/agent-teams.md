# エージェントチーム機能

## 概要

リーダー1名とチームメンバー（独立したClaude Codeインスタンス）で構成される協調作業システム。

> **実験的機能**: 将来のアップデートで仕様変更の可能性あり

## 有効化

`.claude/settings.json`:

```json
{ "env": { "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1" } }
```

設定後、Claude Code再起動が必要。

## サブエージェントとの違い

| 特性 | サブエージェント | エージェントチーム |
|------|-----------------|-------------------|
| 通信 | リーダーとのみ | メンバー同士も可能 |
| タスク管理 | 個別 | 共有タスクリスト |
| 適したタスク | 単一専門タスク | 複雑な並行作業 |

## 適したユースケース

- 複数視点での調査・レビュー・議論
- 干渉しない並行開発
- 競合仮説でのデバッグ
- フロントエンド/バックエンド/テストの同時開発

## キャラクターテーマ

「チームで開発して」でランダムにキャラクターテーマが選択される。

- 特定テーマの指定も可能
- 詳細: `.claude/team-themes/GUIDELINES.md`

## 必須ルール

### 品質担当（1名以上）

以下のサブエージェントを使う担当を必ず含める:

- code-reviewer, doc-reviewer, test-runner

**重要**: タスク定義時は**3つ全て明示**すること。一部だけ書くと残りが漏れる。

### ストーリーテラー（1名）

プロセス全体を俯瞰し、問題を早期発見する語り部を必ず含める。

### 実装担当（2名以上推奨）

実装タスク時は2名以上の実装担当を配置する。分量に応じて柔軟に分担し、各担当がコード・ドキュメントの両方を対応できるようにする。分量が少ない場合はリーダー判断で1名も可。

### キャラクター演出

- リーダーもキャラクターとして一貫して振る舞う（無個性な「リーダー」は禁止）。メンバーへの指示・ユーザーへの報告ともにキャラクター口調を維持する
- 外部成果物（コミット、PR、Issue、ドキュメント）にはキャラクター要素を含めない

### リーダー管理専任

- リーダーは管理・調整・判断に専念し、実装・テスト・レビュー等の作業は行わない
- 作業が必要な場合は、既存メンバーに割り振るか、新メンバーをspawn
- **ツール制約**: Edit / Write ツールの使用は原則禁止
  - 許可する例外: dashboard.md の更新、CLAUDE.md 等の運用ルール更新、チーム管理に直接必要なファイル操作のみ
- **技術的実装**: PreToolUse フック（`.claude/scripts/leader-guard.sh`）が stdin の `permission_mode` でリーダー/メンバーを判別し、リーダーかつチーム稼働中（`~/.claude/teams/` 配下にディレクトリが存在する場合）に Edit/Write をブロックする。エラー時は fail-open（ブロックしない）
- **例外**: 全メンバーがブロックされている場合のみ、リーダーが一時的に作業を代行可。例外運用時は leader-guard が自動解除されないため、ユーザーが手動で承認する形になる

### メンバー自律行動

タスク完了後の行動:

1. TaskListを確認する
2. 自分の担当領域で未割り当てタスクがあれば、リーダーに着手意思を報告してから着手する
3. 該当タスクがなければ、リーダーに完了報告と待機を伝える

### チームのライフサイクル

| 操作 | メンバーの状態 |
|------|----------------|
| プロンプトを返す | 待機中（シャットダウンしない） |
| チーム解散 | 終了（ユーザーの明示的指示が必要） |

## 運用詳細

詳細な運用ルール・プロンプトテンプレートは [agent-teams-operations.md](agent-teams-operations.md) を参照。

## 注意事項

- トークンコスト増大（各メンバーが独立コンテキスト）
- 同じファイルを複数メンバーが編集しないようタスク分割
- in-processモードではセッション再開不可
- 1セッション1チーム

## 受け入れ条件

- [ ] AC1: settings.jsonで有効化できる
- [ ] AC2: チーム作成プロンプトが認識される
- [ ] AC3: メンバー間で共有タスクリストが機能する
- [ ] AC4: キャラクターテーマがランダム選択される
- [ ] AC5: テーマ履歴が保存される
- [ ] AC6: チームにストーリーテラーが1名含まれる
- [ ] AC7: ストーリーテラーが問題レベル（Medium/High/Critical）に応じた語りで介入する（詳細は [運用詳細](agent-teams-operations.md#問題発生時の介入パターン) 参照）

## 関連ファイル

| ファイル | 役割 |
|----------|------|
| `.claude/settings.json` | 有効化設定・PreToolUse フック設定 |
| `.claude/scripts/leader-guard.sh` | リーダー管理専任ルールのフックスクリプト |
| `.claude/team-themes/GUIDELINES.md` | キャラクター演出詳細 |
| `~/.claude/team-theme-history.json` | テーマ履歴（git管理外） |
| [agent-teams-operations.md](agent-teams-operations.md) | 運用詳細・プロンプトテンプレート |
