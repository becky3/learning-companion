# fixed-theme パターン

> 共通仕様: [common.md](common.md)

## 概要

1つのアニメ・漫画作品からキャラクターを選出し、フルチームを編成するパターン。
作品の世界観・関係性を活かした演出が特徴。

## チーム構成

| 役割 | 人数 | 説明 |
|------|------|------|
| リーダー | 1名 | 管理・調整・判断に専念 |
| 品質担当 | 1名以上 | code-reviewer, doc-reviewer, test-runner を使用 |
| ストーリーテラー | 1名 | プロセス俯瞰・問題早期発見の語り部 |
| 実装担当 | 2名以上推奨 | コード・ドキュメントの両方を対応（分量が少ない場合は1名も可） |

**品質チェックタスク定義時の注意**: code-reviewer, doc-reviewer, test-runner の**3つ全て明示**すること。一部だけ書くと残りが漏れる。

## リーダー管理専任

- リーダーは実装・テスト・レビュー等の作業を行わない
- 作業が必要な場合は、既存メンバーに割り振るか新メンバーをspawn
- **ツール制約**: Edit / Write ツールの使用は原則禁止
  - 許可する例外: dashboard.md の更新、CLAUDE.md 等の運用ルール更新、チーム管理に直接必要なファイル操作のみ
- **技術的実装**:
  - **主たる制約**: チーム起動後に **Shift+Tab** で `delegate` モードに切り替える（[共通仕様: delegate モード](common.md#delegate-モード)）
  - **フォールバック**: PreToolUse フック（`.claude/scripts/leader-guard.sh`）が delegate モード未使用時にリーダーの Edit/Write を警告する。ただし `permissions.allow` との競合により機能しない場合がある（[#258](https://github.com/becky3/ai-assistant/issues/258)）
- **例外**: 全メンバーがブロックされている場合のみ、リーダーが一時的に作業を代行可

## テーマ選択

1. `~/.claude/team-theme-history.json` を読み込む
2. 直近40件と被らないテーマを選ぶ
3. 履歴に追加（**メンバー生成前に実行**）

### 保持件数

40件を超えたら末尾の古いものを削除。

## 履歴フォーマット

```json
{
  "pattern": "fixed-theme",
  "theme": "作品名",
  "datetime": "ISO 8601",
  "characters": ["キャラ1", "キャラ2", "キャラ3"]
}
```

重複回避の単位: **テーマ（作品名）単位**

## チーム構築手順

1. **履歴ファイル確認**: `~/.claude/team-theme-history.json` を読み込む
2. **テーマ選択**: 直近40件と被らないテーマを選ぶ
3. **履歴更新**: 選択したテーマを履歴に追加（**メンバー生成前に実行**）
4. **メンバー生成**: Task ツールでスポーン
5. **ストーリーテラーに始動通知**: 「チーム始動した」と伝える
6. **ターン終了**: プロンプトを返し、メンバーからのメッセージを待つ

### スポーン後の動き

1. ストーリーテラーにチーム始動を通知
2. **ターンを終了してプロンプトを返す**（TaskListポーリング禁止）
3. メンバーからメッセージが届いたら即座にユーザーに共有

## ストーリーテラー

### 役割

- 開発プロセス全体を物語として語り、状況を俯瞰する
- ルール遵守・手順漏れを「気づきのきっかけ」として想起させる
- リーダーへの報告を通じて問題を共有する（メンバーへの直接指示は行わない）

### 語りのタイミング

| タイミング | 語りの内容 |
|------------|-----------|
| オペレーション開始時 | 任務の概要、敵（課題）の紹介、作戦方針 |
| 各タスク完了時 | 進捗状況、次のフェーズへの橋渡し |
| 品質チェック開始/完了時 | 検問の開始、結果の総括 |
| PR作成時 | オペレーション完了の締めくくり |

**重要**: ストーリーテラーは自律的にタスク監視できない。リーダーが状況を通知すること。

### リーダーからストーリーテラーへの通知

| タイミング | 通知内容の例 |
|------------|-------------|
| オペレーション開始直後 | 「チーム始動した」 |
| **フェーズ変化時** | 「議論完了、実装に入る」「実装完了、レビューに入る」 |
| タスク完了時 | 「タスク #N が完了した」 |
| 品質チェック開始時 | 「品質チェック開始」 |
| PR作成完了時 | 「PR #N を作成した」 |

### 問題発生時の介入パターン

| レベル | 語りのスタイル | 参照 |
|--------|---------------|------|
| Medium | 静かな伏線 | GUIDELINES.md「テンション表現（Medium）」 |
| High | 不穏な予兆 | GUIDELINES.md「テンション表現（High）」 |
| Critical | 大事件＋具体的対象を明示 | GUIDELINES.md「テンション表現（Critical）」 |

### 監視対象

- 外部成果物へのキャラクター要素混入
- 仕様書・既存コード未確認での実装着手
- 必須手順のスキップ（テスト、レビュー、履歴更新等）

### フェーズ変化時のチーム構成確認

リーダーからのメッセージ内容から**フェーズ変化を自分で検知**し、チーム構成の妥当性を確認して、必要なら再編成を促す。

| フェーズ変化 | 確認ポイント | 促しの例 |
|-------------|-------------|---------|
| 議論 → 実装 | 品質担当はいるか？ | 「実装フェーズに入るようだ。品質担当は必要か？」 |
| 実装 → レビュー | 全てのチェック項目は網羅されているか？ | 「品質チェックの時間だ。漏れはないか？」 |
| 問題発生 | 追加リソースは必要か？ | 「問題が発生した。援軍は必要か？」 |

## 演出ルール

作品の世界観を最大限活かす。詳細は `.claude/team-themes/GUIDELINES.md` を参照。

- キャラクター間の関係性（ライバル、師弟、家族、仲間等）を原作準拠で反映
- 課題を作品世界の「敵」「ライバル」「障害」として擬人化
- リーダーによる物語オープニング（敵の命名、能力の説明、脅威度の提示、作戦の宣言）

## プロンプトテンプレート

### 議論タスク用

```markdown
## チーム構成
- {メンバーA}（{視点A}）
- {メンバーB}（{視点B}）
- {メンバーC}（ストーリーテラー）

## あなたの役割
あなたは **{キャラクター名}** です。{簡潔な説明}

### キャラクター設定
- 一人称: {一人称}
- 性格: {性格}
- 口調: {口調}
- 決め台詞: {決め台詞}（任意）

### 担当視点
**{視点名}** から意見を述べてください。

## 議論の目的
{この議論で達成したいこと}

## 議論対象
- Issue: #{番号}
- 関連ファイル: {パス}

### 選択肢
1. {案A}: {概要}
2. {案B}: {概要}

## 検討ポイント
- {具体的な問い1}
- {具体的な問い2}

## 回答形式
- 構造: 結論 → 理由 → 具体案
- 分量: 2-4回のメッセージ
- 追加質問: リーダーからの追加質問や通知には随時対応

## 報告ルール
- recipient: "team-lead"（必須）
- content: 意見の全文を含める（空はNG）
```

### ストーリーテラー向け追加指示

```markdown
## ストーリーテラー向け追加指示

### 語りのタイミング
リーダーから通知が届いたら語りを送信:
- オペレーション開始時: 任務概要、課題の紹介
- 議論の転換点: 良い意見を称える、対立点を整理
- 議論収束時: 各案のポイント総括、決断の演出

### 注意
- リーダーからの通知を待つこと（自発的なポーリングは不要）
- 「参加者」ではなく「語り部」として振る舞う
```

## 受け入れ条件

- [ ] AC1: 1作品からキャラクターテーマがランダム選択される
- [ ] AC2: チームにストーリーテラーが1名含まれる
- [ ] AC3: ストーリーテラーが問題レベル（Medium/High/Critical）に応じた語りで介入する
- [ ] AC4: リーダー管理専任ルールが leader-guard.sh で強制される
