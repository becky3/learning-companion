# エージェントチーム共通仕様

> パターン固有の仕様は [fixed-theme.md](fixed-theme.md) / [mixed-genius.md](mixed-genius.md) を参照

## 概要

リーダー1名とチームメンバー（独立したClaude Codeインスタンス）で構成される協調作業システム。

> **実験的機能**: 将来のアップデートで仕様変更の可能性あり

## 有効化

`.claude/settings.json`:

```json
{ "env": { "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1" } }
```

設定後、Claude Code再起動が必要。

## サブエージェントとの違い

| 特性 | サブエージェント | エージェントチーム |
|------|-----------------|-------------------|
| 通信 | リーダーとのみ | メンバー同士も可能 |
| タスク管理 | 個別 | 共有タスクリスト |
| 適したタスク | 単一専門タスク | 複雑な並行作業 |

## 適したユースケース

- 複数視点での調査・レビュー・議論
- 干渉しない並行開発
- 競合仮説でのデバッグ
- フロントエンド/バックエンド/テストの同時開発

## チーム構成パターン

「チームで開発して」で**デフォルトパターン**が使用される。パターンを明示的に指定することも可能。

| パターン | 概要 | 人数 |
|---------|------|------|
| [fixed-theme](fixed-theme.md) | 1作品からキャラを選出するフルチーム | 4〜6人 |
| [mixed-genius](mixed-genius.md) | デフォルトキャラクター固定 + 知性キャラの軽量チーム | 2〜3人 |

### デフォルトパターン設定

`.claude/team-themes/config.json`:

```json
{
  "default_pattern": "mixed-genius"
}
```

- 未設定時のフォールバック: `fixed-theme`（既存動作との互換性）
- 明示指定: 「fixed-theme パターンで」「mixed-genius で」等

## 共通ルール

### キャラクター演出

- リーダーもメンバーもキャラクターとして一貫して振る舞う
- 特に事務的な応答（「待ちます」「確認します」等）でキャラクターが抜けやすいため注意

### 外部成果物のキャラクター排除（厳守）

以下にキャラクター名・キャラクター要素を**絶対に含めない**:

- コミットメッセージ
- PR / Issue の本文・コメント
- ソースコード・テスト・設定ファイル
- 仕様書・ドキュメント

**例外**: 運用ガイド（CLAUDE.md、`docs/specs/agent-teams/`、`.claude/team-themes/`）は演出ルール記載のため許可。

### チームのライフサイクル

| 操作 | メンバーの状態 |
|------|----------------|
| プロンプトを返す | 待機中（シャットダウンしない） |
| チーム解散 | 終了（ユーザーの明示的指示が必要） |

### メッセージング規約

```
SendMessage:
  type: "message"
  recipient: "team-lead"  # 必須: キャラクター名ではなく "team-lead" を使う
  content: "報告内容の本文"  # 必須: 空にしない
  summary: "短い要約"
```

- `recipient` は必ず `"team-lead"` を使用
- `content` に報告内容の全文を含める（空だとリーダーに届かない）

### リーダーの報告ルール

- メンバーの発言はそのまま引用してユーザーに共有（まとめない）
- メンバーには細かく分割して報告させる
- メッセージが届いたら即座に引用して共有

### メンバー自律行動

タスク完了後の行動:

1. TaskListを確認する
2. 自分の担当領域で未割り当てタスクがあれば、リーダーに着手意思を報告してから着手する
3. 該当タスクがなければ、リーダーに完了報告と待機を伝える

## 履歴管理

### 履歴ファイル

パス: `~/.claude/team-theme-history.json`（git管理外）

### 共通フィールド

```json
{
  "pattern": "パターン名",
  "theme": "テーマ名 or パターン名",
  "datetime": "ISO 8601（date -Iseconds で取得）",
  "characters": ["キャラ1", "キャラ2"]
}
```

- 新しいエントリは配列の**先頭**に追加
- `datetime` は `date -Iseconds` で取得（手動入力禁止）

パターン固有のフィールドは各パターン仕様を参照。

## 注意事項

- トークンコスト増大（各メンバーが独立コンテキスト）
- 同じファイルを複数メンバーが編集しないようタスク分割
- in-processモードではセッション再開不可
- 1セッション1チーム

## 受け入れ条件

- [ ] AC1: settings.jsonで有効化できる
- [ ] AC2: チーム作成プロンプトが認識される
- [ ] AC3: メンバー間で共有タスクリストが機能する
- [ ] AC4: デフォルトパターンで起動できる
- [ ] AC5: パターンを明示指定して起動できる
- [ ] AC6: テーマ/キャラ履歴が保存される
- [ ] AC7: 外部成果物にキャラクター要素が含まれない

## 関連ファイル

| ファイル | 役割 |
|----------|------|
| `.claude/settings.json` | 有効化設定・PreToolUse フック設定 |
| `.claude/scripts/leader-guard.sh` | リーダー管理専任ルールのフックスクリプト（fixed-theme 用） |
| `.claude/team-themes/config.json` | デフォルトパターン設定 |
| `.claude/team-themes/GUIDELINES.md` | キャラクター演出詳細 |
| `~/.claude/team-theme-history.json` | テーマ/キャラ履歴（git管理外） |
| [fixed-theme.md](fixed-theme.md) | fixed-theme パターン仕様 |
| [mixed-genius.md](mixed-genius.md) | mixed-genius パターン仕様 |
