# エージェントチーム運用詳細

> 仕様書: [agent-teams.md](agent-teams.md)

## チーム構築手順

1. **履歴ファイル確認**: `~/.claude/team-theme-history.json` を読み込む
2. **テーマ選択**: 直近10件と被らないテーマを選ぶ
3. **履歴更新**: 選択したテーマを履歴に追加（**メンバー生成前に実行**）
4. **メンバー生成**: Task ツールでスポーン
5. **ストーリーテラーに始動通知**: 「チーム始動した」と伝える
6. **ターン終了**: プロンプトを返し、メンバーからのメッセージを待つ

### 履歴ファイルのフォーマット

```json
{
  "history": [
    { "theme": "テーマ名", "datetime": "2026-02-11T12:34:56", "characters": ["キャラ1", "キャラ2"] }
  ]
}
```

- `datetime`: ISO 8601形式（例: `date -Iseconds` で取得、環境に応じて適宜調整）
- 新しいエントリは配列の**先頭**に追加
- **保持件数**: 10件を超えたら末尾の古いものを削除

## メンバーのスポーン

```
Task(
    subagent_type="general-purpose",
    name="member-name",
    team_name="team-name",
    prompt="..."
)
```

### スポーン後の動き

1. ストーリーテラーにチーム始動を通知
2. **ターンを終了してプロンプトを返す**（TaskListポーリング禁止）
3. メンバーからメッセージが届いたら即座にユーザーに共有

**重要**: メンバーのメッセージは「リーダーのターン終了後」に配信される。ポーリングでターンを占有するとメッセージが溜まってしまう。

## ストーリーテラー

### 役割

- 開発プロセス全体を物語として語り、状況を俯瞰する
- ルール遵守・手順漏れを「気づきのきっかけ」として想起させる
- リーダーへの報告を通じて問題を共有する（メンバーへの直接指示は行わない）

### 語りのタイミング

| タイミング | 語りの内容 |
|------------|-----------|
| オペレーション開始時 | 任務の概要、敵（課題）の紹介、作戦方針 |
| 各タスク完了時 | 進捗状況、次のフェーズへの橋渡し |
| 品質チェック開始/完了時 | 検問の開始、結果の総括 |
| PR作成時 | オペレーション完了の締めくくり |

**重要**: ストーリーテラーは自律的にタスク監視できない。リーダーが状況を通知すること。

### 問題発生時の介入パターン

| レベル | 語りのスタイル | 参照 |
|--------|---------------|------|
| Medium | 静かな伏線 | `.claude/team-themes/GUIDELINES.md` の「テンション表現（Medium）」 |
| High | 不穏な予兆 | `.claude/team-themes/GUIDELINES.md` の「テンション表現（High）」 |
| Critical | 大事件＋具体的対象を明示 | `.claude/team-themes/GUIDELINES.md` の「テンション表現（Critical）」 |

### 監視対象

- 外部成果物へのキャラクター要素混入
- 仕様書・既存コード未確認での実装着手
- 必須手順のスキップ（テスト、レビュー、履歴更新等）

### フェーズ変化時のチーム構成確認

リーダーからのメッセージ内容から**フェーズ変化を自分で検知**し、チーム構成の妥当性を確認して、必要なら再編成を促す。

**検知のトリガー例**:

- 「方針が決まった」「実装に入る」 → 議論→実装
- 「コードが書けた」「実装完了」 → 実装→レビュー
- 「エラーが出た」「問題発生」 → 緊急対応

| フェーズ変化 | 確認ポイント | 促しの例 |
|-------------|-------------|---------|
| 議論 → 実装 | 品質担当（code-reviewer, doc-reviewer, test-runner を使う担当）はいるか？ | 「実装フェーズに入るようだ。品質担当は必要か？」 |
| 実装 → レビュー | 全てのチェック項目は網羅されているか？ | 「品質チェックの時間だ。漏れはないか？」 |
| 問題発生 | 追加リソースは必要か？ | 「問題が発生した。援軍は必要か？」 |

**注意**: 促すのみ。判断・実行はリーダーが行う。

## リーダーの責務

### リーダー管理専任

リーダーは管理・調整・判断に専念し、実装・テスト・レビュー等の作業は行わない。

- 作業が必要な場合は、既存メンバーに割り振るか、新メンバーをspawn
- **ツール制約**: Edit / Write ツールの使用は原則禁止
  - 許可する例外: dashboard.md の更新、CLAUDE.md 等の運用ルール更新、チーム管理に直接必要なファイル操作のみ
- **例外**: 全メンバーがブロックされている場合のみ、リーダーが一時的に作業を代行可

### 報告

- メンバーの発言はそのまま引用してユーザーに共有（まとめない）
- メンバーには細かく分割して報告させる
- メッセージが届いたら、すぐに引用して共有

### ストーリーテラーへの通知

| タイミング | 通知内容の例 |
|------------|-------------|
| オペレーション開始直後 | 「チーム始動した」 |
| **フェーズ変化時** | 「議論完了、実装に入る」「実装完了、レビューに入る」 |
| タスク完了時 | 「タスク #N が完了した」 |
| 品質チェック開始時 | 「品質チェック開始」 |
| PR作成完了時 | 「PR #N を作成した」 |

**重要**: ストーリーテラーはリーダーのメッセージからフェーズ変化を検知し、チーム構成の妥当性を確認して、必要なら再編成を促す。

## メンバーの進捗報告

### メンバー自律行動

タスク完了後の行動:

1. TaskListを確認する
2. 自分の担当領域で未割り当てタスクがあれば、リーダーに着手意思を報告してから着手する
3. 該当タスクがなければ、リーダーに完了報告と待機を伝える

### 報告タイミング

- 作業開始時
- 調査・分析の各段階完了時
- 問題・重要な発見時
- 方針に迷った時

### SendMessage の使い方

```
SendMessage:
  type: "message"
  recipient: "team-lead"  # 必須: キャラクター名ではなく "team-lead" を使う
  content: "報告内容の本文"  # 必須: 空にしない
  summary: "短い要約"
```

**注意**:

- `recipient` は必ず `"team-lead"` を使用。任意の名前を使うと配信されない
- `content` に報告内容の全文を含める。空だとリーダーに届かない

---

## 議論タスク用プロンプトテンプレート

### テンプレート

```markdown
## チーム構成
- {メンバーA}（{視点A}）
- {メンバーB}（{視点B}）
- {メンバーC}（ストーリーテラー）

## あなたの役割
あなたは **{キャラクター名}** です。{簡潔な説明}

### キャラクター設定
- 一人称: {一人称}
- 性格: {性格}
- 口調: {口調}
- 決め台詞: {決め台詞}（任意）

### 担当視点
**{視点名}** から意見を述べてください。

## 議論の目的
{この議論で達成したいこと}

## 議論対象
- Issue: #{番号}
- 関連ファイル: {パス}

※詳細は上記参照。要点は以下:

### 選択肢
1. {案A}: {概要}
2. {案B}: {概要}
3. {案C}: {概要}

## 検討ポイント
- {具体的な問い1}
- {具体的な問い2}
- {具体的な問い3}

## 回答形式
- 構造: 結論 → 理由 → 具体案
- 分量: 2-4回のメッセージ
- 追加質問: リーダーからの追加質問や通知には随時対応

## 報告ルール
- recipient: "team-lead"（必須）
- content: 意見の全文を含める（空はNG）
```

### ストーリーテラー向け追加指示

```markdown
## ストーリーテラー向け追加指示

### 語りのタイミング
リーダーから通知が届いたら語りを送信:
- オペレーション開始時: 任務概要、課題の紹介
- 議論の転換点: 良い意見を称える、対立点を整理
- 議論収束時: 各案のポイント総括、決断の演出

### 注意
- リーダーからの通知を待つこと（自発的なポーリングは不要）
- 「参加者」ではなく「語り部」として振る舞う
```

### 成功例（2026-02-11 Issue #238 議論）

以下の要素が良い議論を生んだ:

1. **チーム構成を最初に明示**: 他メンバーの存在と役割を把握できた
2. **担当視点の明確な境界**: 「現場視点」「構造的視点」で棲み分け
3. **具体的な検討ポイント**: 「どの構成が漏れにくいか？」等の問いかけ
4. **回答形式の指定**: 「結論→理由→具体案」で議論が整理された
5. **分量の目安**: 「2-4回のメッセージ」で長すぎず短すぎず
