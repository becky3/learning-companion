# コードレビュワーサブエージェント

## 概要

Claude Code が生成・変更したコードに対して、コミット前にセルフレビューを行うClaude Codeサブエージェント。テスト名と実装内容の不一致、エラーハンドリングの欠陥、バリデーション漏れ、競合状態などの問題を事前に検出し、PRレビューでの手戻りを削減する。

## 背景

AI Assistantプロジェクトでは、Claude Code が生成したコードがPR作成後に 自動レビューツールで初めて問題を指摘されるケースが頻発している。

PR #140（Bot重複起動検知）で検出された典型的な問題:

- テスト名と実際のテスト内容の不一致（`pgrep` vs `wmic`）
- docstring の typo
- `except ... pass` のログ欠落（silent failure）
- バリデーション漏れ（PID <= 0）
- TOCTOU 競合状態の未考慮
- `try/finally` スコープ不足（初期化失敗時のクリーンアップ漏れ）

これらはPR作成前のセルフレビューで検出可能な問題であり、コード品質向上と開発効率化のためにレビュー専門のサブエージェントを導入する。

## ユーザーストーリー

- 開発者として、実装完了後に `code-reviewerサブエージェント` でセルフレビューを受け、PRレビューでの指摘を事前に防ぎたい
- 開発者として、特定のファイルに対してコードレビューを実行し、問題点を把握したい
- 開発者として、変更差分（git diff）に対してレビューを実行し、変更箇所に絞った指摘を受けたい

## 技術仕様

### サブエージェント定義

**ファイル**: `.claude/agents/code-reviewer.md`

**メタデータ:**

```yaml
name: code-reviewer
description: コミット前のセルフコードレビュー専門家。テスト名と実装の整合性、エラーハンドリング、バリデーション、競合状態、リソース管理などの問題を検出する。
tools: Read, Grep, Glob, Bash
permissionMode: default
```

**設計方針:** エージェント定義ファイルにはレビュー観点の詳細を記載しない。エージェントはレビュー開始時に本仕様書（`docs/specs/code-review-agent.md`）を読み、レビュー基準を取得する。これにより、本仕様書が Single Source of Truth となり、基準の二重管理を防ぐ。エージェント定義には役割・プロセス概要・出力フォーマットのみを記載する。

### レビュー観点

#### 1. テスト名・docstring と実装内容の整合性

- テスト関数名が実際にテストしている内容と一致するか
- docstring の説明が実装の振る舞いと合致するか
- AC番号とテスト内容の対応が正しいか（`test_ac{N}_...` 形式）
- テスト内でモック・スタブされている対象が、テスト名が示す機能と一致するか

#### 2. エラーハンドリングの網羅性

- `except ... pass` や `except: pass` による silent failure がないか
- 例外キャッチ時に適切なログ出力があるか
- 例外の粒度が適切か（broad exception の検出）
- エラー時のリソースクリーンアップが行われているか

#### 3. バリデーション漏れ

- 外部入力（ユーザー入力、API応答、設定値）のバリデーションが行われているか
- 境界値チェック（0, 負数, 空文字列, None）が適切か
- 型チェックや範囲チェックの漏れがないか

#### 4. 競合状態・TOCTOU の検出

- ファイル存在チェック後のファイル操作で TOCTOU が発生しないか
- 共有リソースへの同時アクセスで競合が起こらないか
- ロック機構の適切な使用がされているか

#### 5. リソース管理

- `try/finally` のスコープが適切か（初期化失敗時のクリーンアップ漏れ）
- ファイルハンドル、DB接続、ネットワーク接続の確実なクローズ
- コンテキストマネージャ（`with` 文）の適切な使用

#### 6. コード品質

- 未使用の import がないか
- typo の検出（変数名、文字列リテラル、コメント）
- デッドコード（到達不能コード）の検出
- マジックナンバーの使用

#### 7. セキュリティ

- コマンドインジェクションの可能性（`subprocess` 呼び出し時のシェル展開）
- パストラバーサルの可能性（ユーザー入力をパスに使用）
- 機密情報のハードコーディング（API キー、パスワード）

#### 8. プロジェクト規約との整合性

- サービスクラスの docstring に仕様書パス（`仕様: docs/specs/...`）が記載されているか
- テスト名が `test_ac{N}_...` 形式で AC と対応しているか
- 仕様書の AC に記載された振る舞いがテストでカバーされているか

#### 9. フォールバック/暗黙のデフォルト値パターンの検出

関数・メソッドが外部設定（settings, env）にフォールバックして値を取得するパターンや、CLI/テストツールで暗黙のデフォルト値を設定するパターンを検出する。

**9a. settings フォールバックの禁止**

- 関数の引数が `None` の場合に settings や環境変数から値を取得するパターンがないか
- 値の出所が呼び出し元で明示されているか

```python
# NG: settings フォールバック
def create_service(chunk_size: int | None = None):
    settings = get_settings()
    actual = chunk_size if chunk_size is not None else settings.rag_chunk_size

# OK: 呼び出し元が値を決定
def create_service(*, chunk_size: int):
    ...
```

**9b. 暗黙のデフォルト値の禁止（CLI/テストツール）**

- argparse の `default` で具体値を設定していないか（`required=True` にすべき）
- 値の出所が隠蔽されていないか

```python
# NG: 暗黙のデフォルト値
parser.add_argument("--chunk-size", type=int, default=200)

# OK: 呼び出し元に明示させる
parser.add_argument("--chunk-size", type=int, required=True)
```

**適用範囲:**

| 対象 | 適用レベル | 理由 |
|------|-----------|------|
| 評価CLI・テストツール・スクリプト | **厳密適用** | 環境非依存であるべき |
| 本番コード（`main.py`）での settings 参照 | **許容** | 本番は設定ファイルから読むのが正当 |
| 基盤設定（DB接続先等のインフラ関連） | **許容** | データ処理パラメータとは性質が異なる |

### 処理フロー

1. **レビュー対象の特定**
   - 引数でファイルパスが指定されていればそれをレビュー
   - 変更差分のレビューが依頼されていれば `git diff` の変更差分をレビュー
   - 未指定なら `git diff --cached`（ステージ済み変更）をレビュー対象とし、ステージ済み変更がなければ `git diff`（未ステージ変更）をレビュー

2. **仕様書の参照**
   - 本仕様書（`docs/specs/code-review-agent.md`）を読み、レビュー基準を取得
   - レビュー対象ファイルに対応する仕様書があれば、`docs/specs/` から該当仕様書を読み込み

3. **コードの読み込みと分析**
   - レビュー対象ファイルを読み込み
   - テストファイルの場合、テスト対象の実装ファイルも読み込み
   - 実装ファイルの場合、対応するテストファイルも確認

4. **レビュー観点ごとの検査**
   - 上記のレビュー観点（1〜9）に基づき、問題を検出
   - 各問題に対して優先度を判定（Critical / Warning / Suggestion）

5. **レポート生成**
   - ファイルごとに検出した問題を優先度別に整理
   - 各問題に対して具体的な改善案を提示（ファイルパス・行番号付き）

### 優先度の判定基準

| 優先度 | 基準 | 例 |
|--------|------|-----|
| **Critical** | バグ・セキュリティ問題・データ損失リスク | silent failure、バリデーション漏れ、TOCTOU、コマンドインジェクション |
| **Warning** | コード品質・保守性に影響する問題 | テスト名と内容の不一致、docstring の不正確さ、broad exception |
| **Suggestion** | 改善が望ましいが緊急性は低い | マジックナンバー、コメント追加の推奨、命名の改善 |

### 入出力仕様

#### 入力

ユーザーが Claude Code で以下のように呼び出す:

**パターン1: 特定ファイルのレビュー**

```
code-reviewerサブエージェントで src/services/chat_service.py をレビューしてください
```

**パターン2: 変更差分のレビュー**

```
code-reviewerサブエージェントで変更差分をレビューしてください
```

**パターン3: 複数ファイルのレビュー**

```
code-reviewerサブエージェントで src/services/ と tests/ をレビューしてください
```

#### 出力

以下の形式でレビュー結果を返す:

**問題検出時:**

```markdown
### コードレビュー結果

#### ファイル: tests/test_bot_manager.py

**Critical（修正必須）:**
- [L42] テスト名 `test_ac3_pgrep_detects_running_process` だが、テスト内では `wmic` コマンドをモックしている
  - 改善案: テスト名を `test_ac3_wmic_detects_running_process` に変更するか、テスト内容を `pgrep` ベースに修正

**Warning（修正推奨）:**
- [L78] `except Exception: pass` — 例外を握りつぶしており、障害調査が困難になる
  - 改善案: `except Exception as e: logger.warning("処理名 failed: %s", e)` でログ出力を追加

**Suggestion（改善検討）:**
- [L15] docstring に typo: 「プロセスを監視する」→「プロセスを検知する」
  - 改善案: docstring を実装内容に合わせて修正

---

#### 📊 総評

- Critical: 1件、Warning: 1件、Suggestion: 1件
- テスト名と実装内容の不一致が最も影響が大きい。修正優先度はCriticalから順に対応を推奨
```

**問題なしの場合:**

```markdown
### コードレビュー結果 ✅

レビュー対象のコードに問題は検出されませんでした。

- レビュー対象: 3ファイル
- レビュー観点: 9カテゴリ
```

## 使用LLMプロバイダー

**Claude Code** — サブエージェントとして使用

**選定理由:**

- コードレビューは、実装の意図理解、バグパターンの検出、セキュリティ分析など、高度な推論力が必要なタスク
- テストと実装の整合性確認や競合状態の検出には、コードの文脈理解と論理的分析が重要

## 受け入れ条件

### 基本機能

- [ ] AC1: `.claude/agents/code-reviewer.md` が正しく作成され、Claude Codeから呼び出せる
- [ ] AC2: 特定ファイル指定時に該当ファイルのみレビューする
- [ ] AC3: ファイル未指定時に git diff の変更差分をレビューする
- [ ] AC4: テストファイルのレビュー時に対応する実装ファイルも参照する

### レビュー観点

- [ ] AC5: テスト名と実際のテスト内容の不一致を検出できる
- [ ] AC6: `except ... pass` 等の silent failure を検出できる
- [ ] AC7: バリデーション漏れ（境界値、不正入力）を検出できる
- [ ] AC8: TOCTOU 競合状態を検出できる
- [ ] AC9: `try/finally` スコープ不足を検出できる
- [ ] AC10: 未使用 import / typo を検出できる
- [ ] AC11: セキュリティ上の問題（コマンドインジェクション等）を検出できる
- [ ] AC12: プロジェクト規約（docstring の仕様書パス、テスト名形式）との整合性を確認できる
- [ ] AC13: フォールバック/暗黙のデフォルト値パターン（settings フォールバック、CLI の暗黙デフォルト値）を検出できる

### 出力品質

- [ ] AC14: レビュー結果が優先度別（Critical / Warning / Suggestion）に整理される
- [ ] AC15: 各指摘にファイルパスと行番号が含まれる
- [ ] AC16: 各指摘に具体的な改善案が含まれる
- [ ] AC17: 問題なしの場合、その旨を明確に報告する

### CLAUDE.md 統合

- [ ] AC18: `CLAUDE.md` の「実装完了時の必須手順」にコードレビュー実行ステップが追加される
- [ ] AC19: `CLAUDE.md` のサブエージェント一覧に code-reviewer が追加される

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `.claude/agents/code-reviewer.md` | サブエージェント定義（役割・プロセス概要・出力フォーマット） |
| `CLAUDE.md` | 実装完了時の必須手順、サブエージェント一覧 |
| `src/**/*.py` | レビュー対象のソースコード |
| `tests/**/*.py` | レビュー対象のテストコード |
| `docs/specs/*.md` | レビュー時に参照する仕様書 |

## テスト方針

Claude Codeサブエージェントは実行時テストが中心となるため、以下を手動で確認:

### 基本動作テスト

- [ ] 特定ファイルを指定してレビューを実行し、適切な指摘が得られるか
- [ ] git diff の変更差分に対してレビューを実行できるか
- [ ] テストファイルのレビュー時に、テスト対象の実装ファイルも参照されるか

### レビュー観点の検証

- [ ] テスト名と内容が不一致のテストファイルを用意し、検出されるか
- [ ] `except: pass` を含むコードを用意し、silent failure として検出されるか
- [ ] バリデーションのないコード（PID <= 0 チェック漏れ等）を用意し、検出されるか
- [ ] TOCTOU パターン（ファイル存在チェック後の操作）を用意し、検出されるか
- [ ] `try/finally` スコープ不足のコードを用意し、検出されるか

### 誤検出チェック

- [ ] 正しく書かれたコードに対して誤った指摘（過検出）が出ないか
- [ ] プロジェクト規約に準拠したコードに対して規約違反を誤検出しないか

### レビュー品質

- [ ] 指摘が具体的でファイルパス・行番号を含むか
- [ ] 各指摘に実用的な改善案が含まれるか
- [ ] 優先度（Critical / Warning / Suggestion）の判定が妥当か
- [ ] 総評が開発者にとって有益な情報を含むか

## 他サブエージェントとの連携

- **test-runner**: test-runner が「テストが通ること」を検証するのに対し、code-reviewer は「コードの品質・正確性」を検証する。両者は補完関係にある
- **doc-reviewer**: doc-reviewer がドキュメントの品質を検証するのに対し、code-reviewer はコードの品質を検証する。コード内の docstring は code-reviewer、仕様書は doc-reviewer の管轄

**推奨ワークフロー:**

1. 実装完了
2. `test-runner サブエージェント` でテスト実行（機能の正しさを確認）
3. `code-reviewer サブエージェント` でコードレビュー（品質・潜在的問題を確認）
4. `doc-reviewer サブエージェント` でドキュメントレビュー（仕様書の品質を確認）
5. 問題なければコミット・PR作成

## 拡張性

将来的に以下の機能を追加可能:

- **自動修正モード**: 検出した問題を自動で修正する
- **カスタムルール**: プロジェクト固有のレビュールールを追加
- **CI/CD統合**: PR作成時に自動でコードレビューを実行
- **レビュー履歴**: 過去のレビュー結果を蓄積し、再発パターンを検出
