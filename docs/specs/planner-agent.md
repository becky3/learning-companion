# 実装計画サブエージェント

## 概要

GitHub Issueやユーザーからの提案を元に、仕様駆動開発の観点で詳細な実装計画を立案するClaude Codeサブエージェント。仕様書テンプレートに準拠した技術仕様、受け入れ条件、テスト方針を含む計画書を生成する。

## 背景

Learning Companionプロジェクトは仕様駆動開発を採用しており、実装前に `docs/specs/` に仕様書を作成する必要がある。しかし、仕様書の作成には以下の課題がある:

- **テンプレート遵守**: 必須セクション（概要、背景、ユーザーストーリー、技術仕様、受け入れ条件など）を漏れなく含める必要がある
- **受け入れ条件の品質**: 具体的で検証可能なACを定義するには経験が必要
- **既存コードとの整合性**: プロジェクトの既存実装パターン、コーディング規約、LLM使い分けルールを踏まえる必要がある
- **時間コスト**: ゼロから仕様書を書くには時間がかかる

これらを解消するため、Issue や提案内容を分析し、プロジェクトの規約に準拠した実装計画を自動生成するサブエージェントを実装する。

## ユーザーストーリー

- 開発者として、新機能のIssueを作成した後に `plannerサブエージェント` で実装計画を生成し、仕様書のドラフトを作成したい
- 開発者として、提案内容から技術仕様・受け入れ条件・テスト方針を含む詳細計画を得て、実装の見通しを立てたい
- 開発者として、既存の仕様書テンプレートと整合性のある計画書を自動生成し、レビューの手戻りを減らしたい
- 開発者として、計画書をベースに実装を進め、仕様駆動開発のフローを効率化したい

## 技術仕様

### サブエージェント定義

**ファイル**: `.claude/agents/planner.md`

**メタデータ:**
```yaml
name: planner
description: Issue・提案内容から実装計画を立案する専門家。仕様書テンプレートに基づき、技術仕様・受け入れ条件・テスト方針を含む詳細な実装計画を作成する。
tools: Read, Grep, Glob, Bash
model: sonnet
permissionMode: default
```

### 計画プロセス・出力フォーマット・禁止事項

エージェント定義 (`.claude/agents/planner.md`) に詳細を記載。主な構成:

- **計画プロセス**: 要件分析 → コードベース調査 → 技術仕様設計 → AC定義 → テスト・リスク評価
- **出力フォーマット**: 全8セクション必須のテンプレート（概要・前提確認 / 背景・ユーザーストーリー / 技術仕様 / LLMプロバイダー / 受け入れ条件 / 関連ファイル / テスト方針 / 実装順序・リスク）
- **出力前チェックリスト**: Issue裏取り、権限、既存パターン、トークン判別、リレーションシップ、AC番号の6項目
- **禁止事項**: 関数名・クラス名・コードスニペット・具体的メッセージ文言・正規表現パターンの記載を禁止

### 入出力仕様

#### 入力

ユーザーがClaude Codeで以下のように呼び出す:

**パターン1: Issue番号を指定**
```
plannerサブエージェントを使用してIssue #42 の実装計画を立ててください
```

**パターン2: 提案内容を直接入力**
```
plannerサブエージェントで「Slackメッセージの反応機能」の実装計画を作成してください
```

**パターン3: 既存の提案文書を参照**
```
plannerサブエージェントで docs/proposals/reaction-feature.md の実装計画を立ててください
```

#### 出力

エージェント定義の出力フォーマット（全8セクション）に準拠した計画書を生成する。計画書は `docs/specs/` に保存するか、ユーザーに提示して承認を得る。

## 使用LLMプロバイダー

**Claude Code (Sonnet モデル)** — サブエージェントとして使用

**選定理由:**
- 実装計画の立案は、要件分析、既存コード理解、技術設計、リスク評価など、高度な推論力が必要なタスク
- サブエージェント定義のメタデータで `model: sonnet` を指定し、Sonnetモデルで実行
- 仕様駆動開発の観点からの計画には、文脈理解と論理的な設計能力が重要

## 受け入れ条件

### 基本機能

- [ ] AC1: `.claude/agents/planner.md` が正しく作成され、Claude Codeから呼び出せる
- [ ] AC2: Issue番号を指定した場合、該当Issueの内容を読み込んで計画を立案できる
- [ ] AC3: 提案内容を直接入力した場合、その内容をもとに計画を立案できる

### テンプレート遵守

- [ ] AC4: 計画書が全8セクション（概要・前提確認 / 背景・ストーリー / 技術仕様 / LLM / AC / 関連ファイル / テスト / 実装順序・リスク）を含む
- [ ] AC5: 受け入れ条件が `- [ ]` 形式で、具体的・検証可能である
- [ ] AC6: 既存ACのサブ機能を計画する場合、AC番号が `AC{親番号}.{連番}` 形式を使用する
- [ ] AC7: テスト名が `test_ac{N}_...` 形式でAC番号と対応する

### チェックリスト項目の反映

- [ ] AC8: Issue記載の前提（「実装済み」等）と実コードの差異が前提確認に記載される
- [ ] AC9: 操作の権限が技術仕様の「権限」に記載される
- [ ] AC10: 既存コードの処理パターンが「踏襲する既存パターン」に記載される
- [ ] AC11: コマンド型入力がある場合、トークン判別ルールが入出力仕様に記載される
- [ ] AC12: データモデルの変更がある場合、リレーションシップへの影響が記載される

### 禁止事項の遵守

- [ ] AC13: 計画書に関数名・クラス名・コードスニペットが含まれない
- [ ] AC14: 具体的なメッセージ文言ではなく、意図レベルで記述されている

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `.claude/agents/planner.md` | サブエージェント定義（計画プロセスとプロンプト） |
| `docs/specs/overview.md` | 仕様書テンプレート定義（出力フォーマットの参照元） |
| `docs/specs/*.md` | 既存仕様書（類似機能の参照、パターンの把握） |
| `CLAUDE.md` | コーディング規約、プロジェクト構造、LLM使い分けルール |

## テスト方針

Claude Codeサブエージェントは実行時テストが中心となるため、以下を手動で確認:

### 基本動作テスト

- [ ] 新機能のIssueを入力として計画書を生成し、必須セクションが揃っているか
- [ ] 計画書の受け入れ条件が具体的で検証可能か
- [ ] 関連ファイルのリストに役割が記載されているか
- [ ] LLMプロバイダーの選定理由がプロジェクトのルールに沿っているか

### 既存コード調査の検証

- [ ] 類似機能がある場合、既存の仕様書を参照して一貫性のある計画を立てられるか
- [ ] `src/` の既存実装パターンを踏まえた関連ファイルのリストが生成されるか
- [ ] テスト名規約（`test_ac{N}_...`）に対応したテスト方針が含まれるか

### チェックリスト・禁止事項の検証

- [ ] 出力前チェックリスト6項目が全て計画書に反映されているか（AC8〜AC12）
- [ ] 禁止事項に該当する記述（関数名、コードスニペット等）が含まれていないか（AC13〜AC14）

### 品質チェック

- [ ] 計画書が実装者にとって理解しやすく、実装の見通しが立つか
- [ ] 過度に詳細化せず、実装者が自律的に判断できる余地を残しているか
- [ ] 技術的リスクと対策が現実的で実用的か

### レビュー連携

- [ ] 生成した計画書を `doc-reviewerサブエージェント` でレビューし、品質基準を満たしているか確認できる

## 拡張性

将来的に以下の機能を追加可能:

- **自動ファイル生成**: 計画書を `docs/specs/f{N}-{feature}.md` として自動保存
- **Issue連携**: GitHub Issue に計画書を自動でコメント
- **インタラクティブモード**: 計画プロセスの各ステップで開発者に確認・承認を求める
- **複数案の生成**: 異なるアプローチの計画を複数生成し、比較検討を支援
- **見積もり機能**: 実装工数の概算を提示（ただし時間見積もりは不確実性が高いため慎重に）
- **ドラフトコード生成**: 計画書をもとにスケルトンコード（クラス・関数の雛形）を生成

## プランナーの責務の範囲

**計画するもの:**
- 機能仕様の詳細化
- 技術設計の方針
- 受け入れ条件の定義
- テスト戦略
- 実装の優先順位
- リスク評価

**計画しないもの:**
- 具体的なコード実装（エージェント定義の「禁止事項」テーブル参照）
- 実装スケジュール（時間見積もり）
- 人員アサイン

計画は実装者が自律的に判断できる範囲を残し、過度に詳細化しない。

## 他サブエージェントとの連携

- **doc-reviewer**: planner で生成した計画書を doc-reviewer でレビューし、品質を向上
- **test-runner**: 計画書の受け入れ条件に基づいてテストを実装した後、test-runner で実行

**推奨ワークフロー:**
1. `plannerサブエージェント` で実装計画を生成
2. `doc-reviewerサブエージェント` で計画書をレビュー
3. レビュー結果をもとに計画書を修正
4. 計画書に基づいて実装
5. `test-runnerサブエージェント` でテストを実行
6. テスト結果をもとに実装を調整
