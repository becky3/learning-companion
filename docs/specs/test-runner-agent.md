# テストランナーサブエージェント

## 概要

pytest によるテスト実行およびコード品質チェック（lint・型チェック）を自動化するClaude Codeサブエージェント。テストの実行、失敗時の分析、修正提案、再実行までを一貫して行い、開発者がテストおよびコード品質チェックに関する手動作業を最小化する。

## 背景

AI Assistantプロジェクトは仕様駆動開発を採用しており、各機能の受け入れ条件（AC）に対応するテストが `tests/` ディレクトリに配置されている。また、コーディング規約として `ruff` によるlintと `mypy` による型チェックの使用が `CLAUDE.md` で規定されている。

テスト実行およびコード品質チェックは開発フローの重要な部分だが、以下の課題がある:

- テスト実行コマンドの記憶・入力が煩雑
- lint・型チェックを別途手動で実行する必要があり、CI的なチェックが不完全
- テスト失敗時のエラー分析に時間がかかる
- 修正後の再実行を忘れがち
- カバレッジ確認やレポート生成が手作業

これらを解消するため、テスト実行から分析・修正提案・再実行までを自動化し、さらにlintと型チェックも統合したサブエージェントを実装する。

## ユーザーストーリー

- 開発者として、実装完了後に `test-runnerサブエージェント` でテストを実行し、品質を確認したい
- 開発者として、テスト・lint・型チェックを一度に実行してコード品質を包括的に確認したい
- 開発者として、テスト失敗やlint違反・型エラー時に自動でエラー分析と修正提案を受けたい
- 開発者として、特定のテストファイルやテストケースのみを実行したい
- 開発者として、カバレッジレポートを自動生成してテストの網羅性を把握したい

## 技術仕様

### サブエージェント定義

**ファイル**: `.claude/agents/test-runner.md`

**メタデータ:**
```yaml
name: test-runner
description: pytest による自動テスト実行・分析・修正提案を行う専門家。テスト失敗の原因特定と解決策提示、再実行までを一貫してサポート。
tools: Bash, Read, Grep, Glob, Edit
permissionMode: default
```

※ `model` フィールドは（doc-reviewer 等と同様に）本サブエージェント定義では省略し、デフォルトモデルを使用する。

### テスト実行パターン

以下の実行パターンをサポートする。具体的なコマンド例はサブエージェント定義（`.claude/agents/test-runner.md`）を参照。

| パターン | 説明 |
|---------|------|
| 全テスト実行 | すべてのテストケースを実行 |
| 特定ファイル実行 | 指定されたテストファイルのみ実行 |
| 特定テストケース実行 | 関数名やパターンでテストを絞り込み実行 |
| 詳細出力モード | 失敗時の詳細情報を表示 |
| カバレッジ測定 | pytest-cov によるカバレッジレポート生成（dev 依存に `pytest-cov>=5.0,<6` が必要） |
| lint (ruff) 実行 | コードスタイル・潜在的バグのチェック（`src/` および `tests/` を対象） |
| 型チェック (mypy) 実行 | 静的型解析とstrict modeでの型チェック（`src/` を対象） |
| 差分テスト実行 | 変更ファイルに関連するテストのみを実行（高速化） |

### 実行モード

| モード | 用途 | テスト範囲 | 目標時間 |
|--------|------|-----------|---------|
| `full` | 全テスト実行（デフォルト） | 全テスト | 30秒 |
| `diff` | 変更ファイル関連のみ | 変更に関連するテストのみ | 10秒以下 |

**`full` モードを使用するケース:**
- 明示的に「全テスト」「fullテスト」を指定された場合
- モード未指定の場合（デフォルト・後方互換性維持）
- リリース前の最終確認

**`diff` モードを使用するケース:**
- 明示的に「差分テスト」「diffテスト」を指定された場合
- PRレビュー指摘対応後の確認
- 特定機能の修正後の確認

### 差分テスト処理フロー

1. **変更ファイルの取得**（以下の優先順位で試行）
   - 作業ツリーの変更（未ステージ・ステージング両方）: `git diff --name-only`
   - ベースブランチ（`origin/main`）との比較: `base=$(git merge-base HEAD origin/main) && git diff --name-only "$base" HEAD`
   - ステージング済みの変更のみ: `git diff --cached --name-only`
   - 直近コミットの差分（フォールバック）: `git show --name-only --format="" HEAD`
   - すべて失敗した場合は `full` モードにフォールバック
   - **変更ファイル0件の場合**: 明示的なテスト対象指定がなければ `full` モードにフォールバック

2. **変更ファイルの分類**
   - `src/**/*.py` → 対応テストを推定
   - `tests/*.py` → そのまま実行対象に追加
   - `pyproject.toml`, `conftest.py` → 全テスト実行にフォールバック（設定変更とみなし安全側に倒す）
   - その他（`docs/**`, `CLAUDE.md`, `*.md` 等） → テスト対象外（diffモードではテスト0件で正常終了、lint・型チェックもスキップ、fullへのフォールバックは行わない）

3. **テストファイルの推定（マッピングルール）**

   | ソースファイルパターン | 対応テストファイル |
   |----------------------|-------------------|
   | `src/services/{name}.py` | `tests/test_{name}.py` または `tests/test_{name}_service.py` |
   | `src/llm/*.py` | `tests/test_llm.py` |
   | `src/config/*.py` | `tests/test_config.py` |
   | `src/db/*.py` | `tests/test_db.py` |
   | `src/slack/*.py` | `tests/test_slack_handlers.py`, `tests/test_slack_feed_handlers.py` |
   | `src/scheduler/*.py` | `tests/test_scheduler.py` |
   | `src/mcp_bridge/*.py` | `tests/test_mcp_client_manager.py` |
   | `src/process_guard.py` | `tests/test_process_guard.py` |

4. **推定テストの実行**
   - `uv run pytest {推定されたテストファイル}`

5. **lint・型チェック（変更されたPythonファイルのみ）**
   - `uv run ruff check {変更された *.py ファイル}`（非Pythonファイルは除外）
   - `uv run mypy {変更された src/**/*.py ファイル}`

6. **結果レポート生成**
   - fullモードと同じ形式でレポートを生成

**フォールバック条件:**
以下の場合は全テスト実行にフォールバック:
- `pyproject.toml` が変更された場合
- `conftest.py` が変更された場合
- マッピングで対応テストが見つからなかった場合
- `src/__init__.py` など共通モジュールが変更された場合

### 呼び出し例

```
# フルテスト（デフォルト・従来動作）
test-runnerサブエージェントで全テストを実行してください

# 差分テスト
test-runnerサブエージェントで差分テストを実行してください
```

### 処理フロー

以下は主に `full` モードの処理フローを示す。`diff` モードの処理フローは「差分テスト処理フロー」セクションを参照。

0. **実行モードの判定**
   - 「差分テスト」「diffテスト」キーワードがあれば `diff` モード → 「差分テスト処理フロー」へ
   - それ以外は `full` モード → 以下のフローを実行

1. **テスト対象の特定**
   - 引数でファイルパスやテスト名が指定されていればそれを実行
   - 未指定なら全テストを実行

2. **テスト実行**
   - `uv run pytest` でテストを実行
   - 出力を解析してテスト結果を取得

3. **lint (ruff) 実行**
   - `uv run ruff check src/ tests/` でコードスタイル・潜在的バグをチェック
   - 出力を解析して違反箇所を取得
   - ruffが利用できない場合やエラーの場合は適切にエラーを報告

4. **型チェック (mypy) 実行**
   - `uv run mypy src/` で静的型解析を実行
   - 出力を解析して型エラーを取得
   - mypyが利用できない場合やエラーの場合は適切にエラーを報告

5. **結果の分析**
   - **pytest 成功時**: 実行件数、実行時間を報告
   - **pytest 失敗時**: 失敗したテストケース、エラーメッセージ、スタックトレースを抽出
   - **ruff 違反あり時**: 違反ファイル、ルールコード、違反箇所を抽出
   - **mypy エラーあり時**: 型エラーファイル、エラー種別、エラー箇所を抽出

6. **失敗時の詳細調査**
   - 失敗したテストファイルとテスト対象コードを読み込み
   - エラーの原因を特定（ロジックバグ、型エラー、アサーション失敗など）
   - 修正案を提示

7. **lint・型エラーの詳細調査**
   - ruff違反箇所のコードを読み込み
   - 違反理由と推奨される修正方法を分析
   - mypy型エラー箇所のコードを読み込み
   - 型エラーの原因と適切な型アノテーションを分析

8. **修正適用（オプション）**
   - ユーザーが承認した場合、修正を適用
   - 修正後に再度テスト・lint・型チェックを実行して確認

9. **レポート生成**
   - テスト・lint・型チェック結果の統合サマリー
   - 失敗した場合は原因と修正案
   - カバレッジ情報（要求された場合）

**注**: pytest・ruff・mypyのいずれかが失敗してもプロセスを中断せず、すべてのチェックを実行して統合レポートを生成する。

### 入出力仕様

#### 入力

ユーザーがClaude Codeで以下のように呼び出す:

```
test-runnerサブエージェントで全テストを実行してください
```

または:

```
test-runnerサブエージェントで tests/test_feed_collector.py を実行してください
```

または:

```
test-runnerサブエージェントでカバレッジを測定してください
```

#### 出力

**全て成功時:**
```markdown
### コード品質チェック結果 ✅

#### pytest
- **実行件数**: 35 passed
- **実行時間**: 2.45s
- **カバレッジ**: 92% (要求された場合)

#### ruff (lint)
- **違反**: なし

#### mypy (型チェック)
- **型エラー**: なし

すべてのチェックが成功しました。
```

**pytest 失敗時:**
```markdown
### コード品質チェック結果 ❌

#### pytest
- **成功**: {N} passed
- **失敗**: {M} failed
- **実行時間**: {X.XX}s

##### 失敗したテスト

**{番号}. {テストファイル}::{テストケース名}**

**エラー内容:** エラーメッセージの引用
**原因:** エラーの根本原因の分析
**修正案:** ファイルパス・行番号付きの具体的な修正コード

---

#### ruff (lint)
- **違反**: なし (または違反がある場合は詳細)

#### mypy (型チェック)
- **型エラー**: なし (または型エラーがある場合は詳細)

---

#### 次のステップ

修正を適用するかユーザーに確認
```

**ruff 違反あり時:**
```markdown
### コード品質チェック結果 ❌

#### pytest
- すべてのテストが成功 (または失敗がある場合は詳細)

#### ruff (lint)
- **違反**: {N}件

##### 違反箇所

**{番号}. {ファイルパス}:{行番号} [{ルールコード}]**

**違反内容:** 違反メッセージの引用
**原因:** 違反理由の説明
**修正案:** ファイルパス・行番号付きの具体的な修正コード

---

#### mypy (型チェック)
- **型エラー**: なし (または型エラーがある場合は詳細)

---

#### 次のステップ

修正を適用するかユーザーに確認
```

**mypy 型エラーあり時:**
```markdown
### コード品質チェック結果 ❌

#### pytest
- すべてのテストが成功 (または失敗がある場合は詳細)

#### ruff (lint)
- **違反**: なし (または違反がある場合は詳細)

#### mypy (型チェック)
- **型エラー**: {N}件

##### 型エラー箇所

**{番号}. {ファイルパス}:{行番号}**

**エラー内容:** 型エラーメッセージの引用
**原因:** 型エラーの説明
**修正案:** ファイルパス・行番号付きの具体的な修正コード（型アノテーション付き）

---

#### 次のステップ

修正を適用するかユーザーに確認
```

> **注**: 各失敗時レポートの詳細なフォーマットとサンプルはサブエージェント定義（`.claude/agents/test-runner.md`）を参照。

## 使用LLMプロバイダー

**Claude Code** — サブエージェントとして使用

**選定理由:**
- テスト実行、エラー分析、修正提案は、コードの文脈理解と論理的推論が必要
- サブエージェント定義では `model` フィールドを省略し、デフォルトモデルを使用
- pytestの出力解析、スタックトレースの読解、コード修正案の生成には高度な推論力が重要

## 受け入れ条件

### 基本機能

- [ ] AC1: `.claude/agents/test-runner.md` が正しく作成され、Claude Codeから呼び出せる
- [ ] AC2: 引数なしで全テストを実行できる
- [ ] AC3: ファイル指定で特定のテストファイルのみ実行できる
- [ ] AC4: テストケース名指定で特定のテストのみ実行できる
- [ ] AC5: テスト成功時に実行件数と実行時間を報告する
- [ ] AC6: テスト失敗時に失敗したテストケースとエラー内容を抽出できる
- [ ] AC7: 失敗したテストの原因を分析し、具体的な修正案を提示できる
- [ ] AC8: カバレッジ測定を実行し、カバレッジ率を報告できる
- [ ] AC9: 修正提案後、ユーザー承認を経て修正を適用し再実行できる
- [ ] AC10: uv環境でのpytest実行に対応している
- [ ] AC11: 呼び出し時にruff (lint) を実行し、違反があれば報告する
- [ ] AC12: 呼び出し時にmypy (型チェック) を実行し、型エラーがあれば報告する
- [ ] AC13: pytest・ruff・mypyの結果を統合したレポートを生成する

### 差分テストモード

- [ ] AC14: 「差分テスト」「diffテスト」キーワードで差分テストモードが起動する
- [ ] AC15: 差分テストモードでは変更ファイルに関連するテストのみが実行される
- [ ] AC16: 差分テストモードの実行時間が10秒以下である（変更ファイル数が少ない場合）
- [ ] AC17: フルテストモードは従来通り動作する
- [ ] AC18: モード未指定時はフルテストがデフォルトで実行される
- [ ] AC19: マッピングで対応テストが見つからない場合、全テストにフォールバックする

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `.claude/agents/test-runner.md` | サブエージェント定義（テスト実行・分析プロンプト） |
| `tests/*.py` | 実行対象のテストファイル |
| `src/*.py` | lint・型チェック対象のソースコード |
| `pyproject.toml` | pytest設定（asyncio_mode等）、ruff・mypy設定 |
| `CLAUDE.md` | テスト実行コマンド、コーディング規約、ruff・mypy使用規定 |

## テスト方針

Claude Codeサブエージェントは実行時テストが中心となるため、以下を手動で確認:

### 基本動作テスト

- [ ] 全テスト実行が正しく動作するか
- [ ] 特定ファイルのテスト実行が正しく動作するか
- [ ] テスト失敗時にエラー分析が適切に行われるか
- [ ] ruff (lint) 実行が正しく動作するか
- [ ] mypy (型チェック) 実行が正しく動作するか
- [ ] pytest・ruff・mypyの統合レポートが正しく生成されるか
- [ ] 修正案が実用的で正確か

### エラーハンドリング

- [ ] 存在しないテストファイルを指定した場合のエラーメッセージ
- [ ] uv環境が未セットアップの場合のエラーメッセージ
- [ ] ruff・mypyが利用できない場合のエラーメッセージ

### レポート品質

- [ ] 成功・失敗の判定が正確か（pytest・ruff・mypy それぞれ）
- [ ] スタックトレースから原因を正しく特定できるか
- [ ] lint違反・型エラーから原因を正しく特定できるか
- [ ] 修正案が具体的でファイルパス・行番号を含むか

### 実行順序と統合レポート

- [ ] pytest → ruff → mypy の順で実行されるか
- [ ] いずれかが失敗してもすべてのチェックが実行されるか
- [ ] 統合レポートにすべてのチェック結果が含まれるか

## 拡張性

将来的に以下の機能を追加可能:

- **自動修正モード**: 失敗したテストを自動で修正（`permissionMode: acceptEdits` のバリアント）
- **CI/CD統合**: PR作成時に自動でテストを実行し、結果をコメント
- **パフォーマンス測定**: テスト実行時間の推移をトラッキング
- **並列実行**: `pytest -n auto` による高速化
- **カスタムレポート**: HTML/JSONフォーマットでのレポート出力
