# エージェントチーム共通仕様

## 概要

リーダー1名とチームメンバー（独立した Claude Code インスタンス）で構成される協調作業システムの共通仕様を定義する。

パターン固有の仕様は [fixed-theme.md](fixed-theme.md) / [mixed-genius.md](mixed-genius.md) を参照。

> **実験的機能**: 将来のアップデートで仕様変更の可能性あり

## 背景

単一エージェントでは対応しにくい複雑なタスク（複数視点でのレビュー、並行開発、競合仮説でのデバッグ等）に対して、チーム編成による並列処理と多角的な検討を可能にする。

### サブエージェントとの違い

| 特性 | サブエージェント | エージェントチーム |
|------|-----------------|-------------------|
| 通信 | リーダーとのみ | メンバー同士も可能 |
| タスク管理 | 個別 | 共有タスクリスト |
| 適したタスク | 単一専門タスク | 複雑な並行作業 |

### 適したユースケース

- 複数視点での調査・レビュー・議論
- 干渉しない並行開発
- 競合仮説でのデバッグ
- フロントエンド/バックエンド/テストの同時開発

## 制約

- トークンコストが増大する（各メンバーが独立コンテキストを持つ）
- 同じファイルを複数メンバーが編集しないようタスク分割すること
- in-process モードではセッション再開不可
- 1セッションにつき1チーム

## チーム構成

### チーム構成パターン

「チームで開発して」で**デフォルトパターン**が使用される。パターンを明示的に指定することも可能。

| パターン | 概要 | 人数 |
|---------|------|------|
| [fixed-theme](fixed-theme.md) | 1作品からキャラを選出するフルチーム | 4〜6人 |
| [mixed-genius](mixed-genius.md) | セッションキャラクター固定 + 知性キャラの軽量チーム | 2〜3人 |

デフォルトパターンは `.claude/team-themes/config.json` で設定する。未設定時は `fixed-theme` がデフォルト。

### キャラクター演出

- リーダーもメンバーもキャラクターとして一貫して振る舞う
- 特に事務的な応答（「待ちます」「確認します」等）でキャラクターが抜けやすいため注意

### 外部成果物のキャラクター排除（厳守）

以下にキャラクター名・キャラクター要素を**絶対に含めない**:

- コミットメッセージ
- PR / Issue の本文・コメント
- ソースコード・テスト・設定ファイル
- 仕様書・ドキュメント

**例外**: 運用ガイド（CLAUDE.md、`docs/specs/agentic/teams/`、`.claude/team-themes/`）は演出ルール記載のため許可。

## 運用ルール

### メッセージング規約

- `recipient` は必ず `"team-lead"` を使用する（キャラクター名ではない）
- `content` に報告内容の全文を含める（空だとリーダーに届かない）

### リーダーの報告ルール

- メンバーの発言はそのまま引用してユーザーに共有する（まとめない）
- メンバーには細かく分割して報告させる
- メッセージが届いたら即座に引用して共有する
- TaskList のポーリング禁止（リーダーはメッセージ駆動で対応する。メンバーの TaskList 利用は「メンバー自律行動」を参照）

### メンバー自律行動

タスク完了後の行動:

1. TaskList を確認する
2. 自分の担当領域で未割り当てタスクがあれば、リーダーに着手意思を報告してから着手する
3. 該当タスクがなければ、リーダーに完了報告と待機を伝える

### チームのライフサイクル

| 操作 | メンバーの状態 |
|------|----------------|
| プロンプトを返す | 待機中（シャットダウンしない） |
| チーム解散 | 終了（ユーザーの明示的指示が必要） |

### delegate モード（リーダー制約）

`delegate` モードはエージェントチーム専用のパーミッションモードで、リーダーをチーム管理ツール（メンバーのスポーン・メッセージング・シャットダウン・タスク管理）のみに制限する。Edit / Write / Bash 等の実装ツールは使用不可となる。

チーム起動後に **Shift+Tab** で `delegate` モードに切り替える。

| パターン | delegate モード | 備考 |
|---------|----------------|------|
| fixed-theme | **推奨**（リーダー管理専任ルール） | リーダーは原則作業禁止 |
| mixed-genius | 任意（リーダーが作業も行うため） | 必要に応じて使用 |

<!-- How追加理由: permissions.allow に Edit/Write が含まれる場合、PreToolUse フックの deny が上書きされるケースが確認されたため、delegate モードを主たる制約手段として明記 -->

`leader-guard.sh`（PreToolUse フック）は delegate モード未使用時のフォールバックとして残す。ただし `permissions.allow` に Edit/Write が含まれている場合、フックの deny が上書きされ機能しない。

`leader-guard.sh` はチームの config.json から `pattern` フィールドを読み取り、パターンに応じてブロック判定する:

| パターン | リーダーの Edit/Write | 理由 |
|---------|----------------------|------|
| fixed-theme | ブロック | リーダー管理専任ルール |
| mixed-genius | 許可 | リーダーも作業を行う |
| 不明（pattern 未設定） | 許可（fail-open） | TeamCreate 直後は pattern 未書き込みのため、ブロックすると書き込み自体が不可能になる |

## 構築手順

### 有効化

`.claude/settings.json` で環境変数 `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS` を有効化し、Claude Code を再起動する。

### パターン情報の記録

TeamCreate 完了後、チームの config.json（`~/.claude/teams/{team-name}/config.json`）に `pattern` フィールドを追記する。leader-guard.sh がパターンに応じたブロック判定を行うために必要。

### 履歴管理

テーマ/キャラクターの履歴は `~/.claude/team-theme-history.json`（git 管理外）で管理する。

共通フィールド:

- `pattern`: パターン名
- `theme`: テーマ名またはパターン名
- `characters`: キャラクター名の配列。含めるメンバーの範囲は各パターン仕様に従う

新しいエントリは配列の**先頭**に追加する。パターン固有のフィールドは各パターン仕様を参照。

### スポーン手順

メンバーのスポーン時には `mode: "bypassPermissions"` を指定すること。これにより hook に渡される `permission_mode` がリーダー（`default`）と異なる値になり、leader-guard.sh がメンバーを識別して許可する。

スポーン手順の詳細はパターンごとに異なる。各パターン仕様を参照:

- [fixed-theme パターン](fixed-theme.md)
- [mixed-genius パターン](mixed-genius.md)

## 関連ドキュメント

- [fixed-theme パターン](fixed-theme.md)
- [mixed-genius パターン](mixed-genius.md)
- `.claude/team-themes/GUIDELINES.md`: キャラクター演出詳細
- `.claude/team-themes/config.json`: デフォルトパターン設定
- `.claude/scripts/leader-guard.sh`: リーダー管理専任フックスクリプト
