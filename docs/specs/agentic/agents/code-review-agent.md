# コードレビューエージェント

## 概要

コミット前のセルフコードレビューを行うサブエージェント。テスト名と実装の整合性、エラーハンドリング、バリデーション、競合状態などの問題を検出し、PR レビューでの手戻りを削減する。

## 背景

- PR 作成後に自動レビューツールで初めて問題が指摘されるケースが頻発している
- コミット前のセルフレビューで検出可能な問題を事前に防ぎ、開発効率を向上させる

## 制約

### 設計方針

エージェント定義ファイルにレビュー観点の詳細は記載しない。エージェントはレビュー開始時に本仕様書を読み、レビュー基準を取得する（Single Source of Truth）。

### 指摘の調査義務

Warning / Suggestion レベルの指摘であっても、以下を調査せずに「スコープ外」と判断してはならない:

| 調査対象 | 確認内容 |
| --- | --- |
| デッドコード | Grep で参照箇所を検索し、未使用を確認 |
| パフォーマンス懸念 | 呼び出し頻度と実行コンテキストを確認 |
| 設計上の問題 | 修正に必要な変更量を確認 |

調査結果に基づき判断する:

- 修正コストが低く放置リスクあり → スコープ内として修正推奨
- 修正コストが高い → Issue 切り出し推奨（調査結果を添える）
- 実害なし → 「調査した結果、実害なし。理由: ...」と報告

## 役割

### レビュー観点

| # | 観点 | 内容 |
| --- | --- | --- |
| 1 | テスト名・docstring と実装の整合性 | テスト関数名と実際のテスト内容の不一致、docstring の不正確さ |
| 2 | エラーハンドリング | silent failure（`except: pass`）、ログ欠落、broad exception |
| 3 | バリデーション漏れ | 外部入力の未検証、境界値チェック漏れ |
| 4 | 競合状態・TOCTOU | ファイル存在チェック後の操作、共有リソースの同時アクセス |
| 5 | リソース管理 | try/finally スコープ不足、ハンドルの未クローズ |
| 6 | コード品質 | 未使用 import、typo、デッドコード、マジックナンバー |
| 7 | セキュリティ | コマンドインジェクション、パストラバーサル、機密情報ハードコーディング |
| 8 | プロジェクト規約 | docstring の仕様書パス記載、テスト名とテスト内容の対応 |
| 9 | フォールバック/暗黙のデフォルト値 | settings フォールバック、CLI の暗黙デフォルト値 |
| 10 | README.md 更新漏れ | 機能追加・変更時の README.md 反映漏れ |

### フォールバック/暗黙のデフォルト値（観点 9 の詳細）

以下のパターンを検出する:

- **settings フォールバック**: 関数の引数が `None` の場合に settings や環境変数から値を取得するパターン。値の出所は呼び出し元が決定すべき
- **CLI の暗黙デフォルト値**: argparse の `default` で具体値を設定するパターン。`required=True` にして呼び出し元に明示させるべき

| 対象 | 適用レベル |
| --- | --- |
| 評価 CLI・テストツール・スクリプト | 厳密適用 |
| 本番コード（`main.py`）の settings 参照 | 許容 |
| 基盤設定（DB 接続先等） | 許容 |

### README.md 更新漏れ（観点 10 の詳細）

変更差分に以下が含まれるが README.md の変更がない場合に指摘する:

| 変更パス | チェック対象セクション |
| --- | --- |
| `src/services/` | 「主な機能」 |
| `pyproject.toml` の依存関係 | 「技術スタック」 |
| `settings.py` / `.env.example` | 「主な環境変数」 |
| `src/` 配下の構造変更 | 「プロジェクト構造」 |
| `docs/specs/` に新規仕様書 | 「ドキュメント」 |

テストのみ・リファクタリング・CI/CD 変更ではスキップする。

### 優先度の判定基準

| 優先度 | 基準 |
| --- | --- |
| Critical | バグ・セキュリティ問題・データ損失リスク |
| Warning | コード品質・保守性に影響する問題 |
| Suggestion | 改善が望ましいが緊急性は低い |

## 処理フロー

1. **レビュー対象の特定**: ファイル指定があればそれを、なければ `git diff --cached` → `git diff` の順でレビュー対象を決定
2. **仕様書の参照**: 本仕様書を読みレビュー基準を取得。対象ファイルに対応する仕様書があれば読み込み
3. **コードの読み込み**: テストファイルの場合は対応する実装ファイルも、実装ファイルの場合は対応するテストも確認
4. **観点ごとの検査**: 10 の観点に基づき問題を検出し、優先度を判定
5. **レポート生成**: ファイルごとに検出した問題を優先度別に整理。各問題にファイルパス・行番号・改善案を付与

## 入出力

### 入力

自然言語で以下のパターンで呼び出す:

- 特定ファイル: 「code-reviewer で src/services/xxx.py をレビューして」
- 変更差分: 「code-reviewer で変更差分をレビューして」
- 複数ファイル: 「code-reviewer で src/services/ と tests/ をレビューして」

### 出力

ファイルごとに優先度別（Critical / Warning / Suggestion）に整理されたレビュー結果。各指摘にファイルパス・行番号・改善案を含む。問題なしの場合はその旨を報告。

## 連携

- **test-runner**: test-runner が「テストが通ること」を検証、code-reviewer は「コードの品質・正確性」を検証。補完関係
- **doc-reviewer**: doc-reviewer がドキュメント品質を検証。コード内 docstring は code-reviewer、仕様書は doc-reviewer の管轄
