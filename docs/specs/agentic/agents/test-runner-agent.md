# テストランナーエージェント

## 概要

テスト実行およびコード品質チェック（lint・型チェック・Markdown チェック・mermaid-lint）を自動化するサブエージェント。テストの実行、失敗時の分析、修正提案、再実行までを一貫して行う。

## 背景

- テスト実行コマンドの入力や lint・型チェックの個別実行が煩雑
- テスト失敗時のエラー分析に時間がかかり、修正後の再実行を忘れがち
- コード品質チェック（ruff, mypy, markdownlint）を本エージェント経由で実行することが開発ガイドラインで規定されている

## 役割

### 責務の範囲

- テスト実行（全テスト / 差分テスト / 特定ファイル・テストケース指定）
- コード品質チェック（ruff, mypy, markdownlint, mermaid-lint）
- Mermaid 構文チェック（md-mermaid-lint）および GitHub 互換チェック（`scripts/check_mermaid_compat.py`）
- 失敗・違反の原因分析と具体的な修正提案（ファイルパス・行番号付き）
- 全チェック結果の統合レポート生成
- ユーザー承認後の修正適用と再実行

### 実行モード

| モード | 用途 | テスト範囲 |
|---|---|---|
| `diff` | 変更ファイル関連のみ（デフォルト） | 変更に関連するテストのみ |
| `full` | 全テスト実行 | 全テスト |

- `diff`: 明示的に「差分テスト」「diff テスト」を指定した場合、またはモード未指定時（デフォルト）
- `full`: 明示的に「全テスト」を指定した場合

## 処理フロー

### full モード

1. **テスト対象の特定**: 引数でファイルパスやテスト名が指定されていればそれを実行、未指定なら全テスト
2. **テスト実行**: pytest でテストを実行し、結果を解析
3. **lint 実行**: ruff で `src/` および `tests/` のコードスタイル・潜在的バグをチェック
4. **型チェック実行**: mypy で `src/` の静的型解析を実行
5. **Markdown チェック実行**: markdownlint でリポジトリ内の Markdown ファイルをチェック
6. **Mermaid チェック実行**: md-mermaid-lint で Mermaid 構文チェック、`scripts/check_mermaid_compat.py` で GitHub 互換チェック
7. **結果の分析**: 失敗・違反があればソースコードを読み込み、原因を特定して修正案を提示（Mermaid GitHub 互換違反は後述「Mermaid GitHub 互換違反の修正指針」参照）
8. **修正適用（オプション）**: ユーザー承認後に修正を適用し、再度チェックを実行
9. **レポート生成**: 全チェック結果の統合サマリー

各チェックツールが失敗してもプロセスを中断せず、すべてのチェックを実行して統合レポートを生成する。

### diff モード

1. **変更ファイルの取得**: 作業ツリーの変更 → ベースブランチとの比較 → ステージング済み → 直近コミットの順で試行。すべて失敗した場合は full モードにフォールバック
2. **変更ファイルの分類**:
   - `src/**/*.py` → 対応テストを推定し実行、ruff・mypy の対象
   - `tests/*.py` → そのまま実行対象に追加、ruff の対象
   - `*.md` → markdownlint・mermaid チェックの対象（pytest・ruff・mypy はスキップ）
   - 設定ファイル（`pyproject.toml`, `conftest.py`）→ 全テスト実行にフォールバック
   - その他 → テスト対象外
3. **テストファイルの推定**: ソースファイルのパスパターンから対応テストファイルをマッピング。対応テストが見つからない場合は全テストにフォールバック
4. **推定テスト・lint・型チェック・Markdown チェック・Mermaid チェックの実行**（変更ファイルのみ対象）
5. **レポート生成**

## 入出力

### 入力

ユーザーが自然言語で指示する:

```
test-runnerサブエージェントで全テストを実行してください
test-runnerサブエージェントで差分テストを実行してください
test-runnerサブエージェントで tests/test_feed_collector.py を実行してください
test-runnerサブエージェントでカバレッジを測定してください
```

### 出力

全チェック結果を統合したレポートを生成する。

**全て成功時**:

```markdown
### コード品質チェック結果 ✅

#### pytest
- **実行件数**: N passed
- **実行時間**: X.XXs

#### ruff (lint)
- **違反**: なし

#### mypy (型チェック)
- **型エラー**: なし

#### markdownlint
- **違反**: なし

#### mermaid-lint
- **違反**: なし

すべてのチェックが成功しました。
```

**失敗時**: 各ツールの結果に加え、失敗したテスト・違反箇所ごとにエラー内容・原因分析・修正案（ファイルパス・行番号付き）を含む。カバレッジ情報は要求された場合のみ含む。

## Mermaid GitHub 互換違反の修正指針

`scripts/check_mermaid_compat.py` が `[GH001]` を検出した場合、`docs/specs/style-guide.md` の「6.7 図・表」セクションに記載された修正指針に基づいて、`#` の使用箇所の文脈を判断し修正案を提示する。
