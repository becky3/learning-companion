# Claude Code Hooks

## 概要

Claude Code の hooks 機能を使用して、セッション開始時のコンテキスト注入・デスクトップ通知・操作ガード・コンテキスト保護を提供する。プロジェクト基盤情報の自動注入、長時間タスクの完了通知、重要な確認時のアラート、破壊的操作やチーム運用時のガードを担う。

## 背景

- 長時間かかるタスクの完了や確認待ち状態をユーザーが見逃すことがある
- エージェントチーム運用時にリーダーが直接ファイル編集しないルールを技術的に制約する必要がある
- 破壊的な GitHub 操作（Issue 削除等）を誤って実行するリスクがある
- コンテキスト圧縮時に重要なルールが失われる問題がある
- CLAUDE.md に外部ファイルの参照指示を書いても自動実行されず、セッション開始時にプロジェクトの基盤情報が欠落する

## 制約

- シェルスクリプトは LF 改行コードで保存すること（CRLF だとエラー）
- フックスクリプトは任意コマンド実行可能なため、信頼できるスクリプトのみ設定する
- `permissions.allow` の自動許可が `PreToolUse` の deny を上書きする可能性がある

## 対象イベント

| イベント | matcher | 用途 |
|---|---|---|
| `SessionStart` | `*` | セッション開始時コンテキスト注入 |
| `PreToolUse` | `Bash` | 破壊コマンドガード |
| `PreToolUse` | `Edit` | リーダーガード |
| `PreToolUse` | `Write` | リーダーガード |
| `PreCompact` | `*` | コンテキスト圧縮前のルール注入 |
| `Notification` | `*` | ユーザー入力待ち通知 |
| `PermissionRequest` | `*` | ツール実行許可待ち通知 |
| `Stop` | `*` | タスク完了通知 |

**設定形式のポイント**:

- イベント名は PascalCase（例: `Stop`, `Notification`）
- 各イベントは配列で、`matcher` と `hooks` を含むオブジェクトを持つ
- パスは相対パスを使用

**Notification イベントの matcher 値**:

- `*`: 全ての通知タイプをキャッチ
- `permission_prompt`: ツール許可ダイアログ表示時
- `idle_prompt`: アイドル状態で入力待機時
- `elicitation_dialog`: 選択肢提示時

## 処理内容

### 通知スクリプト

クロスプラットフォーム対応のデスクトップ通知を行う。

| プラットフォーム | 通知方法 |
|---|---|
| macOS | `osascript` によるネイティブ通知 + サウンド |
| Linux | `notify-send` (libnotify) |
| Windows | PowerShell によるバルーン通知（PowerShell Core 優先、フォールバックあり） |
| その他 | stderr にテキスト出力（フォールバック） |

通知は非同期実行し、Claude Code の動作を阻害しない。

### リーダーガード

エージェントチーム運用時に、リーダーの Edit / Write ツール使用をブロックする。

**判定ロジック**:

1. `permission_mode` が `"bypassPermissions"` → メンバー → 通過
2. チームディレクトリ配下にサブディレクトリなし → チーム非稼働 → 通過
3. リーダー + チーム稼働中 → deny 応答でブロック

**fail-open 設計**: 入力読み取り失敗、環境変数未定義等のエラー時はブロックせず通過する。

### 破壊コマンドガード

`gh * delete` 系コマンド（Issue 削除、リポジトリ削除、リリース削除、ラベル削除）を検出してブロックする。

実行が必要な場合はターミナルから直接実行する。

### コンテキスト圧縮前ルール注入

`PreCompact` イベントで、コンテキスト圧縮前に重要なルールを再注入する。圧縮後も保持すべきルール（矛盾がある場合の確認ルール等）を stdout に出力する。

### セッション開始時コンテキスト注入

#### 動作

`SessionStart` イベントで、セッション開始時にプロジェクトの基盤ドキュメントを stdout 経由でコンテキストに注入する。注入されたテキストは CLAUDE.md と同様にセッション全体で参照可能になる。

#### 注入対象ファイル

| ファイル | 役割 |
|---------|------|
| `README.md` | プロジェクト概要・技術スタック・起動方法・プロジェクト構造 |
| `docs/specs/overview.md` | 機能一覧・LLM 設定・DB 設計・開発方針 |
| `docs/specs/style-guide.md` | 仕様書の分類・命名規則・記述ルール・コミットメッセージ規約 |

#### CLAUDE.md との使い分け

| 配置先 | 特性 | 適する内容 |
|--------|------|-----------|
| SessionStart フック | 毎セッション自動注入。常にコンテキストに存在する | プロジェクト共通知識（概要・構造・規約） |
| CLAUDE.md 内の参照指示 | 手動参照。タスク実行時に必要に応じて読む | タスク固有の詳細仕様（各機能仕様書等） |

**CLAUDE.md の制約**: CLAUDE.md に「このファイルを読め」と書いても、Claude Code はそれを自動実行しない。CLAUDE.md 自体は自動展開されるが、外部ファイル参照の指示は自動実行されない。毎セッション必ず参照すべきファイルは SessionStart フックで注入する必要がある。

## 関連ドキュメント

- [エージェントチーム共通仕様](../teams/common.md): リーダー管理専任ルール
