# ドキュメントレビューサブエージェント

## 概要

仕様書（`docs/specs/*.md`）および README.md の品質を自動レビューするClaude Codeサブエージェント。仕様駆動開発の観点から、構造の完全性、受け入れ条件の品質、情報の過不足、コードとの整合性をチェックし、改善提案を行う。README.md については、リンク切れ、プロジェクト構造の実態との整合性、CLAUDE.md との一貫性を検証する。

## 背景

AI Assistantプロジェクトは仕様駆動開発を採用しており、すべての機能実装は `docs/specs/` の仕様書に基づいて行われる。仕様書の品質が低いと、実装時の混乱や手戻りが発生し、開発効率が低下する。

一方で、仕様書の品質レビューは以下の課題がある:

- 構造の網羅性チェックが手作業で煩雑
- 受け入れ条件の具体性が主観的になりがち
- ファイル参照の整合性確認が漏れやすい
- レビュー観点がレビュアーによってばらつく

これらを解消するため、仕様駆動開発の観点で一貫した品質基準を適用できるレビューエージェントを実装する。

## ユーザーストーリー

- 開発者として、仕様書を作成した後に `doc-reviewerサブエージェント` でレビューを受け、品質を向上させたい
- 開発者として、仕様書更新時にレビューエージェントで変更箇所の妥当性を確認したい
- 開発者として、全仕様書をまとめてレビューし、プロジェクト全体のドキュメント品質を把握したい
- 開発者として、README.md を更新した際にリンク切れや実態との乖離がないか自動チェックしたい

## 技術仕様

### サブエージェント定義

**ファイル**: `.claude/agents/doc-reviewer.md`

**メタデータ:**

```yaml
name: doc-reviewer
description: 仕様書(docs/specs/*.md)とREADME.mdの品質レビュー専門家。仕様駆動開発の観点から不足・過剰な情報を検出し、改善提案を行う。ドキュメント作成・更新後に積極的に使用する。
tools: Read, Grep, Glob, Bash
permissionMode: bypassPermissions
```

※ `model` フィールドは省略（デフォルトモデルを使用）。これはプロジェクト全体で統一された方針であり、許容パターンとして定義されている。

**設計方針:** エージェント定義ファイルにはレビュー基準の詳細を記載しない。エージェントはレビュー開始時に本仕様書（`docs/specs/doc-review-agent.md`）を読み、レビュー基準を取得する。これにより、本仕様書が Single Source of Truth となり、基準の二重管理を防ぐ。エージェント定義には役割・プロセス概要・出力フォーマットのみを記載する。

### レビュー観点

#### 1. 構造の完全性

以下のセクションが揃っているかチェック:

- 概要
- 背景（または「ユーザーストーリー」の前に説明）
- ユーザーストーリー
- 技術仕様（入出力仕様、処理フロー）
- 受け入れ条件 (AC)
- 使用LLMプロバイダー（該当する場合）
- 関連ファイル
- テスト方針

#### 2. 受け入れ条件（AC）の品質

- `- [ ]` 形式でチェックボックスとして記載されているか
- 各ACが具体的で検証可能か
- 実装の「何を」検証するかが明確か

#### 3. 情報の過不足

**不足の検出:**

- 技術仕様に入出力の具体例が含まれているか
- 関連ファイルのテーブルに役割が記載されているか
- 使用LLMプロバイダーの選定理由が説明されているか（該当する場合）

**過剰の検出:**

- 具体的な実装詳細（コードスニペット、関数名）が含まれていないか
- 仕様ではなく実装メモになっていないか

#### 4. コードとの整合性

- 関連ファイルに記載されたファイルが実際に存在するか
- サービスクラスのdocstringに仕様書パスが記載されているか（CLAUDE.mdのコーディング規約）

#### 5. テンプレート準拠

- `docs/specs/overview.md` のテンプレート構造に従っているか
- 他の仕様書と一貫性があるか

### レトロスペクティブ（docs/retro/*.md）固有のレビュー観点

レトロスペクティブは仕様書とは異なる性質のドキュメントのため、以下の独自基準を適用:

#### 1. 構造の完全性

以下のセクションが揃っているかチェック:

- 何を実装したか（機能の概要・関連PR）
- うまくいったこと
- 改善点・ハマったこと（各項目に「問題」「原因」「対応」「教訓」を含む）
- 次に活かすこと

#### 2. 内容の具体性と正確性

- 各「改善点」に具体的な問題の説明があるか（曖昧な記述になっていないか）
- 「原因」と「対応」に論理的な一貫性があるか（対応が原因の解決になっているか）
- 「教訓」が一般化された知見になっているか（特定のケースだけでなく再利用可能か）
- 「次に活かすこと」が具体的なアクションとして記載されているか

#### 3. 事実関係の整合性

- 言及されているPR番号・Issue番号が実在するか
- 言及されているファイルパス・設定名が実在するか
- 技術的な説明に矛盾がないか

#### 4. 仕様書との関連性

- 対応する仕様書（`docs/specs/f{N}-*.md`）が存在するか
- レトロで言及された問題が仕様書に反映されているか（対応が必要だった場合）

### README.md 固有のレビュー観点

README.md は仕様書とは異なる性質のドキュメントのため、以下の独自基準を適用:

#### 1. リンク先ファイルの存在確認

- マークダウンリンク `[text](path)` を抽出
- 相対パスのリンク先ファイルが実際に存在するか確認
- 他ファイル内セクションへのリンク（例: `[link](docs/file.md#section)`）は、`#` より前のパス部分のみでファイル存在を確認
- 以下は検証対象外:
  - 同一ドキュメント内アンカーリンク（例: `[link](#section)`）
  - 外部URL（`http://` や `https://` で始まるもの）
- リンク切れを検出した場合は Critical として指摘

#### 2. プロジェクト構造の実態との整合性

- README.md に記載されたディレクトリ・ファイル構造を抽出
- コードブロック内の構造図（`src/`, `docs/`, `config/` など）を解析
- 記載されたパスが実際に存在するか確認
- 存在しないパスがあれば Warning として指摘

#### 3. CLAUDE.md との一貫性

以下の項目で CLAUDE.md と README.md の記載が矛盾していないか確認:

- **技術スタック**: 使用ライブラリ・バージョン要件
- **セットアップ手順**: コマンド・手順の一致
- **プロジェクト構造**: ディレクトリ構成の一致
- **開発フロー**: ブランチ命名規則、コミットメッセージ形式

矛盾がある場合は Critical として指摘し、どちらを正とすべきか提案。

#### 4. 開発ガイドラインへの誘導

- README.md に CLAUDE.md への明示的な参照が含まれているか
- 開発者が最初に読むべきドキュメントとして CLAUDE.md が案内されているか
- 参照がない場合は Suggestion として追加を推奨

### レビューモード

レビュー時間・粒度を最適化するため、2つのレビューモードを提供する。

| モード | 用途 | レビュー範囲 | 目標時間 |
|--------|------|-------------|---------|
| `full` | 新規作成・大幅改訂 | ファイル全体を全観点でチェック | 60秒以下 |
| `diff` | 軽微な修正・レビュー指摘対応 | 変更差分のみを関連観点でチェック | 30秒以下 |

#### モード選択の判断基準

**`full` モードを使用するケース:**

- 新規仕様書の作成時
- 既存仕様書の大幅改訂時（構造変更、セクション追加など）
- 明示的に「フルレビュー」「fullレビュー」を指定された場合
- モード未指定の場合（デフォルト）

**`diff` モードを使用するケース:**

- 誤字脱字の修正
- 既存内容の微修正・補足追加
- PRレビュー指摘への対応
- 明示的に「差分レビュー」「diffレビュー」を指定された場合

#### 呼び出し例

```
# フルレビュー（デフォルト・従来動作）
doc-reviewerサブエージェントで docs/specs/f1-chat.md をレビューしてください

# フルレビュー（明示指定）
doc-reviewerサブエージェントで docs/specs/f1-chat.md をフルレビューしてください

# 差分レビュー
doc-reviewerサブエージェントで docs/specs/f1-chat.md を差分レビューしてください
```

### 許容パターン

プロジェクト方針として許容される項目を定義し、指摘対象外とする:

| 項目 | 許容理由 |
|------|---------|
| エージェント定義の `model` フィールド省略 | 全エージェントで統一的に省略（デフォルトモデル使用） |
| サブエージェント仕様書での簡略化された技術仕様 | エージェント定義ファイルとの役割分担 |
| レトロスペクティブでのPR番号不在 | 開発中PRの場合は番号未確定 |

### 処理フロー

#### フルレビューモード

1. **対象の特定**
   - 引数でファイルパスが指定されていればそれをレビュー
   - 未指定なら `docs/specs/` の全仕様書と `README.md` をレビュー（`docs/retro/` はファイル指定時のみレビュー対象）

2. **ドキュメント種別の判定**
   - `README.md` の場合は README.md 固有のレビュー基準を適用
   - `docs/retro/*.md` の場合はレトロスペクティブ固有のレビュー基準を適用
   - `docs/specs/*.md` の場合は仕様書のレビュー基準を適用

3. **構造チェック（ドキュメント種別ごと）**
   - 仕様書の場合: テンプレートに定められた主要セクション（概要、背景、ユーザーストーリー、技術仕様、受け入れ条件、関連ファイル、テスト方針）の有無を確認し、欠落があれば指摘
   - README.md の場合: 一般的な README 構成（プロジェクト概要、セットアップ手順、使い方、開発ルール、関連ドキュメントへのリンクなど）の有無を確認し、不足要素があれば提案（仕様書テンプレートのセクション構成は要求しない）

4. **内容の詳細レビュー**
   - 各セクションの品質を評価
   - 受け入れ条件の具体性を確認（仕様書の場合）
   - 不足・過剰な情報を検出
   - **許容パターンに該当する項目は指摘対象外とする**

5. **実装との整合性確認**
   - 関連ファイルの存在確認
   - サービスクラスのdocstringチェック（該当する場合）
   - README.md の場合はリンク切れ、プロジェクト構造の実態との整合性、CLAUDE.md との一貫性を確認

6. **レポート生成**
   - 優先度別に整理（Critical > Warning > Suggestion）
   - 各問題の具体的な改善提案を提供

#### 差分レビューモード

1. **変更差分の取得**（以下の優先順位で試行）
   - 作業ツリーの変更（未ステージ）: `git diff -- <file>` で編集中のファイルを即座にレビュー
   - ベースブランチ（例: `origin/main`）との merge-base を取得し、`git diff <merge-base>...HEAD -- <file>` でPR全体の変更差分を取得
   - ステージング済みの変更: `git diff --cached -- <file>` でコミット前の最終確認
   - 直近コミットの差分（フォールバック）: `git show HEAD -- <file>` でクリーンな状態での確認
   - すべて空の場合のみ、「変更なし」として終了

2. **変更タイプの判定**
   - 追加行のみ: 新規内容のレビュー
   - 削除行のみ: 削除の妥当性確認
   - 変更行: 変更前後の比較レビュー

3. **観点の絞り込み**
   - 構造変更がない場合: 構造の完全性チェックをスキップ
   - AC変更がない場合: AC品質チェックをスキップ
   - 関連ファイル変更がない場合: 整合性チェックをスキップ
   - **許容パターンに該当する項目は指摘対象外とする**

4. **レポート生成**
   - 変更箇所に対する指摘のみ出力
   - 既存部分への指摘は含めない
   - 優先度別に整理（Critical > Warning > Suggestion）

### 入出力仕様

#### 入力

ユーザーがClaude Codeで以下のように呼び出す:

```
# フルレビュー（デフォルト）
doc-reviewerサブエージェントを使用して docs/specs/f1-chat.md をレビューしてください

# フルレビュー（明示指定）
doc-reviewerサブエージェントで docs/specs/f1-chat.md をフルレビューしてください

# 差分レビュー
doc-reviewerサブエージェントで docs/specs/f1-chat.md を差分レビューしてください
```

```
doc-reviewerサブエージェントを使用して README.md をレビューしてください
```

または:

```
doc-reviewerサブエージェントで全ドキュメントをレビューしてください
```

#### 出力

以下の形式でレビュー結果を返す:

```markdown
### ファイル: docs/specs/f1-chat.md

#### ✅ 良好な点
- すべての必須セクションが揃っている
- 受け入れ条件が具体的で検証可能
- 入出力仕様に具体例が含まれている

#### ⚠️ 改善が必要な点

**Warning（修正推奨）:**
- [異常系シナリオ]: 「APIエラー発生時」の振る舞いが仕様に明示されていない
  - 改善案: 想定されるエラーコードごとのユーザーへの通知方法とログ出力方針を追記

**Suggestion（改善検討）:**
- [テスト方針]: 具体的なテストケース数やカバレッジ目標があるとより明確
  - 改善案: 「LLM APIモックテスト: 3ケース、会話履歴テスト: 5ケース」など具体化

#### 📊 総評
- 仕様として十分な品質。実装を進める上でのリスクは低い
- サービスクラスへの仕様書パス記載は CLAUDE.md のコーディング規約に従うため推奨
```

## 使用LLMプロバイダー

**Claude Code (Sonnet モデル)** — サブエージェントとして使用

**選定理由:**

- ドキュメントレビューは、構造分析、品質評価、改善提案など、高度な推論力が必要なタスク
- サブエージェント定義では `model` フィールドを省略し、デフォルトモデルを使用（プロジェクト統一方針）
- 仕様駆動開発の観点からの評価には、文脈理解と論理的な分析が重要

## 受け入れ条件

### 仕様書レビュー機能（既存）

- [ ] AC1: `.claude/agents/doc-reviewer.md` が正しく作成され、Claude Codeから呼び出せる
- [ ] AC2: 単一ファイル指定時に該当ファイルのみレビューする
- [ ] AC3: ファイル未指定時に `docs/specs/` の全仕様書と `README.md` をレビューする
- [ ] AC4: 構造の完全性チェックで欠落セクションを検出できる
- [ ] AC5: 受け入れ条件の品質チェックで曖昧なACを指摘できる
- [ ] AC6: 関連ファイルの存在確認で存在しないファイルを指摘できる
- [ ] AC7: レビュー結果が優先度別（Critical/Warning/Suggestion）に整理される
- [ ] AC8: 各指摘に具体的な改善案が含まれる
- [ ] AC9: `docs/retro/` のレトロスペクティブをレビュー対象として処理できる
- [ ] AC10: テンプレート準拠チェックで一貫性のない構造を指摘できる

### README.md レビュー機能（新規）

- [ ] AC11: README.md を指定してレビューできる
- [ ] AC12: README.md 内のマークダウンリンク `[text](path)` を抽出し、リンク切れを検出できる
- [ ] AC13: README.md に記載されたプロジェクト構造が実際のディレクトリ・ファイル構成と一致するか確認できる
- [ ] AC14: README.md の技術スタックが CLAUDE.md と論理的に矛盾していないか確認できる（フォーマットや詳細度の違いは許容し、要素の欠落・不一致を検出）
- [ ] AC15: README.md のセットアップ手順・開発フローが CLAUDE.md と矛盾していないか確認できる
- [ ] AC16: README.md に CLAUDE.md への参照が含まれているか確認できる
- [ ] AC17: README.md レビュー結果も優先度別（Critical/Warning/Suggestion）に整理される
- [ ] AC18: README.md のレビュー結果に、検出した各問題に対する具体的な改善案が含まれる（例: リンク切れの正しいパス候補、CLAUDE.md との不整合箇所の修正文面など）
- [ ] AC19: 既存の仕様書レビュー機能（AC1〜AC10）は引き続き動作する（後方互換性）

### レビューモード機能（新規）

- [ ] AC20: 「差分レビュー」「diffレビュー」キーワードで差分レビューモードが起動する
- [ ] AC21: 差分レビューモードでは変更箇所のみがレビュー対象となる
- [ ] AC22: 差分レビューモードの実行時間が30秒以下である
- [ ] AC23: フルレビューモードは従来通り動作する
- [ ] AC24: モード未指定時はフルレビューがデフォルトで実行される
- [ ] AC25: 許容パターンに該当する項目は指摘されない

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `.claude/agents/doc-reviewer.md` | サブエージェント定義（役割・プロセス概要・出力フォーマット） |
| `docs/specs/*.md` | レビュー対象の仕様書 |
| `docs/retro/*.md` | レビュー対象のレトロスペクティブ |
| `docs/specs/overview.md` | 仕様書テンプレート定義（参照用） |
| `README.md` | レビュー対象のプロジェクトREADME |
| `CLAUDE.md` | コーディング規約（docstringルール等）、README.mdとの整合性確認の基準 |

## テスト方針

Claude Codeサブエージェントは実行時テストが中心となるため、以下を手動で確認:

### 仕様書レビュー機能のテスト

#### 基本動作テスト

- [ ] 既存の仕様書（`f1-chat.md`, `f2-feed-collection.md` など）をレビューし、適切な指摘が得られるか
- [ ] 意図的に不完全な仕様書を作成し、欠落セクションが検出されるか
- [ ] 関連ファイルに存在しないファイルパスを記載し、検出されるか

#### 誤検出チェック

- [ ] 正しい仕様書に対して誤った指摘（過検出）が出ないか
- [ ] 必須でないセクション（例: LLMプロバイダー）の欠如を誤って Critical として指摘しないか

#### レビュー品質

- [ ] 指摘が具体的で実用的な改善案を含むか
- [ ] 優先度（Critical/Warning/Suggestion）の判定が妥当か
- [ ] 総評が仕様駆動開発の観点で有益な情報を含むか

### README.md レビュー機能のテスト

#### リンク切れ検出

- [ ] README.md 内の相対パスリンクを抽出できるか
- [ ] 存在しないファイルへのリンクを検出できるか（例: `[存在しないドキュメント](docs/nonexistent.md)`）
- [ ] 外部URLは検証対象外として処理されるか

#### プロジェクト構造の整合性

- [ ] README.md に記載されたディレクトリ構造と実際の構造を比較できるか
- [ ] 存在しないディレクトリ・ファイルが記載されている場合に検出できるか

#### CLAUDE.md との一貫性

- [ ] 技術スタックの記載が CLAUDE.md と一致するか検証できるか
- [ ] セットアップ手順が CLAUDE.md と矛盾していないか確認できるか
- [ ] 矛盾がある場合に具体的な修正提案を提示できるか

#### CLAUDE.md への誘導

- [ ] README.md に CLAUDE.md への参照が含まれているか検出できるか
- [ ] 参照がない場合に Suggestion として追加を推奨できるか

#### 後方互換性

- [ ] README.md レビュー機能追加後も既存の仕様書レビュー機能が正常に動作するか
- [ ] ファイル未指定時に仕様書と README.md の両方をレビューできるか

### 差分レビューモードのテスト

- [ ] 誤字修正のみの変更で差分レビューを実行し、30秒以下で完了するか
- [ ] 変更箇所以外への指摘が出ないか
- [ ] git diffが正しく取得されるか
- [ ] モード未指定でフルレビューが実行されるか

### 許容パターンのテスト

- [ ] modelフィールド省略が指摘されないか
- [ ] その他の許容パターンが指摘されないか

## 拡張性

将来的に以下の機能を追加可能:

- **自動修正モード**: 検出した問題を自動で修正する（`permissionMode: acceptEdits` のバリアント）
- **レポート生成**: 全仕様書のレビュー結果をサマリーレポートとして出力
- **CI/CD統合**: PRに仕様書変更が含まれる場合、自動でレビューを実行
- **カスタムルール**: プロジェクト固有のレビュールールを追加
