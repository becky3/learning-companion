---
name: handoff
description: セッション引き継ぎ（MEMORY.md更新・ジャーナル記録・次セッション申し送り）
user-invocable: true
allowed-tools: Bash, Read, Edit, Write, Grep, Glob
argument-hint: "[メッセージ]"
---

## タスク

セッション終了時の引き継ぎ処理を一括実行する。MEMORY.mdの更新、ジャーナル記録、次セッションへの申し送りを行う。

仕様: docs/specs/agentic/skills/handoff-skill.md

## 引数

`$ARGUMENTS` の形式:

- 引数なし: セッション引き継ぎを実行
- `"メッセージ"`: カスタムメッセージ付きで引き継ぎ（ジャーナルの「気づき・次に活かすこと」セクションに記録）

## メモリディレクトリの特定

MEMORY.md等のファイルは Claude Code のプロジェクトメモリディレクトリに配置する。

Claude Code のシステムプロンプトに `You have a persistent auto memory directory at ...` として現在のプロジェクトのメモリディレクトリパスが提供されている。**そのパスを直接使用すること**（`find` で探索しない）。

ディレクトリが見つからない場合はエラーとして扱い、ユーザーに設定の確認を促して処理を中断する。

## 処理手順

### ステップ1: セッション情報の収集

以下の情報を収集する:

1. **今日のコミット履歴**

   ```bash
   git log --oneline --since="midnight" --author="$(git config user.name)"
   ```

2. **現在のブランチとステータス**

   ```bash
   git branch --show-current
   git status --short
   ```

3. **今日マージされたPR**

   ```bash
   gh pr list --state merged --search "merged:>=$(date -I)" --json number,title 2>/dev/null || echo "[]"
   ```

4. **未完了の作業**
   - 未コミットの変更
   - 作業中のブランチ

### ステップ2: MEMORY.md の確認

MEMORY.md に新たなプロジェクト知見があれば追記する。

**ファイルパス**: `$MEMORY_DIR/MEMORY.md`

**更新ルール:**

- **進行中タスクは MEMORY.md に書かない**（ジャーナルに記録する）
- MEMORY.md に書くもの: **頻繁に行う作業で、間違うと実害があり、lint やテストでは検知できないもの**（環境固有の罠、操作上の禁止事項など）
- 新たな知見があれば追記、なければ変更なし
- **200行を超えないよう簡潔に記述する**（Claude Codeのシステムプロンプトに読み込まれるため）

### ステップ3: journal/ に新規ファイル作成

**ディレクトリ**: `$MEMORY_DIR/journal/`

ディレクトリが存在しない場合は作成する。

**ファイル名の生成:**

```bash
TIMESTAMP=$(date '+%Y%m%d-%H%M%S')
SLUG="タイトルのスラッグ"
FILENAME="${TIMESTAMP}-${SLUG}.md"
```

- タイトルスラッグ: Issue番号 `(#NNN)` や副題（`—` 以降）を除去し、スペースをハイフンに置換。パス区切り文字（`/`, `\`）や制御文字は除去する
- 例: `20260218-153000-ジャーナル個別ファイル化.md`

**ファイル内容:**

既存の journal-guidelines.md に従ったフォーマットで記載する。

**必須項目**（毎回記載）:

```markdown
## YYYY-MM-DD HH:MM:SS - 一言タイトル

### 概要
何をやったか、背景（実装範囲・関連Issue/PR含む）

### 判断
迷った点・選んだ選択肢・理由

### 結果
良かった / 悪かった / 未検証
```

**任意項目**（書くことがあれば記載）:

- `### うまくいったこと` — 成功パターン・再利用できる知見
- `### 改善点・ハマったこと` — 問題 → 対応 → 教訓 の3点セット
- `### 気づき・次に活かすこと` — 自分の行動改善、技術的な学び
- `### ユーザーへの提案` — プロセス改善・ワークフロー改善・環境改善などの提案
- `### 残課題` — 未着手の関連タスク（あれば）

**書き分け**: 小さいPRは必須項目のみ、大きい機能実装やハマった時は任意項目もしっかり書く。

カスタムメッセージ（引数）がある場合は「**気づき・次に活かすこと**」セクションに追記する。

**日時**: スキル実行時の日時（`date '+%Y-%m-%d %H:%M:%S'`）

### ステップ4: ユーザーへの報告

結果を表示する:

```text
✅ セッション引き継ぎ完了

📝 MEMORY.md: [更新あり / 変更なし]
📓 ジャーナルを作成しました: {ファイル名}

---
🔜 次のセッションで:
- [次にやることの箇条書き]
```

## エラーハンドリング

- メモリディレクトリが見つからない場合:

  ```text
  エラー: プロジェクトメモリディレクトリが見つかりません。
  Claude Code のプロジェクト設定を確認してください。
  ```

- git コマンドが使用できない場合:
  - コミット履歴・PR情報は「取得できませんでした」と表示し、残りの処理は続行

## 注意事項

- MEMORY.md はClaude Codeのシステムプロンプトに読み込まれるため、200行以内に収める
- ジャーナルは `journal/` ディレクトリに1エントリ1ファイルで保存する（ローリング不要）
- カスタムメッセージが長い場合でもそのまま記録する（切り詰めない）
- 進行中タスク・セッション固有の情報は MEMORY.md に書かない（ジャーナルに記録）
- 既存のMEMORY.mdの内容は削除しない（知見の追記のみ）
