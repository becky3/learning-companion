---
name: handoff
description: セッション引き継ぎ（MEMORY.md更新・ジャーナル記録・次セッション申し送り）
user-invocable: true
allowed-tools: Bash, Read, Edit, Write, Grep, Glob
argument-hint: "[メッセージ]"
---

## タスク

セッション終了時の引き継ぎ処理を一括実行する。MEMORY.mdの更新、ジャーナル記録、ローリング、次セッションへの申し送りを行う。

仕様: docs/specs/handoff-skill.md

## 引数

`$ARGUMENTS` の形式:

- 引数なし: セッション引き継ぎを実行
- `"メッセージ"`: カスタムメッセージ付きで引き継ぎ（ジャーナルの「メモ」欄に記録）

## メモリディレクトリの特定

MEMORY.md等のファイルは Claude Code のプロジェクトメモリディレクトリに配置する。

```bash
# プロジェクトメモリディレクトリを探す
MEMORY_DIR=$(find ~/.claude/projects -maxdepth 2 -name "memory" -type d 2>/dev/null | head -1)
```

ディレクトリが見つからない場合は、ユーザーに確認してから作成する。

## 処理手順

### ステップ1: セッション情報の収集

以下の情報を収集する:

1. **今日のコミット履歴**

   ```bash
   git log --oneline --since="midnight"
   ```

2. **現在のブランチとステータス**

   ```bash
   git branch --show-current
   git status --short
   ```

3. **今日マージされたPR**

   ```bash
   gh pr list --state merged --search "merged:>=$(date -I)" --json number,title 2>/dev/null || echo "[]"
   ```

4. **未完了の作業**
   - 未コミットの変更
   - 作業中のブランチ

### ステップ2: MEMORY.md の更新

MEMORY.md の「進行中タスク」セクションを更新する。

**ファイルパス**: `$MEMORY_DIR/MEMORY.md`

**存在しない場合は新規作成:**

```markdown
# AI Assistant 開発メモリ

## 進行中タスク

（ここにタスク情報を記述）

## プロジェクト知見

（ここに知見を記述）
```

**更新ルール:**

- 「## 進行中タスク」セクションを今セッションの成果と次の作業で上書き
- 「## プロジェクト知見」は追記のみ（新たに学んだことがあれば追加）
- **200行を超えないよう簡潔に記述する**（Claude Codeのシステムプロンプトに読み込まれるため）

### ステップ3: journal.md にエントリ追加

**ファイルパス**: `$MEMORY_DIR/journal.md`

**存在しない場合は新規作成:**

```markdown
# セッションジャーナル
```

**エントリ形式（ファイルのヘッダー直後、既存エントリの上に追加）:**

```markdown
## YYYY-MM-DD セッション概要（1行）

- **やったこと**: 成果を箇条書き
- **PR/マージ**: マージしたPRがあれば（なければ「なし」）
- **次にやること**: 次セッションで着手すべきタスク
- **メモ**: カスタムメッセージ（引数があれば。なければこの行は省略）
```

**日付**: スキル実行時の日付（`date +%Y-%m-%d`）

### ステップ4: ジャーナルのローリング

journal.md のエントリが10件を超えた場合、古い分を journal-archive.md に移動する。

**手順:**

1. journal.md 内の `## YYYY-MM-DD` 見出しの数をカウント
2. 10件以下ならスキップ
3. 11件目以降のエントリ（古い方）を抽出
4. journal-archive.md に追加（ファイルのヘッダー直後、既存エントリの上に挿入）
5. journal.md から移動済みエントリを削除

**journal-archive.md が存在しない場合は新規作成:**

```markdown
# セッションジャーナル（アーカイブ）
```

### ステップ5: ユーザーへの報告

結果を表示する:

```text
セッション引き継ぎ完了

MEMORY.md を更新しました
ジャーナルにエントリを追加しました（現在 N 件）
古いエントリを M 件アーカイブしました（該当時のみ表示）

---
次のセッションで:
- [次にやることの箇条書き]
```

## エラーハンドリング

- メモリディレクトリが見つからない場合:

  ```text
  エラー: プロジェクトメモリディレクトリが見つかりません。
  Claude Code のプロジェクト設定を確認してください。
  ```

- git コマンドが使用できない場合:
  - コミット履歴・PR情報は「取得できませんでした」と表示し、残りの処理は続行

## 注意事項

- MEMORY.md はClaude Codeのシステムプロンプトに読み込まれるため、200行以内に収める
- ジャーナルのローリングは10件を閾値とし、アーカイブに移動する
- カスタムメッセージが長い場合でもそのまま記録する（切り詰めない）
- 既存のMEMORY.mdの「プロジェクト知見」セクションは削除しない（追記のみ）
