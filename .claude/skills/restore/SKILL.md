---
name: restore
description: セッション復帰時のジャーナル確認・前回作業の把握
user-invocable: true
allowed-tools: Bash, Read, Write
argument-hint: "[キャラクター名]"
---

## タスク

セッション復帰時に前回のジャーナルを読み、作業状況を把握する。MEMORY.md と最新のジャーナルエントリから、前回どこまで進んだか・次に何をすべきかを要約してユーザーに報告する。

また、キャラクター名が指定された場合はそのキャラクターを、未指定の場合はランダムキャラクターをデフォルトキャラクターとして設定する。

## 引数

`$ARGUMENTS` の形式:

- 引数なし: ランダム選出モードでデフォルトキャラクターに設定
- `キャラクター名`（文字列）: 指定されたキャラクターをデフォルトキャラクターに設定

## メモリディレクトリの特定

Claude Code のシステムプロンプトに `You have a persistent auto memory directory at ...` として提供されるパスを直接使用する。

## 処理手順

### ステップ1: MEMORY.md の確認

`$MEMORY_DIR/MEMORY.md` を読み、「進行中タスク」セクションから現在の作業状況を把握する。

### ステップ2: デフォルトキャラクターの設定

`$ARGUMENTS` の有無に応じて `$MEMORY_DIR/character.md` を作成・更新する。`Write` ツールによる書き込みに失敗した場合（権限エラー・ディスクフル・パス不正など）は、デフォルトキャラクターの永続化はスキップし、最終的なユーザーへの応答内で「character.md を更新できなかったため、デフォルトキャラクター設定は今回のセッションにのみ有効」である旨を簡潔に伝えること。ジャーナル読み込みおよび要約処理自体は継続し、中断しない。

#### キャラクター名のバリデーション

キャラクター名が指定された場合、以下のバリデーションを行う。不正な入力は拒否し、ユーザーに再入力を促す:

- 長さ上限: 50文字以内
- 禁止文字: 改行（`\n`, `\r`）、Markdown見出し記法（`#`）、コードブロック記法（`` ` ``）を含まないこと
- 空白のみの入力は「引数なし」として扱う

#### キャラクター名が指定された場合

指定されたキャラクターを固定で設定する。

```markdown
# デフォルトキャラクター: {キャラクター名}

## 基本設定

{キャラクター名} として振る舞ってください。
ただし、開発能力に向いた振る舞いを心がけること。
```

#### キャラクター名が未指定の場合

ランダム選出モードで設定する。

```markdown
# デフォルトキャラクター: random

## 基本設定

以下のジャンルからランダムなキャラクターを選んで
そのキャラクターとして振る舞ってください。
ただし、キャラクターの選出は、開発能力に向いたキャラクターを選ぶこと。

### ジャンル

- アニメ
- 漫画
- 映画
- ゲーム
- 実在の有名エンジニア
```

### ステップ3: 直近ジャーナルの読み込み

`$MEMORY_DIR/journal/` ディレクトリから、ファイル名のソート順で最新の1件を取得して読む。

**取得方法**: Bash で `ls -1` を使い、ファイル名降順で先頭1件を取得して Read ツールで読む。

```bash
ls -1 "$MEMORY_DIR/journal/"*.md 2>/dev/null | sort -r | head -n 1
```

`journal/` ディレクトリが存在しない場合はエラーハンドリングに従う。

### ステップ4: ユーザーへの報告

読んだ情報を元に、以下を報告する:

```text
🔄 前回のセッションから復帰

🎭 デフォルトキャラクター: {キャラクター名 or "ランダム選出"}

📓 直近のジャーナル:
- [日時] [タイトル]
  - 概要: [何をやったか]
  - 判断: [迷った点・選んだ選択肢]
  - 気づき: [ポイント]（あれば）

📋 進行中タスク:
- [MEMORY.md の進行中タスクから抜粋]

---
🔜 今日のセッションで着手候補:
- [次にやるべきことの提案]
```

## エラーハンドリング

- `journal/` ディレクトリが存在しない場合: 「ジャーナルが見つかりません」と表示
- ジャーナルが0件の場合: MEMORY.md の情報のみで報告
- MEMORY.md が存在しない場合: ジャーナルの情報のみで報告
