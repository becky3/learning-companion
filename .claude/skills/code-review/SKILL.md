---
name: code-review
description: コミット前のセルフコードレビュー。テスト名と実装の整合性、エラーハンドリング、バリデーション、競合状態、リソース管理などの問題を検出する。
user-invocable: true
allowed-tools: Read, Grep, Glob, Bash
argument-hint: "[file-path|diff]"
---

## タスク

コミット前のセルフコードレビューを実施する。仕様書に基づく10のレビュー観点で問題を検出し、修正提案を行う。

## 引数

`$ARGUMENTS` の形式:

- ファイルパス指定: 該当ファイルをレビュー（例: `src/services/chat.py`）
- `diff`: `git diff` の変更差分をレビュー
- 未指定: `git diff --cached` のステージ済み変更をレビュー（なければ `git diff` の未ステージ変更）

## 仕様書の参照

レビューを開始する前に、必ず `docs/specs/agentic/agents/code-review-agent.md` を Read ツールで読み、以下の情報を確認すること:

- レビュー観点（10カテゴリ）の詳細
- 優先度の判定基準（Critical / Warning / Suggestion）
- 処理フローの詳細

**仕様書がレビュー基準の唯一の情報源（Single Source of Truth）である。**

## 処理手順

### 1. レビュー基準の把握

`docs/specs/agentic/agents/code-review-agent.md` を Read で読み込み、レビュー観点と判定基準を確認する。

### 2. レビュー対象の特定

- ファイルパスが指定された場合: 該当ファイルをレビュー
- 変更差分のレビューが依頼された場合: `git diff` の変更差分をレビュー
- 未指定の場合: `git diff --cached` のステージ済み変更をレビュー（なければ `git diff` の未ステージ変更）

テストファイルをレビューする場合は、対応する実装ファイルも読み込んで整合性を確認する。
実装ファイルをレビューする場合は、対応するテストファイルも確認する。

### 3. 仕様書との照合

対象ファイルに対応する仕様書があれば `docs/specs/` から読み込み、実装と仕様の整合性を確認する。

### 4. レビュー実施

仕様書に記載された10のレビュー観点（詳細は `docs/specs/agentic/agents/code-review-agent.md` 参照）に基づいて検査を実施する。

主なレビュー観点の概要:

1. テスト名・docstring と実装内容の整合性
2. エラーハンドリングの網羅性
3. バリデーション漏れ
4. 競合状態・TOCTOU の検出
5. リソース管理
6. コード品質
7. セキュリティ
8. プロジェクト規約との整合性
9. フォールバック/暗黙のデフォルト値パターンの検出
10. README.md 更新漏れの検出

### 5. レポート生成

下記の出力フォーマットに従ってレポートを生成する。

## 出力フォーマット

### 問題あり

```markdown
### コードレビュー結果

#### ファイル: {file-path}

**Critical（修正必須）:**

- [{行番号}] 問題の説明
  - 改善案: 具体的な修正提案

**Warning（修正推奨）:**

- [{行番号}] 問題の説明
  - 改善案: 具体的な修正提案

**Suggestion（改善検討）:**

- [{行番号}] 問題の説明
  - 改善案: 具体的な修正提案

---

#### 総評

- Critical: {N}件、Warning: {N}件、Suggestion: {N}件
- 総合的な評価と修正の優先順位の提案
```

### 問題なし

```markdown
### コードレビュー結果 ✅

レビュー対象のコードに問題は検出されませんでした。

- レビュー対象: {N}ファイル
- レビュー観点: 10カテゴリ
```

## 検出した問題への対処（必須）

検出した問題を「対応範囲外」「既存問題」としてスキップしてはならない。以下のルールに従って必ず対処すること:

- **軽微な問題**（typo、lint エラー、簡単な型エラー等）: その場で修正する
- **大きな問題**（設計変更が必要、影響範囲が広い等）: Issue を作成して記録する
- **判断に迷う場合**: ユーザーに相談する（自己判断でスキップしない）
