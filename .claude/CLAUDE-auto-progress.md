# 自動進行ルール（auto-progress）

> このファイルは GitHub Actions 環境（claude-code-action）専用のルール。
> ローカル対話セッションでは参照不要。
> 仕様: `docs/specs/auto-progress.md`

## 起動時の判断フロー

1. Issueの内容を読む（タイトル、本文、全コメント）
2. 仕様書の存在確認（`docs/specs/` に対応する仕様書があるか）
   - あり + AC定義済み: 仕様書に従って実装を開始
   - あり + AC未定義: ACを追加してから実装を開始
   - なし + Issue具体的: `/doc-gen spec` で仕様書を自動生成し、そのまま実装（事後拒否権モデル）
   - なし + Issue曖昧: `auto:failed` 付与、不明点をIssueにコメントして停止
3. 通常の開発ルール（仕様駆動開発）に従って実装
4. 実装完了後、通常の手順でPR作成まで行う（ベースブランチは `develop`）
5. ラベル更新:
   - 実装開始時: `auto-implement` ラベルを除去
   - 失敗時: `auto:failed` 付与

## Git運用

- PRのベースブランチは `develop`（`gh pr create --base develop`）
- `main` への直接PRは作成しない（リリースPR以外）
- ブランチ命名規則は既存ルールを踏襲

## Issue具体性の判定

具体的と見なす: 入出力例あり、具体的な変更指示、バグ再現手順あり
曖昧と見なす: 「検討」「改善」のみ、複数要求混在、外部仕様未確定

## `auto:failed` ラベル

`auto:failed` ラベルが付いたIssue/PRは自動処理を一切行わない。
自動処理の失敗時に自動付与されるほか、管理者が手動で付与して緊急停止にも使う。
再開するには `auto:failed` を除去し、`auto-implement` を再付与する。

## 品質チェック

GitHub Actions 環境では Skill ツールを使用しない。以下の4ステップを順番に全て実行すること。
途中で停止しないこと。全ステップ完了まで続けること。

### ステップ 1/4: テスト実行

```bash
# CRLF → LF 自動変換（Windows 環境の shellcheck SC1017 防止）
for f in .github/scripts/auto-fix/*.sh .github/scripts/post-merge/*.sh; do [ -f "$f" ] || continue; if grep -q $'\r' "$f" 2>/dev/null; then tmp=$(mktemp) && tr -d '\r' < "$f" > "$tmp" && mv "$tmp" "$f" && echo "[fix] CRLF→LF: $f"; fi; done

uv run pytest && uv run ruff check src/ tests/ && uv run mypy src/ && npx markdownlint-cli2@0.20.0 "CLAUDE.md" "docs/**/*.md" "*.md" ".claude/**/*.md" && uv run shellcheck .github/scripts/auto-fix/*.sh .github/scripts/post-merge/*.sh
```

- Markdown のみの変更の場合、pytest / ruff / mypy / shellcheck はスキップ可（markdownlint のみ実行）
- 失敗があれば修正して再実行。全て通過してから次へ進む

### ステップ 2/4: コードレビュー

`git diff` で変更差分を確認し、以下の観点でセルフレビュー:

- テスト名と実装の整合性
- エラーハンドリング（except pass の有無）
- バリデーション漏れ（境界値: 0, 負数, 空文字列）
- セキュリティ（コマンドインジェクション、XSS等）
- README.md 更新漏れ（機能追加・環境変数追加・依存関係変更時）

分類（Critical/Warning/Suggestion）は参考情報であり、判断に誤りが含まれる場合もある。各指摘について対応すべきかそれぞれ判断し、修正する。

### ステップ 3/4: ドキュメントレビュー

`docs/` や `CLAUDE.md` に変更がある場合、仕様書との整合性を確認する。
ドキュメント変更がなければスキップ可。

**ここで停止しないこと。次のステップ4を必ず実行すること。**

### ステップ 4/4: 完了処理（commit / push / PR作成 / Issue完了コメント）

1. `git status --porcelain` で変更確認（空なら停止）
2. `git add -A`
3. `git diff --cached --stat` で差分サマリ表示
4. 変更内容からコミットメッセージ自動生成（優先順位: fix > feat > docs > ci）
5. `git commit -m "生成したメッセージ"`
6. `BRANCH=$(git branch --show-current) && git push origin "$BRANCH"`
7. PR body は `.github/pull_request_template.md` の形式に従い、PR を作成する
8. `gh issue comment <Issue番号> --body "対応が完了しました。PR #<PR番号> をご確認ください。"`

エラー時: ステップ1-7は失敗で停止。ステップ8は警告して続行（PRは作成済み）。
commitが成功していない状態でpushしないこと。

## GitHub Actions 環境（claude-code-action）の制約

**対話不可の制約**:

- `AskUserQuestion` ツールは使用不可（`permission_denials` で拒否される）
- 不明点があっても質問せずに、以下の原則で自分で判断して進めること:
  - 情報不足で判断できない場合は、最も妥当な選択を行い、その判断理由をコメントに明記する
  - 曖昧な指示は、CLAUDE.md のルールに基づいて解釈する
  - 完璧を求めず、まず動くものを作ることを優先する

**Issueから実装する際の注意点**:

- **Issue本文だけでなく、コメントも必ず確認すること**
  - コメントに追加の要件・制約・補足情報が書かれていることがある
  - コメントの要件が仕様書のACに反映されていない場合は、ACに追加してから実装する
  - 過去の教訓: コメントで「外部サイトにアクセスしない」と明言されていたが、見落としてセキュリティ脆弱性が発生した

**タスク完了時の必須アクション**:

- 実装や設計書の作成を依頼された場合は、**必ず PR を作成すること**（`gh pr create --base develop`）
  - 調査のみ・設計案の提示のみの場合は PR 不要（Issue コメントで回答する）
- PRを作成したら、必ず対応したIssueに「新規コメント」として完了報告を投稿すること
- 既存コメントの編集ではなく、新しいコメントを追加する（編集では通知が飛ばないため）

**設定ファイル**: `.github/workflows/claude.yml`
