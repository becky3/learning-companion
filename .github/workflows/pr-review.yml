name: PR Review

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

# 通常PRは PRKit でレビュー。auto/ ブランチプレフィックス付きPRは copilot-auto-fix.yml に委譲。
on:
  pull_request:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  pr-review:
    # PR作成時 OR PRへの /review or /fix コメント時に実行
    if: |
      (
        (github.event_name == 'pull_request' &&
         (github.actor == 'becky3' || github.actor == 'github-actions[bot]')) ||
        (github.event_name == 'issue_comment' &&
         github.actor == 'becky3' &&
         github.event.issue.pull_request &&
         (startsWith(github.event.comment.body, '/review') || startsWith(github.event.comment.body, '/fix')))
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # issue_comment イベント時はPRのマージコミットをチェックアウト
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/merge', github.event.issue.number) || '' }}

      # PR番号のバリデーションを最初に行い、不正な場合は早期に失敗させる
      - name: Get PR number
        id: pr-number
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            PR_NUMBER="${{ github.event.issue.number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          if [ -z "$PR_NUMBER" ]; then
            echo "Error: PR number is empty" >&2
            exit 1
          fi
          # 数値バリデーション（0は無効なPR番号）
          if ! [[ "$PR_NUMBER" =~ ^[1-9][0-9]*$ ]]; then
            echo "Error: PR number is not a valid integer: '$PR_NUMBER'" >&2
            echo "This indicates GitHub event payload is malformed or missing expected fields" >&2
            exit 1
          fi
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

      # auto/ ブランチプレフィックス付きPRは copilot-auto-fix.yml がレビューするためスキップ
      # ステップレベルで判定: ::notice:: でスキップ理由をログに残すため
      # issue_comment イベント（/review, /fix コマンド）では適用しない:
      #   github.event.pull_request.head.ref が利用不可のため。
      #   /review は手動操作なので auto/ ブランチでも PRKit レビューを許可する設計判断。
      - name: Skip if auto/ branch prefix
        id: skip-auto
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-number.outputs.number }}"
          BRANCH="${{ github.event.pull_request.head.ref }}"
          if [ -z "$BRANCH" ]; then
            echo "::warning::Branch name is empty for PR #$PR_NUMBER. Continuing with review."
          elif [[ "$BRANCH" == auto/* ]]; then
            echo "::notice::PR #$PR_NUMBER has auto/ branch prefix. Skipping PRKit review (handled by copilot-auto-fix.yml)."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Get base branch
        id: base
        if: steps.skip-auto.outputs.skip != 'true'
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            OUTPUT=$(gh pr view ${{ steps.pr-number.outputs.number }} --json baseRefName -q .baseRefName 2>&1) || {
              EXIT_CODE=$?
              echo "Error: gh pr view command failed for PR #${{ steps.pr-number.outputs.number }} (exit code: $EXIT_CODE)" >&2
              echo "Command output: $OUTPUT" >&2
              echo "Possible causes: invalid PR number, GitHub API error, authentication failure" >&2
              exit 1
            }
            BASE="$OUTPUT"
          else
            BASE="${{ github.base_ref }}"
          fi
          if [ -z "$BASE" ]; then
            echo "Error: Base branch name is empty (PR metadata missing or corrupted)" >&2
            exit 1
          fi
          echo "ref=$BASE" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Get PR head commit
        id: pr-head
        if: steps.skip-auto.outputs.skip != 'true'
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            OUTPUT=$(gh pr view ${{ steps.pr-number.outputs.number }} --json headRefOid -q .headRefOid 2>&1) || {
              EXIT_CODE=$?
              echo "Error: gh pr view command failed for PR #${{ steps.pr-number.outputs.number }} (exit code: $EXIT_CODE)" >&2
              echo "Command output: $OUTPUT" >&2
              echo "Possible causes: invalid PR number, GitHub API error, authentication failure" >&2
              exit 1
            }
            COMMIT_ID="$OUTPUT"
          else
            COMMIT_ID="${{ github.event.pull_request.head.sha }}"
          fi
          if [ -z "$COMMIT_ID" ]; then
            echo "Error: PR head commit SHA is empty (PR metadata missing or corrupted)" >&2
            exit 1
          fi
          echo "sha=$COMMIT_ID" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - uses: anthropics/claude-code-action@5994afaaa7f44611addc97a696a135acff5fd218 # v1.0.46
        if: steps.skip-auto.outputs.skip != 'true'
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          bot_name: "claude[bot]"
          bot_id: "209825114"
          claude_args: "--model claude-opus-4-6 --max-turns 50 --dangerously-skip-permissions"
          show_full_output: true
          prompt: |
            このPRに対して包括的なコードレビューを実施してください。

            ## PR body の Change type 確認

            レビュー開始前に、PR body の「Change type」セクションを確認してください。
            `gh pr view ${{ steps.pr-number.outputs.number }} --json body -q .body` で取得できます。

            - `docs(pre-impl)` がチェックされている場合: **設計書の先行更新PRです。コードとの不整合は意図的であるため、「設計書とコードの不整合」を問題として報告しないでください。**
            - それ以外の場合: 通常通りレビューを実施してください。

            ## レビュー手順

            1. **変更内容の把握**: `git diff origin/${{ steps.base.outputs.ref }}...HEAD` で変更差分を確認

            2. **PR Review Toolkit エージェントを使用してレビュー**:
               以下のエージェントを順次実行し、それぞれの観点でレビューを行ってください。
               - `prt-code-reviewer`: CLAUDE.md準拠・バグ検出（信頼度80以上の問題のみ報告）
               - `prt-silent-failure-hunter`: サイレント障害・エラーハンドリングの問題検出
               - `prt-test-analyzer`: テストカバレッジの品質分析（テストファイルがある場合）

               型定義の追加・変更がある場合は追加で:
               - `prt-type-design-analyzer`: 型設計・不変条件の評価

               **重要**: レビュー対象は変更差分（diff）の範囲内のコードのみです。
               diff範囲外のコードに対する指摘は行わないでください。
               変更されていないコードの問題は、このPRの対応範囲外です。

            3. **問題検出時はコード行コメントを即座に投稿**:
               各エージェントが問題を検出したら、該当するコード行にコメントを投稿してください。
               これにより、check-prスキルで問題を検出可能になります。

               コード行コメント投稿コマンド:
               ```bash
               gh api "repos/${{ github.repository }}/pulls/${{ steps.pr-number.outputs.number }}/comments" \
                 -f body="[<エージェント名>] <問題の説明>" \
                 -f path="<ファイルパス>" \
                 -F line=<行番号> \
                 -f side=RIGHT \
                 -f commit_id="${{ steps.pr-head.outputs.sha }}"
               ```

               注意: gh apiコマンドが失敗した場合（該当行がdiff範囲外、APIレート制限、ネットワークエラーなど）:
               - 失敗したコメントの情報（ファイル、行番号、問題内容）をサマリーコメントの「投稿失敗」セクションに記載してください
               - 可能であれば最大3回までリトライを試みてください

               コード行コメントのルール:
               - 問題点のみコード行コメントとして投稿（提案や良い点はサマリーに含める）
               - 同一行に複数の問題がある場合は1つのコメントにまとめる
               - ファイルパスはリポジトリルートからの相対パス（例: `src/services/chat.py`）
               - 行番号は変更後のファイルの行番号を使用

            4. **サマリーをPRコメントとして投稿**:
               全エージェントの実行後、以下の形式でサマリーを投稿してください。

               ```markdown
               ## PR Review Toolkit 自動レビュー結果

               ### 検出された問題
               コード行コメントとして投稿済み（{N}件）

               ### 提案（改善検討）
               - [エージェント名] 提案内容

               ### 良い点
               - 適切に実装されている点

               ---
               *このレビューは PR Review Toolkit により自動生成されました*
               *問題の詳細は各コード行のコメントを参照してください*
               ```

            5. レビュー結果のサマリーには、必ず以下の機械可読フラグを含めてください。
               auto-fix.yml がレビュー結果を機械的に判定するために使用します。

               問題がない場合:
               ```
               <!-- auto-fix:no-issues commit=${{ steps.pr-head.outputs.sha }} -->
               レビューの結果、重大な問題は検出されませんでした。
               ```

               問題がある場合（ステップ4のサマリー内に含める）:
               ```
               <!-- auto-fix:has-issues commit=${{ steps.pr-head.outputs.sha }} -->
               ```

               **重要**: `commit=` にはレビュー対象のコミットSHAを含めてください。auto-fix.yml は最新コミットに対応するフラグのみを判定対象とします。

      # auto:fix-requested ラベルを付与して auto-fix を起動（PRKit 方式、現在休止中）
      # 条件:
      #   - /fix コマンド時: ユーザーが手動で auto-fix を起動したい場合
      #   - pull_request[opened] + auto:pipeline ラベルあり: 自動パイプラインで作成されたPRの初回レビュー後
      # 注記: auto:pipeline ラベル判定は休止中の PRKit 方式固有。Copilot 方式では
      #       auto/ ブランチプレフィックスで判定するが、本ステップは休止中のため変更しない。
      # /review のみ: ラベル付与なし（レビューのみ実行）
      - name: Add auto:fix-requested label for auto-fix
        if: |
          success() && steps.skip-auto.outputs.skip != 'true' && (
            (github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/fix')) ||
            github.event_name == 'pull_request'
          )
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-number.outputs.number }}"

          # REPO_OWNER_PAT チェック（未設定だと後続の gh コマンドも全て失敗するため先にチェック）
          if [ -z "${GH_TOKEN:-}" ]; then
            echo "::warning::REPO_OWNER_PAT is not set. Cannot add auto:fix-requested label."
            exit 0
          fi

          # 現在のラベルを API で取得
          # 注意: event payload の labels はPR作成時のスナップショットであり、
          # claude.yml が PR 作成後に auto:pipeline を付与するため最新状態を反映しない。
          # そのため gh pr view で最新のラベルを取得して判定する。
          if ! LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name' 2>&1); then
            echo "::warning::Failed to fetch labels for PR #$PR_NUMBER: $LABELS. Skipping."
            exit 0
          fi

          # pull_request[opened] の場合、auto:pipeline ラベルがなければスキップ
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            if ! echo "$LABELS" | grep -q "^auto:pipeline$"; then
              echo "PR #$PR_NUMBER does not have auto:pipeline label. Skipping auto:fix-requested."
              exit 0
            fi
          fi

          # auto:failed ラベルがある場合はスキップ（自動処理停止中）
          if echo "$LABELS" | grep -q "^auto:failed$"; then
            echo "::notice::PR #$PR_NUMBER has auto:failed label. Skipping auto:fix-requested label."
            exit 0
          fi

          # ラベルが既に付与済みの場合、--add-label では labeled イベントが発火しない
          # 除去→再付与で確実にイベントを発火させる
          if echo "$LABELS" | grep -q "^auto:fix-requested$"; then
            echo "PR #$PR_NUMBER already has auto:fix-requested label. Removing to retrigger."
            gh pr edit "$PR_NUMBER" --remove-label "auto:fix-requested" 2>&1 || true
          fi

          if ! ERROR_OUTPUT=$(gh pr edit "$PR_NUMBER" --add-label "auto:fix-requested" 2>&1); then
            echo "::warning::Failed to add auto:fix-requested label to PR #$PR_NUMBER: $ERROR_OUTPUT"
          else
            echo "Added auto:fix-requested label to PR #$PR_NUMBER (triggers auto-fix via labeled event)"
          fi
        env:
          GH_TOKEN: ${{ secrets.REPO_OWNER_PAT }}
          GH_REPO: ${{ github.repository }}

      # Slack通知（成功時は冗長なため失敗時のみ）
      - name: Slack notification
        if: failure()
        continue-on-error: true
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          mention: here
          if_mention: failure
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
