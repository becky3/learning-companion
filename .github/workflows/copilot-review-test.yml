# Copilot Review Event Test — 検証用ワークフロー（検証後に削除）
#
# 検証項目:
#   1. pull_request_review[submitted] で Copilot レビュー完了を検知できるか
#   2. reviewer の判別ができるか
#   3. unresolved threads をカウントできるか
#
# 関連: Issue #351

name: Copilot Review Test

on:
  pull_request_review:
    types: [submitted]

jobs:
  copilot-review-test:
    runs-on: ubuntu-latest
    steps:
      - name: Log review event
        run: |
          echo "=== Review Event Info ==="
          echo "Reviewer login: $REVIEWER_LOGIN"
          echo "Review state: ${{ github.event.review.state }}"
          echo "Review ID: ${{ github.event.review.id }}"
          echo "PR number: ${{ github.event.pull_request.number }}"
          echo "Event action: ${{ github.event.action }}"
          echo ""
          echo "=== Review Body (first 500 chars) ==="
          # body にバッククォート等が含まれるためファイル経由で出力
          cat <<'BODY_EOF' | head -c 500
          ${{ github.event.review.body }}
          BODY_EOF
          echo ""
        env:
          REVIEWER_LOGIN: ${{ github.event.review.user.login }}

      - name: Check if Copilot review
        id: check-copilot
        run: |
          echo "Reviewer login: $REVIEWER_LOGIN"

          # イベントペイロードでは "Copilot" で来る（REST API の "copilot-pull-request-reviewer[bot]" とは異なる）
          if [ "$REVIEWER_LOGIN" = "Copilot" ] || [ "$REVIEWER_LOGIN" = "copilot-pull-request-reviewer[bot]" ]; then
            echo "is_copilot=true" >> "$GITHUB_OUTPUT"
            echo "✅ This is a Copilot review"
          else
            echo "is_copilot=false" >> "$GITHUB_OUTPUT"
            echo "ℹ️ This is NOT a Copilot review (reviewer: $REVIEWER_LOGIN)"
          fi
        env:
          REVIEWER_LOGIN: ${{ github.event.review.user.login }}

      - name: Count unresolved threads
        if: steps.check-copilot.outputs.is_copilot == 'true'
        run: |
          set -euo pipefail
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"

          echo "=== Querying unresolved review threads ==="

          # GraphQL で unresolved threads をカウント（check-review-result.sh と同じロジック）
          # shellcheck disable=SC2016
          UNRESOLVED_COUNT=$(gh api graphql -f query='
            query($owner: String!, $name: String!, $number: Int!) {
              repository(owner: $owner, name: $name) {
                pullRequest(number: $number) {
                  reviewThreads(first: 100) {
                    nodes {
                      isResolved
                    }
                  }
                }
              }
            }
          ' -f owner="$REPO_OWNER" -f name="$REPO_NAME" -F number="$PR_NUMBER" \
            --jq '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)] | length')

          echo "Unresolved threads: $UNRESOLVED_COUNT"

          if [ "$UNRESOLVED_COUNT" -eq 0 ]; then
            echo "✅ No unresolved threads → merge path"
          else
            echo "⚠️ $UNRESOLVED_COUNT unresolved thread(s) → auto-fix path"
          fi

      - name: Count Copilot inline comments
        if: steps.check-copilot.outputs.is_copilot == 'true'
        run: |
          set -euo pipefail
          PR_NUMBER="${{ github.event.pull_request.number }}"

          echo "=== Copilot inline comments ==="

          COPILOT_COMMENTS=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/comments" \
            --jq '[.[] | select(.user.login == "copilot-pull-request-reviewer[bot]" or .user.login == "Copilot")] | length')

          echo "Copilot inline comments: $COPILOT_COMMENTS"

          # レビュー本文も確認
          echo ""
          echo "=== Copilot review body ==="
          gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
            --jq '.[] | select(.user.login == "copilot-pull-request-reviewer[bot]" or .user.login == "Copilot") | .body' | tail -1
        env:
          GH_TOKEN: ${{ github.token }}
