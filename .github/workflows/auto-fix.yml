# Auto Fix — レビュー指摘の自動修正ワークフロー
#
# エラーハンドリング方針:
#   認証/権限エラー        → exit 1（即停止）
#   一時的API障害          → リトライ or warning で続行
#   データ不存在(PR未作成等) → skip=true で正常終了
#   取得失敗(非クリティカル) → デフォルト値で続行
#   セキュリティ必須処理の失敗 → exit 1（禁止パターンチェック等）
#   エラーハンドラ内の失敗  → ベストエフォート（ログのみ）

name: Auto Fix

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

on:
  workflow_run:
    workflows: ["PR Review"]
    types: [completed]

jobs:
  auto-fix:
    # PR Review が success で完了した場合のみ実行（スキップ/失敗は除外）
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Get PR number from workflow_run
        id: pr-info
        run: |
          set -euo pipefail

          # workflow_run.pull_requests 配列からPR番号を取得
          PR_NUMBER=$(echo '${{ toJson(github.event.workflow_run.pull_requests) }}' | jq -r '.[0].number // empty')

          # pull_requests が空の場合、ブランチ名から検索
          if [ -z "$PR_NUMBER" ]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            if [ -z "$BRANCH" ]; then
              echo "::error::PR branch not found in workflow_run event"
              exit 1
            fi
            if ! PR_NUMBER=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number // empty'); then
              echo "::error::Failed to search PR by branch name: $BRANCH"
              exit 1
            fi
          fi

          if [ -z "$PR_NUMBER" ]; then
            echo "::notice::No PR found for this workflow run. Skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 数値バリデーション
          if ! [[ "$PR_NUMBER" =~ ^[1-9][0-9]*$ ]]; then
            echo "::error::Invalid PR number: '$PR_NUMBER'"
            exit 1
          fi

          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "PR number: $PR_NUMBER"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      - name: Check auto-implement scope
        if: steps.pr-info.outputs.skip != 'true'
        id: scope-check
        run: |
          set -euo pipefail

          # auto-implement 経由のPR（claude/issue-* ブランチ）のみ対象
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          if [ -z "$BRANCH" ]; then
            echo "::error::workflow_run.head_branch is empty"
            exit 1
          elif [[ "$BRANCH" == claude/issue-* ]]; then
            echo "in_scope=true" >> $GITHUB_OUTPUT
            echo "Branch '$BRANCH' matches auto-implement pattern"
          else
            echo "in_scope=false" >> $GITHUB_OUTPUT
            echo "::notice::Branch '$BRANCH' is not an auto-implement branch. Skipping."
          fi

      - name: Remove auto-implement label from linked Issue
        if: steps.pr-info.outputs.skip != 'true' && steps.scope-check.outputs.in_scope == 'true'
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          # PRのbodyから "Closes #N" パターンでIssue番号を抽出
          if ! PR_BODY=$(gh pr view "$PR_NUMBER" --json body --jq '.body // ""' 2>&1); then
            echo "::error::Failed to fetch PR body: $PR_BODY"
            exit 1
          fi

          # 複数のCloses/Fixes/Resolves パターンに対応（大文字小文字不問）
          # grep -P（PCRE）は ubuntu-latest で未対応の場合があるため -E（ERE）を使用
          ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -ioE '(closes|fixes|resolves)\s+#[0-9]+' | grep -oE '[0-9]+') || GREP_EXIT=$?
          GREP_EXIT=${GREP_EXIT:-0}
          if [ "$GREP_EXIT" -eq 1 ]; then
            # grep終了コード1 = マッチなし（正常）
            ISSUE_NUMBERS=""
          elif [ "$GREP_EXIT" -ge 2 ]; then
            echo "::error::grep failed with exit code $GREP_EXIT while parsing PR body"
            exit 1
          fi

          if [ -z "$ISSUE_NUMBERS" ]; then
            echo "::notice::No linked issue found in PR body. Skipping label removal."
          else
            while IFS= read -r ISSUE_NUMBER; do
              [ -z "$ISSUE_NUMBER" ] && continue
              echo "Removing auto-implement label from Issue #$ISSUE_NUMBER"
              # ラベル除去を試行し、エラー種別を区別（冪等性）
              if ! LABEL_ERR=$(gh issue edit "$ISSUE_NUMBER" --remove-label "auto-implement" 2>&1); then
                if echo "$LABEL_ERR" | grep -qi "not found\|does not have"; then
                  echo "::notice::Label 'auto-implement' not found on Issue #$ISSUE_NUMBER or already removed. Skipping."
                else
                  echo "::warning::Failed to remove label from Issue #$ISSUE_NUMBER: $LABEL_ERR"
                fi
              fi
            done <<< "$ISSUE_NUMBERS"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      - name: Check auto:failed label
        if: steps.pr-info.outputs.skip != 'true' && steps.scope-check.outputs.in_scope == 'true'
        id: check-failed
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          # 方針: 一時的API障害 → warning で安全側（skip）に倒す
          if ! LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name' 2>&1); then
            echo "::warning::Failed to get PR labels: $LABELS. Skipping as precaution."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if echo "$LABELS" | grep -q "^auto:failed$"; then
            echo "::notice::PR #$PR_NUMBER has auto:failed label. Skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      - name: Check loop count
        if: steps.pr-info.outputs.skip != 'true' && steps.scope-check.outputs.in_scope == 'true' && steps.check-failed.outputs.skip != 'true'
        id: loop-check
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          # auto-fix ループのマーカーコメント数をカウント
          # auto-fix.yml が /check-pr 実行前に投稿する「auto-fix: レビュー指摘への自動対応」コメントを対象
          if ! LOOP_COUNT=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --paginate --jq '[.[] | select(.user.login == "github-actions[bot]" and (.body | contains("auto-fix: レビュー指摘への自動対応")))] | length' 2>&1); then
            echo "::warning::Failed to get loop count: $LOOP_COUNT. Defaulting to 0."
            LOOP_COUNT=0
          fi

          # 数値バリデーション（API応答が不正な場合はデフォルト0で継続）
          if ! [[ "$LOOP_COUNT" =~ ^[0-9]+$ ]]; then
            echo "::warning::Invalid loop count value: '$LOOP_COUNT'. Defaulting to 0."
            LOOP_COUNT=0
          fi

          echo "loop_count=$LOOP_COUNT" >> $GITHUB_OUTPUT
          echo "Loop count: $LOOP_COUNT"

          if [ "$LOOP_COUNT" -ge 3 ]; then
            echo "limit_reached=true" >> $GITHUB_OUTPUT
            echo "::warning::Loop limit reached ($LOOP_COUNT >= 3)"
          else
            echo "limit_reached=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check review result
        if: steps.pr-info.outputs.skip != 'true' && steps.scope-check.outputs.in_scope == 'true' && steps.check-failed.outputs.skip != 'true'
        id: review-result
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"
          REPO_OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO_NAME="${GITHUB_REPOSITORY#*/}"

          # 方針: 一時的API障害 → リトライで対応
          # GraphQL で unresolved レビュースレッドを検索（最大5回、10秒間隔）
          UNRESOLVED_COUNT=""
          FIRST_ERROR=""
          LAST_ERROR=""
          for i in $(seq 1 5); do
            if UNRESOLVED_COUNT=$(gh api graphql -f query='
              query($owner: String!, $name: String!, $number: Int!) {
                repository(owner: $owner, name: $name) {
                  pullRequest(number: $number) {
                    reviewThreads(first: 100) {
                      nodes {
                        isResolved
                      }
                    }
                  }
                }
              }
            ' -f owner="${REPO_OWNER}" -f name="${REPO_NAME}" -F number="$PR_NUMBER" \
              --jq '
                .data.repository.pullRequest as $pr |
                if $pr == null then
                  error("PR not found")
                else
                  [$pr.reviewThreads.nodes[] | select(.isResolved == false)] | length
                end
              ' 2>&1); then
              # 数値バリデーション（リトライループ内で実行）
              if ! [[ "$UNRESOLVED_COUNT" =~ ^[0-9]+$ ]]; then
                echo "::warning::Invalid response format (attempt $i/5): '$UNRESOLVED_COUNT'. Retrying..."
                if [ -z "$FIRST_ERROR" ]; then
                  FIRST_ERROR="$UNRESOLVED_COUNT"
                fi
                LAST_ERROR="$UNRESOLVED_COUNT"
                UNRESOLVED_COUNT=""
                if [ "$i" -lt 5 ]; then
                  sleep 10
                  continue
                else
                  echo "::error::Failed to get valid response after 5 attempts."
                  echo "::error::First error: $FIRST_ERROR"
                  echo "::error::Last error: $LAST_ERROR"
                  exit 1
                fi
              fi
              # 成功 - エラー記録をクリア
              FIRST_ERROR=""
              LAST_ERROR=""
              break
            fi
            echo "::warning::Failed to query review threads (attempt $i/5): $UNRESOLVED_COUNT"
            if [ -z "$FIRST_ERROR" ]; then
              FIRST_ERROR="$UNRESOLVED_COUNT"
            fi
            LAST_ERROR="$UNRESOLVED_COUNT"
            if [ "$i" -lt 5 ]; then sleep 10; fi
          done

          # 最終的な数値バリデーション（全リトライ失敗時）
          if ! [[ "$UNRESOLVED_COUNT" =~ ^[0-9]+$ ]]; then
            echo "::error::Failed to get unresolved thread count after 5 attempts."
            echo "::error::First error: $FIRST_ERROR"
            echo "::error::Last error: $LAST_ERROR"
            exit 1
          fi

          echo "Unresolved review threads: $UNRESOLVED_COUNT"

          if [ "$UNRESOLVED_COUNT" -gt 0 ]; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo "Review result: $UNRESOLVED_COUNT unresolved thread(s) found"
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT
            echo "Review result: No unresolved threads"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      - name: Check forbidden patterns
        if: steps.pr-info.outputs.skip != 'true' && steps.scope-check.outputs.in_scope == 'true' && steps.check-failed.outputs.skip != 'true'
        id: forbidden-check
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          # PRの変更ファイル一覧を取得
          # 方針: セキュリティ必須処理の失敗 → exit 1（禁止パターンチェックのバイパス防止）
          if ! CHANGED_FILES=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path' 2>&1); then
            echo "::error::Failed to get changed files: $CHANGED_FILES"
            exit 1
          fi

          FORBIDDEN_FOUND=""

          while IFS= read -r file; do
            [ -z "$file" ] && continue

            # CLAUDE.md
            if [ "$file" = "CLAUDE.md" ]; then
              FORBIDDEN_FOUND="${FORBIDDEN_FOUND}${file}\n"
              continue
            fi

            # .claude/settings.json
            if [ "$file" = ".claude/settings.json" ]; then
              FORBIDDEN_FOUND="${FORBIDDEN_FOUND}${file}\n"
              continue
            fi

            # .env*
            if [[ "$file" == .env* ]]; then
              FORBIDDEN_FOUND="${FORBIDDEN_FOUND}${file}\n"
              continue
            fi

            # pyproject.toml の dependencies 変更検出
            if [ "$file" = "pyproject.toml" ]; then
              if ! DIFF=$(gh pr diff "$PR_NUMBER" -- "$file" 2>&1); then
                echo "::error::Failed to get diff for pyproject.toml: $DIFF"
                # 安全側に倒す: diff取得失敗時は依存関係変更ありと見なす
                FORBIDDEN_FOUND="${FORBIDDEN_FOUND}${file} (diff取得失敗のため要手動確認)\n"
                continue
              fi
              # 追加行・削除行の両方を対象にする
              if echo "$DIFF" | grep -qE '^[+-].*dependencies'; then
                FORBIDDEN_FOUND="${FORBIDDEN_FOUND}${file} (dependencies変更)\n"
              fi
              continue
            fi

            # .github/workflows/* は develop 向き緩和で対象外

          done <<< "$CHANGED_FILES"

          if [ -n "$FORBIDDEN_FOUND" ]; then
            echo "forbidden=true" >> $GITHUB_OUTPUT
            FORBIDDEN_LIST=$(echo -e "$FORBIDDEN_FOUND" | head -c 1000)
            echo "forbidden_files<<EOF" >> $GITHUB_OUTPUT
            echo "$FORBIDDEN_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "::warning::Forbidden patterns found"
          else
            echo "forbidden=false" >> $GITHUB_OUTPUT
            echo "No forbidden patterns found"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      # --- 分岐処理 ---

      # ループ上限到達 + 指摘あり → auto:failed 付与
      - name: Handle loop limit reached
        if: |
          steps.pr-info.outputs.skip != 'true' &&
          steps.scope-check.outputs.in_scope == 'true' &&
          steps.check-failed.outputs.skip != 'true' &&
          steps.loop-check.outputs.limit_reached == 'true' &&
          steps.review-result.outputs.has_issues == 'true'
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"
          LOOP_COUNT="${{ steps.loop-check.outputs.loop_count }}"

          gh issue edit "$PR_NUMBER" --add-label "auto:failed"
          gh pr comment "$PR_NUMBER" --body "## auto-fix: ループ上限到達

          レビュー→修正ループが上限（${LOOP_COUNT}回/3回）に達しました。
          未解決の指摘が残っているため、\`auto:failed\` ラベルを付与して自動処理を停止します。

          **次のアクション**: 管理者が手動で指摘に対応してください。
          対応完了後、\`auto:failed\` を除去して \`/review\` コメントを投稿すると再開できます。

          [Actions ログ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      # 禁止パターン検出 → auto:failed 付与
      - name: Handle forbidden patterns
        if: |
          steps.pr-info.outputs.skip != 'true' &&
          steps.scope-check.outputs.in_scope == 'true' &&
          steps.check-failed.outputs.skip != 'true' &&
          steps.forbidden-check.outputs.forbidden == 'true'
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          gh issue edit "$PR_NUMBER" --add-label "auto:failed"
          gh pr comment "$PR_NUMBER" --body "## auto-fix: 禁止パターン検出

          以下のファイルが変更に含まれているため、自動マージを停止します:

          \`\`\`
          ${{ steps.forbidden-check.outputs.forbidden_files }}
          \`\`\`

          これらのファイルは自動マージの対象外です（セキュリティ・安定性のため）。

          **次のアクション**: 管理者が手動でレビュー・マージしてください。

          [Actions ログ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      # 指摘あり + 上限未到達 → ループマーカーコメント投稿 + claude-code-action で自動修正
      - name: Post loop marker comment
        if: |
          steps.pr-info.outputs.skip != 'true' &&
          steps.scope-check.outputs.in_scope == 'true' &&
          steps.check-failed.outputs.skip != 'true' &&
          steps.loop-check.outputs.limit_reached != 'true' &&
          steps.forbidden-check.outputs.forbidden != 'true' &&
          steps.review-result.outputs.has_issues == 'true'
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"
          LOOP_COUNT="${{ steps.loop-check.outputs.loop_count }}"
          NEXT_COUNT=$((LOOP_COUNT + 1))

          gh pr comment "$PR_NUMBER" --body "## auto-fix: レビュー指摘への自動対応 (${NEXT_COUNT}/3)

          レビュー指摘を検出しました。\`/check-pr\` で自動修正を開始します。

          [Actions ログ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      - name: Checkout for auto-fix
        if: |
          steps.pr-info.outputs.skip != 'true' &&
          steps.scope-check.outputs.in_scope == 'true' &&
          steps.check-failed.outputs.skip != 'true' &&
          steps.loop-check.outputs.limit_reached != 'true' &&
          steps.forbidden-check.outputs.forbidden != 'true' &&
          steps.review-result.outputs.has_issues == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Auto-fix with Claude
        if: |
          steps.pr-info.outputs.skip != 'true' &&
          steps.scope-check.outputs.in_scope == 'true' &&
          steps.check-failed.outputs.skip != 'true' &&
          steps.loop-check.outputs.limit_reached != 'true' &&
          steps.forbidden-check.outputs.forbidden != 'true' &&
          steps.review-result.outputs.has_issues == 'true'
        id: auto-fix
        uses: anthropics/claude-code-action@5994afaaa7f44611addc97a696a135acff5fd218 # v1.0.46
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          bot_name: "claude[bot]"
          bot_id: "209825114"
          claude_args: "--model claude-sonnet-4-5-20250929 --max-turns 50 --dangerously-skip-permissions"
          show_full_output: true
          direct_prompt: |
            PR #${{ steps.pr-info.outputs.number }} のレビュー指摘に対応してください。
            以下の手順を順番に全て実行すること。途中で停止しないこと。

            ## ステップ 1/8: PR情報の確認

            ```bash
            gh pr view ${{ steps.pr-info.outputs.number }} --json title,body,headRefName,baseRefName
            gh pr view ${{ steps.pr-info.outputs.number }} --json files --jq '.files[].path'
            gh pr diff ${{ steps.pr-info.outputs.number }}
            ```

            ## ステップ 2/8: 未解決レビューコメントの取得

            まず owner/repo を取得する:

            ```bash
            OWNER=$(gh repo view --json owner --jq '.owner.login')
            REPO=$(gh repo view --json name --jq '.name')
            echo "Owner: $OWNER, Repo: $REPO"
            ```

            取得した OWNER, REPO を使って GraphQL で未解決スレッドを抽出:

            ```bash
            gh api graphql -f query="
            {
              repository(owner: \"$OWNER\", name: \"$REPO\") {
                pullRequest(number: ${{ steps.pr-info.outputs.number }}) {
                  reviewThreads(first: 100) {
                    nodes {
                      isResolved
                      comments(first: 10) {
                        nodes {
                          author { login }
                          body
                          path
                          line
                        }
                      }
                    }
                  }
                }
              }
            " --jq '.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false) | .comments.nodes[0] | {author: .author.login, path, line, body}'
            ```

            未解決の指摘がない場合は「未解決の指摘はありません」と表示して終了。

            ## ステップ 3/8: 関連仕様書の確認と修正実施

            - PRの目的に対応する `docs/specs/` の仕様書を特定して読む
            - 各指摘について:
              - 指摘対象のファイル・行を読み、コンテキストを理解する
              - 妥当な指摘かどうかを判断する
              - 妥当な指摘に対して修正を実施する
              - 妥当でない場合はスキップ理由を記録する

            ## ステップ 4/8: テスト実行

            注: GA環境ではサブエージェント（test-runner等）が利用できないため、直接実行する。

            ```bash
            uv run pytest && uv run ruff check src/ tests/ && uv run mypy src/
            npx markdownlint-cli2@0.20.0 "CLAUDE.md" "docs/**/*.md" "*.md" ".claude/**/*.md"
            ```

            Markdown のみの変更の場合、pytest / ruff / mypy はスキップ可（markdownlint のみ実行）。
            失敗があれば修正して再実行。全て通過してから次へ進む。

            ## ステップ 5/8: ドキュメント整合性チェック

            修正内容が以下のドキュメントの記述と矛盾しないか確認し、必要なら更新する:
            - `docs/specs/` — 仕様・受け入れ条件に影響する変更の場合
            - `CLAUDE.md` — 開発ルール・プロジェクト構造に影響する場合

            注: GA環境ではサブエージェント（doc-reviewer等）が利用できないため、`docs/` や `CLAUDE.md` に変更がある場合は自分で仕様書との整合性を確認すること。

            ## ステップ 6/8: PRに対応コメント投稿

            `gh pr comment ${{ steps.pr-info.outputs.number }}` で対応状況を投稿:
            - 各指摘に対して「対応済み ✅」「別Issue化 ⏸️」「対応不要（理由）❌」を明記

            ## ステップ 7/8: 対応済みスレッドの resolve

            対応済みと判断したスレッドのみ resolveReviewThread mutation で resolve する。
            以下のエラーハンドリング方針に従うこと:
            - owner/repo 取得失敗 → エラーログを出力して resolve をスキップ
            - 認証エラー（401/403） → エラーログを出力して即停止
            - 一時的API障害（個別resolve失敗） → warning でログし次のスレッドに継続
            - 全件resolve失敗 → 認証/権限エラーの可能性があるためエラーログを出力

            ```bash
            PR_NUMBER=${{ steps.pr-info.outputs.number }}

            # owner/repo の取得と検証（環境情報付きエラーログ）
            if ! OWNER=$(gh repo view --json owner --jq '.owner.login' 2>&1); then
              echo "::error::Failed to get repository owner: $OWNER (GH_REPO=${GH_REPO:-unset}, GH_TOKEN length=${#GH_TOKEN})"
              exit 1
            fi
            if ! REPO=$(gh repo view --json name --jq '.name' 2>&1); then
              echo "::error::Failed to get repository name: $REPO (GH_REPO=${GH_REPO:-unset}, OWNER=$OWNER)"
              exit 1
            fi

            # 未解決スレッドIDの取得
            THREADS=""
            QUERY_SUCCESS=true
            if ! THREADS=$(gh api graphql -f query="
            {
              repository(owner: \"$OWNER\", name: \"$REPO\") {
                pullRequest(number: $PR_NUMBER) {
                  reviewThreads(first: 100) {
                    nodes {
                      id
                      isResolved
                    }
                  }
                }
              }
            }" --jq '.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false) | .id' 2>&1); then
              QUERY_SUCCESS=false
              # GraphQLエラー形式を確認してからフォールバック
              if echo "$THREADS" | jq -e '.errors' > /dev/null 2>&1; then
                ERROR_TYPE=$(echo "$THREADS" | jq -r '.errors[0].type // "UNKNOWN"')
                ERROR_MSG=$(echo "$THREADS" | jq -r '.errors[0].message // "No message"')
                if [ "$ERROR_TYPE" = "FORBIDDEN" ] || [ "$ERROR_TYPE" = "UNAUTHORIZED" ]; then
                  echo "::error::GraphQL auth error (type=$ERROR_TYPE): $ERROR_MSG"
                  exit 1
                fi
                echo "::warning::GraphQL error (type=$ERROR_TYPE): $ERROR_MSG"
              elif echo "$THREADS" | grep -qE '401|403|authentication|forbidden'; then
                echo "::error::Authentication/permission error: $THREADS"
                exit 1
              else
                echo "::warning::Failed to query review threads: $THREADS"
              fi
              THREADS=""
            fi

            # スレッドの resolve（失敗カウンター付き、エラー種別分類）
            if [ -z "$THREADS" ]; then
              if [ "$QUERY_SUCCESS" = true ]; then
                echo "No unresolved threads to resolve. Skipping."
              else
                echo "::warning::Skipping resolve due to query failure."
              fi
            else
              RESOLVED=0
              FAILED=0
              while IFS= read -r THREAD_ID; do
                [ -z "$THREAD_ID" ] && continue
                if ! ERROR=$(gh api graphql -f query='
                mutation($threadId: ID!) {
                  resolveReviewThread(input: { threadId: $threadId }) {
                    thread { isResolved }
                  }
                }' -f threadId="$THREAD_ID" 2>&1); then
                  FAILED=$((FAILED + 1))
                  # エラー種別の推定と分類
                  if echo "$ERROR" | jq -e '.errors' > /dev/null 2>&1; then
                    ERR_TYPE=$(echo "$ERROR" | jq -r '.errors[0].type // "UNKNOWN"')
                    ERR_MSG=$(echo "$ERROR" | jq -r '.errors[0].message // "No message"')
                    echo "::warning::Failed to resolve thread $THREAD_ID: [GraphQL $ERR_TYPE] $ERR_MSG"
                  elif echo "$ERROR" | grep -qE '401|403|authentication|forbidden'; then
                    echo "::warning::Failed to resolve thread $THREAD_ID: [AUTH] $ERROR"
                  elif echo "$ERROR" | grep -qE 'not found|NOT_FOUND|Could not resolve'; then
                    echo "::warning::Failed to resolve thread $THREAD_ID: [NOT_FOUND] $ERROR"
                  else
                    echo "::warning::Failed to resolve thread $THREAD_ID: [API_ERROR] $ERROR"
                  fi
                else
                  RESOLVED=$((RESOLVED + 1))
                fi
              done <<< "$THREADS"

              echo "Resolved: $RESOLVED, Failed: $FAILED"
              if [ "$RESOLVED" -eq 0 ] && [ "$FAILED" -gt 0 ]; then
                echo "::error::All thread resolutions failed ($FAILED threads). Possible auth/permission issue."
                exit 1
              fi
            fi
            ```

            ## ステップ 8/8: コミット & push

            ```bash
            git add -A
            if [ -n "$(git status --porcelain)" ]; then
              git diff --cached --stat
              git commit -m "fix: レビュー指摘対応 (PR #${{ steps.pr-info.outputs.number }})"
              git push origin HEAD
            else
              echo "No changes to commit. Skipping."
            fi
            ```

      # NOTE: スレッドの resolve は check-pr スキル内で「対応済みと判断したスレッドのみ」を対象に実行される。
      # auto-fix.yml 側で無条件に全スレッドを resolve すると、未対応の指摘までクローズされるため、
      # ここでは resolve を行わない。

      # /review 再リクエスト（REPO_OWNER_PAT でワークフロー連鎖）
      - name: Request re-review
        if: |
          steps.pr-info.outputs.skip != 'true' &&
          steps.scope-check.outputs.in_scope == 'true' &&
          steps.check-failed.outputs.skip != 'true' &&
          steps.loop-check.outputs.limit_reached != 'true' &&
          steps.forbidden-check.outputs.forbidden != 'true' &&
          steps.review-result.outputs.has_issues == 'true'
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          if [ -z "$GH_TOKEN" ]; then
            echo "::error::REPO_OWNER_PAT is not set"
            exit 1
          fi

          # REPO_OWNER_PAT で /review コメントを投稿（pr-review.yml の再トリガー）
          # NOTE: pr-review.yml の if 条件は github.actor == 'becky3' を要求する。
          # REPO_OWNER_PAT の所有者がリポジトリオーナー (becky3) である前提で動作する。
          gh pr comment "$PR_NUMBER" --body "/review"
        env:
          GH_TOKEN: ${{ secrets.REPO_OWNER_PAT }}
          GH_REPO: ${{ github.repository }}

      # 指摘なし + 禁止パターンなし → マージ判定
      - name: Merge check
        if: |
          steps.pr-info.outputs.skip != 'true' &&
          steps.scope-check.outputs.in_scope == 'true' &&
          steps.check-failed.outputs.skip != 'true' &&
          steps.review-result.outputs.has_issues == 'false' &&
          steps.forbidden-check.outputs.forbidden != 'true'
        id: merge-check
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          MERGE_READY=true
          REASONS=""

          # 条件1: レビュー指摘ゼロ（既に has_issues=false で確認済み）
          echo "✅ Condition 1: No review issues"

          # 条件2: CI全チェック通過（GitHub API の statusCheckRollup を使用）
          if ! CI_RESULT=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '
            if .statusCheckRollup == null then
              "no_checks"
            else
              ([.statusCheckRollup[] |
                select(
                  (has("state") and .state != "SUCCESS" and .state != "NEUTRAL") or
                  (has("conclusion") and .conclusion != "SUCCESS" and .conclusion != "NEUTRAL" and .conclusion != "SKIPPED")
                )
              ] | length | tostring)
            end
          ' 2>&1); then
            MERGE_READY=false
            REASONS="${REASONS}\n- ❌ GitHub API error: Cannot verify CI status"
            echo "::warning::Failed to check CI status (API error, not CI failure): $CI_RESULT"
            echo "❌ Condition 2: API error (not CI failure)"
          elif [ "$CI_RESULT" = "no_checks" ]; then
            echo "✅ Condition 2: No CI checks configured"
          elif [ "$CI_RESULT" = "0" ]; then
            echo "✅ Condition 2: CI checks passed"
          else
            MERGE_READY=false
            REASONS="${REASONS}\n- ❌ CI checks not all passing ($CI_RESULT failing)"
            echo "❌ Condition 2: CI checks failed"
          fi

          # 条件3: コンフリクトなし（方針: 一時的API障害 → 安全側に倒してマージ拒否）
          if ! MERGEABLE=$(gh pr view "$PR_NUMBER" --json mergeable --jq '.mergeable' 2>&1); then
            MERGE_READY=false
            REASONS="${REASONS}\n- ❌ GitHub API error: Cannot verify mergeable status"
            echo "::warning::Failed to check mergeable status (API error): $MERGEABLE"
            echo "❌ Condition 3: API error (not conflict)"
          elif [ "$MERGEABLE" != "MERGEABLE" ]; then
            MERGE_READY=false
            REASONS="${REASONS}\n- ❌ PR has conflicts (status: $MERGEABLE)"
            echo "❌ Condition 3: Conflicts detected"
          else
            echo "✅ Condition 3: No conflicts"
          fi

          # 条件4: auto:failed ラベルなし（方針: 一時的API障害 → 安全側に倒してマージ拒否）
          if ! LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name' 2>&1); then
            MERGE_READY=false
            REASONS="${REASONS}\n- ❌ GitHub API error: Cannot verify labels"
            echo "::warning::Failed to retrieve labels (API error): $LABELS"
            echo "❌ Condition 4: API error (not label issue)"
          elif echo "$LABELS" | grep -q "^auto:failed$"; then
            MERGE_READY=false
            REASONS="${REASONS}\n- ❌ auto:failed label present"
            echo "❌ Condition 4: auto:failed label found"
          else
            echo "✅ Condition 4: No auto:failed label"
          fi

          echo "merge_ready=$MERGE_READY" >> $GITHUB_OUTPUT

          if [ "$MERGE_READY" = "true" ]; then
            echo "All merge conditions met"
          else
            echo "Merge conditions not met"
            echo "reasons<<EOF" >> $GITHUB_OUTPUT
            echo -e "$REASONS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      # 段階的マージ解禁: AUTO_MERGE_ENABLED で分岐
      # vars.AUTO_MERGE_ENABLED == 'true' → 実マージ、それ以外（未設定/'false'等） → ドライラン
      - name: Merge or dry-run
        if: |
          steps.pr-info.outputs.skip != 'true' &&
          steps.scope-check.outputs.in_scope == 'true' &&
          steps.check-failed.outputs.skip != 'true' &&
          steps.review-result.outputs.has_issues == 'false' &&
          steps.forbidden-check.outputs.forbidden != 'true' &&
          steps.merge-check.outputs.merge_ready == 'true'
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          if [ -z "$GH_TOKEN" ]; then
            echo "::error::REPO_OWNER_PAT is not set"
            exit 1
          fi

          AUTO_MERGE_RAW="${{ vars.AUTO_MERGE_ENABLED }}"
          AUTO_MERGE_ENABLED=$(echo "$AUTO_MERGE_RAW" | tr '[:upper:]' '[:lower:]')

          # 想定される値: "true", "false", "" (未設定)
          if [ -n "$AUTO_MERGE_ENABLED" ] && [ "$AUTO_MERGE_ENABLED" != "true" ] && [ "$AUTO_MERGE_ENABLED" != "false" ]; then
            echo "::warning::Unexpected AUTO_MERGE_ENABLED value: '$AUTO_MERGE_RAW'. Falling back to dry-run mode."
            AUTO_MERGE_ENABLED="false"
          fi

          if [ "$AUTO_MERGE_ENABLED" = "true" ]; then
            echo "AUTO_MERGE_ENABLED=true: Executing merge"
            if ! MERGE_ERR=$(gh pr merge "$PR_NUMBER" --merge 2>&1); then
              echo "::error::Merge failed: $MERGE_ERR"
              # マージ失敗時: auto:failed ラベル付与 + PRコメント（事後処理も error レベルで報告）
              if ! LABEL_ADD_ERR=$(gh issue edit "$PR_NUMBER" --add-label "auto:failed" 2>&1); then
                echo "::error::Failed to add auto:failed label: $LABEL_ADD_ERR — manual intervention required"
              fi
              if ! COMMENT_ERR=$(gh pr comment "$PR_NUMBER" --body "## auto-fix: 自動マージ失敗

          マージ条件は全て満たしていましたが、マージコマンドの実行に失敗しました:

          \`\`\`
          $MERGE_ERR
          \`\`\`

          **次のアクション**: エラー内容を確認し、手動でマージしてください。

          [Actions ログ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" 2>&1); then
                echo "::error::Failed to post merge failure comment: $COMMENT_ERR — manual intervention required"
              fi
              exit 1
            fi

            # マージ成功後のコメント投稿（非クリティカル: 失敗してもマージ自体は完了済み）
            if ! COMMENT_ERR=$(gh pr comment "$PR_NUMBER" --body "## auto-fix: 自動マージ完了

          全てのマージ条件を満たしたため、自動マージを実行しました:
          - ✅ レビュー指摘ゼロ
          - ✅ CI全チェック通過
          - ✅ コンフリクトなし
          - ✅ auto:failed ラベルなし

          [Actions ログ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" 2>&1); then
              echo "::warning::Merge succeeded but failed to post success comment: $COMMENT_ERR"
              echo "::notice::Merge was completed successfully. The comment failure is non-critical."
            fi
          else
            echo "AUTO_MERGE_ENABLED=${AUTO_MERGE_RAW:-<unset>}: Dry-run mode"
            # ドライラン時のコメント投稿（非クリティカル: 失敗しても判定結果はログに残る）
            if ! COMMENT_ERR=$(gh pr comment "$PR_NUMBER" --body "## auto-fix: マージ判定結果（ドライラン）

          全てのマージ条件を満たしています:
          - ✅ レビュー指摘ゼロ
          - ✅ CI全チェック通過
          - ✅ コンフリクトなし
          - ✅ auto:failed ラベルなし

          **ドライランモード**: \`AUTO_MERGE_ENABLED\` が有効でないため、判定結果の通知のみです。実際のマージは管理者が手動で行ってください。

          \`\`\`bash
          gh pr merge $PR_NUMBER --merge
          \`\`\`

          [Actions ログ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" 2>&1); then
              echo "::warning::Failed to post dry-run comment: $COMMENT_ERR"
              echo "::notice::Dry-run judgment is complete. All merge conditions are met. See Actions log for details."
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.REPO_OWNER_PAT }}
          GH_REPO: ${{ github.repository }}

      # マージ条件未達の通知
      - name: Merge conditions not met
        if: |
          steps.pr-info.outputs.skip != 'true' &&
          steps.scope-check.outputs.in_scope == 'true' &&
          steps.check-failed.outputs.skip != 'true' &&
          steps.review-result.outputs.has_issues == 'false' &&
          steps.forbidden-check.outputs.forbidden != 'true' &&
          steps.merge-check.outputs.merge_ready == 'false'
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          gh pr comment "$PR_NUMBER" --body "## auto-fix: マージ条件未達

          レビュー指摘はありませんが、以下の条件を満たしていません:

          ${{ steps.merge-check.outputs.reasons }}

          **次のアクション**: 上記の条件を解消してから \`/review\` で再レビューを実行してください。

          [Actions ログ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      # エラー時の auto:failed 付与
      - name: Handle errors
        if: failure() && steps.pr-info.outputs.skip != 'true' && steps.scope-check.outputs.in_scope == 'true' && steps.pr-info.outputs.number != ''
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          # ラベル付与を試行
          if ! LABEL_ERR=$(gh issue edit "$PR_NUMBER" --add-label "auto:failed" 2>&1); then
            echo "::error::Failed to add auto:failed label: $LABEL_ERR"
          fi

          # コメント投稿を試行
          if ! COMMENT_ERR=$(gh pr comment "$PR_NUMBER" --body "## auto-fix: エラー発生

          自動修正処理中にエラーが発生しました。\`auto:failed\` ラベルを付与して自動処理を停止します。

          **次のアクション**: [Actions ログ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) を確認し、問題を解消してください。
          対応完了後、\`auto:failed\` を除去して \`/review\` コメントを投稿すると再開できます。" 2>&1); then
            echo "::error::Failed to post error comment: $COMMENT_ERR"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      # Slack通知（失敗時のみ）
      - name: Slack notification
        if: failure()
        continue-on-error: true
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          mention: here
          if_mention: failure
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# concurrency 制御（ブランチ名ベース）
# NOTE: workflow_run イベントではPR番号が事前に不明なため、
# ブランチ名で制御する。同一ブランチのPRは1つのため実質PR単位の制御。
concurrency:
  group: auto-fix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false
