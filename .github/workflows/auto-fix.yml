# Auto Fix — レビュー指摘の自動修正ワークフロー
#
# コンセプト: 「YAMLはオーケストレーションのみ、ロジックはスクリプトに」
# スクリプト: .github/scripts/auto-fix/
# 設計書: docs/specs/auto-fix-structure.md
#
# エラーハンドリング方針:
#   認証/権限エラー        → exit 1（即停止）
#   一時的API障害          → リトライ or warning で続行
#   データ不存在(PR未作成等) → skip=true で正常終了
#   取得失敗(非クリティカル) → デフォルト値で続行
#   セキュリティ必須処理の失敗 → exit 1（禁止パターンチェック等）
#   エラーハンドラ内の失敗  → ベストエフォート（ログのみ）

name: Auto Fix

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

on:
  workflow_run:
    workflows: ["PR Review"]
    types: [completed]

jobs:
  auto-fix:
    # PR Review が success で完了した場合のみ実行（スキップ/失敗は除外）
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      # --- スクリプト・promptテンプレートの取得（全ステップで利用するため最初にcheckout） ---
      - name: Checkout scripts and prompts
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/scripts
            .github/prompts
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: Get PR number from workflow_run
        id: pr-info
        run: bash "$GITHUB_WORKSPACE/.github/scripts/auto-fix/get-pr-number.sh"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          PULL_REQUESTS_JSON: ${{ toJson(github.event.workflow_run.pull_requests) }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}

      - name: Check auto-implement scope
        if: steps.pr-info.outputs.skip != 'true'
        id: scope-check
        run: |
          set -euo pipefail

          # auto-implement 経由のPR（claude/issue-* ブランチ）のみ対象
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          if [ -z "$BRANCH" ]; then
            echo "::error::workflow_run.head_branch is empty"
            exit 1
          elif [[ "$BRANCH" == claude/issue-* ]]; then
            echo "in_scope=true" >> $GITHUB_OUTPUT
            echo "Branch '$BRANCH' matches auto-implement pattern"
          else
            echo "in_scope=false" >> $GITHUB_OUTPUT
            echo "::notice::Branch '$BRANCH' is not an auto-implement branch. Skipping."
          fi

      - name: Remove auto-implement label from linked Issue
        if: steps.pr-info.outputs.skip != 'true' && steps.scope-check.outputs.in_scope == 'true'
        run: bash "$GITHUB_WORKSPACE/.github/scripts/auto-fix/remove-label.sh"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr-info.outputs.number }}

      - name: Check auto:failed label
        if: steps.pr-info.outputs.skip != 'true' && steps.scope-check.outputs.in_scope == 'true'
        id: check-failed
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          # 方針: 一時的API障害 → warning で安全側（skip）に倒す
          if ! LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name' 2>&1); then
            echo "::warning::Failed to get PR labels: $LABELS. Skipping as precaution."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if echo "$LABELS" | grep -q "^auto:failed$"; then
            echo "::notice::PR #$PR_NUMBER has auto:failed label. Skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "skip=false" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      - name: Check loop count
        if: steps.pr-info.outputs.skip != 'true' && steps.scope-check.outputs.in_scope == 'true' && steps.check-failed.outputs.skip != 'true'
        id: loop-check
        run: bash "$GITHUB_WORKSPACE/.github/scripts/auto-fix/check-loop-count.sh"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr-info.outputs.number }}

      - name: Check review result
        if: steps.pr-info.outputs.skip != 'true' && steps.scope-check.outputs.in_scope == 'true' && steps.check-failed.outputs.skip != 'true'
        id: review-result
        run: bash "$GITHUB_WORKSPACE/.github/scripts/auto-fix/check-review-result.sh"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr-info.outputs.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Check forbidden patterns
        if: steps.pr-info.outputs.skip != 'true' && steps.scope-check.outputs.in_scope == 'true' && steps.check-failed.outputs.skip != 'true'
        id: forbidden-check
        run: bash "$GITHUB_WORKSPACE/.github/scripts/auto-fix/check-forbidden.sh"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr-info.outputs.number }}

      # --- ガード集約: ワークフロー分岐パスの判定 ---
      - name: Evaluate guards
        if: steps.pr-info.outputs.skip != 'true' && steps.scope-check.outputs.in_scope == 'true' && steps.check-failed.outputs.skip != 'true'
        id: guards
        run: |
          set -euo pipefail

          # 基本ガードは通過済み（このステップが実行される = proceed=true）
          echo "proceed=true" >> $GITHUB_OUTPUT

          # 分岐パスの判定
          LOOP_LIMIT_REACHED="${{ steps.loop-check.outputs.limit_reached }}"
          HAS_ISSUES="${{ steps.review-result.outputs.has_issues }}"
          FORBIDDEN="${{ steps.forbidden-check.outputs.forbidden }}"

          if [ "$LOOP_LIMIT_REACHED" = "true" ] && [ "$HAS_ISSUES" = "true" ]; then
            echo "path=loop_limit_reached" >> $GITHUB_OUTPUT
            echo "Workflow path: loop_limit_reached"
          elif [ "$FORBIDDEN" = "true" ]; then
            echo "path=forbidden_detected" >> $GITHUB_OUTPUT
            echo "Workflow path: forbidden_detected"
          elif [ "$HAS_ISSUES" = "true" ]; then
            echo "path=auto_fix" >> $GITHUB_OUTPUT
            echo "Workflow path: auto_fix"
          else
            echo "path=merge_check" >> $GITHUB_OUTPUT
            echo "Workflow path: merge_check"
          fi

      # --- 分岐処理 ---

      # ループ上限到達 + 指摘あり → auto:failed 付与
      - name: Handle loop limit reached
        if: steps.guards.outputs.proceed == 'true' && steps.guards.outputs.path == 'loop_limit_reached'
        run: |
          source "$GITHUB_WORKSPACE/.github/scripts/auto-fix/_common.sh"
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"
          LOOP_COUNT="${{ steps.loop-check.outputs.loop_count }}"

          gh_safe gh issue edit "$PR_NUMBER" --add-label "auto:failed"
          gh_comment "$PR_NUMBER" "## auto-fix: ループ上限到達

          レビュー→修正ループが上限（${LOOP_COUNT}回/3回）に達しました。
          未解決の指摘が残っているため、\`auto:failed\` ラベルを付与して自動処理を停止します。

          **次のアクション**: 管理者が手動で指摘に対応してください。
          対応完了後、\`auto:failed\` を除去して \`/review\` コメントを投稿すると再開できます。

          [Actions ログ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      # 禁止パターン検出 → auto:failed 付与
      - name: Handle forbidden patterns
        if: steps.guards.outputs.proceed == 'true' && steps.guards.outputs.path == 'forbidden_detected'
        run: |
          source "$GITHUB_WORKSPACE/.github/scripts/auto-fix/_common.sh"
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          gh_safe gh issue edit "$PR_NUMBER" --add-label "auto:failed"
          gh_comment "$PR_NUMBER" "## auto-fix: 禁止パターン検出

          以下のファイルが変更に含まれているため、自動マージを停止します:

          \`\`\`
          ${{ steps.forbidden-check.outputs.forbidden_files }}
          \`\`\`

          これらのファイルは自動マージの対象外です（セキュリティ・安定性のため）。

          **次のアクション**: 管理者が手動でレビュー・マージしてください。

          [Actions ログ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      # 指摘あり + 上限未到達 → ループマーカーコメント投稿 + claude-code-action で自動修正
      - name: Post loop marker comment
        if: steps.guards.outputs.proceed == 'true' && steps.guards.outputs.path == 'auto_fix'
        run: |
          source "$GITHUB_WORKSPACE/.github/scripts/auto-fix/_common.sh"
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"
          LOOP_COUNT="${{ steps.loop-check.outputs.loop_count }}"
          NEXT_COUNT=$((LOOP_COUNT + 1))

          gh_comment "$PR_NUMBER" "## auto-fix: レビュー指摘への自動対応 (${NEXT_COUNT}/3)

          レビュー指摘を検出しました。\`/check-pr\` で自動修正を開始します。

          [Actions ログ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      - name: Checkout for auto-fix
        if: steps.guards.outputs.proceed == 'true' && steps.guards.outputs.path == 'auto_fix'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Load prompt template
        if: steps.guards.outputs.proceed == 'true' && steps.guards.outputs.path == 'auto_fix'
        id: load-prompt
        run: |
          set -euo pipefail
          TEMPLATE_PATH="$GITHUB_WORKSPACE/.github/prompts/auto-fix-check-pr.md"
          if [ ! -f "$TEMPLATE_PATH" ]; then
            echo "::error::Prompt template not found: $TEMPLATE_PATH"
            exit 1
          fi

          # テンプレート内のプレースホルダーを置換
          PROMPT=$(cat "$TEMPLATE_PATH")
          PROMPT="${PROMPT//\{\{PR_NUMBER\}\}/$PR_NUMBER}"

          # multiline output の設定
          # heredoc形式: 開始デリミタ → 内容 → 終了デリミタ
          # 参考: https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#multiline-strings
          echo "prompt<<PROMPT_EOF" >> "$GITHUB_OUTPUT"
          echo "$PROMPT" >> "$GITHUB_OUTPUT"
          echo "PROMPT_EOF" >> "$GITHUB_OUTPUT"
        env:
          PR_NUMBER: ${{ steps.pr-info.outputs.number }}

      - name: Auto-fix with Claude
        if: steps.guards.outputs.proceed == 'true' && steps.guards.outputs.path == 'auto_fix'
        id: auto-fix
        uses: anthropics/claude-code-action@5994afaaa7f44611addc97a696a135acff5fd218 # v1.0.46
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          bot_name: "claude[bot]"
          bot_id: "209825114"
          claude_args: "--model claude-sonnet-4-5-20250929 --max-turns 100 --dangerously-skip-permissions"
          show_full_output: true
          prompt: |
            ${{ steps.load-prompt.outputs.prompt }}

      # NOTE: スレッドの resolve は check-pr スキル内で「対応済みと判断したスレッドのみ」を対象に実行される。
      # auto-fix.yml 側で無条件に全スレッドを resolve すると、未対応の指摘までクローズされるため、
      # ここでは resolve を行わない。

      # /review 再リクエスト（REPO_OWNER_PAT でワークフロー連鎖）
      - name: Request re-review
        if: steps.guards.outputs.proceed == 'true' && steps.guards.outputs.path == 'auto_fix'
        run: |
          source "$GITHUB_WORKSPACE/.github/scripts/auto-fix/_common.sh"
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          if [ -z "$GH_TOKEN" ]; then
            echo "::error::REPO_OWNER_PAT is not set"
            exit 1
          fi

          # REPO_OWNER_PAT で /review コメントを投稿（pr-review.yml の再トリガー）
          # NOTE: pr-review.yml の if 条件は github.actor == 'becky3' を要求する。
          # REPO_OWNER_PAT の所有者がリポジトリオーナー (becky3) である前提で動作する。
          gh_safe gh pr comment "$PR_NUMBER" --body "/review"
        env:
          GH_TOKEN: ${{ secrets.REPO_OWNER_PAT }}
          GH_REPO: ${{ github.repository }}

      # 指摘なし + 禁止パターンなし → マージ判定
      - name: Merge check
        if: steps.guards.outputs.proceed == 'true' && steps.guards.outputs.path == 'merge_check'
        id: merge-check
        run: bash "$GITHUB_WORKSPACE/.github/scripts/auto-fix/merge-check.sh"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr-info.outputs.number }}

      # 段階的マージ解禁: AUTO_MERGE_ENABLED で分岐
      # vars.AUTO_MERGE_ENABLED == 'true' → 実マージ、それ以外（未設定/'false'等） → ドライラン
      - name: Merge or dry-run
        if: steps.guards.outputs.proceed == 'true' && steps.guards.outputs.path == 'merge_check' && steps.merge-check.outputs.merge_ready == 'true'
        run: bash "$GITHUB_WORKSPACE/.github/scripts/auto-fix/merge-or-dryrun.sh"
        env:
          GH_TOKEN: ${{ secrets.REPO_OWNER_PAT }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr-info.outputs.number }}
          AUTO_MERGE_ENABLED: ${{ vars.AUTO_MERGE_ENABLED }}
          ACTIONS_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      # マージ条件未達の通知
      - name: Merge conditions not met
        if: steps.guards.outputs.proceed == 'true' && steps.guards.outputs.path == 'merge_check' && steps.merge-check.outputs.merge_ready == 'false'
        run: |
          source "$GITHUB_WORKSPACE/.github/scripts/auto-fix/_common.sh"
          PR_NUMBER="${{ steps.pr-info.outputs.number }}"

          gh_comment "$PR_NUMBER" "## auto-fix: マージ条件未達

          レビュー指摘はありませんが、以下の条件を満たしていません:

          ${{ steps.merge-check.outputs.reasons }}

          **次のアクション**: 上記の条件を解消してから \`/review\` で再レビューを実行してください。

          [Actions ログ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      # エラー時の auto:failed 付与（スクリプト外部化 + YAMLフォールバック）
      - name: Handle errors
        if: failure() && steps.pr-info.outputs.number != '' && steps.scope-check.outputs.in_scope == 'true'
        run: |
          SCRIPT_PATH="$GITHUB_WORKSPACE/.github/scripts/auto-fix/handle-errors.sh"
          if [ -f "$SCRIPT_PATH" ]; then
            bash "$SCRIPT_PATH"
          else
            echo "::warning::Script not found (checkout may have failed), running minimal error handler"
            # 最小限のフォールバック: ラベル付与 + PRコメント（ベストエフォート）
            PR_NUMBER="${{ steps.pr-info.outputs.number }}"
            ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            if ! LABEL_ERR=$(gh issue edit "$PR_NUMBER" --add-label "auto:failed" 2>&1); then
              echo "::error::Failed to add auto:failed label: $LABEL_ERR"
            fi
            if ! COMMENT_ERR=$(gh pr comment "$PR_NUMBER" --body "## auto-fix: エラー発生

          自動修正処理中にエラーが発生しました。\`auto:failed\` ラベルを付与して自動処理を停止します。

          **次のアクション**: [Actions ログ]($ACTIONS_URL) を確認し、問題を解消してください。
          対応完了後、\`auto:failed\` を除去して \`/review\` コメントを投稿すると再開できます。" 2>&1); then
              echo "::error::Failed to post error comment: $COMMENT_ERR"
            fi
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr-info.outputs.number }}
          ACTIONS_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          COMMON_SCRIPT_PATH: ${{ github.workspace }}/.github/scripts/auto-fix/_common.sh

      # Slack通知（失敗時のみ）
      - name: Slack notification
        if: failure()
        continue-on-error: true
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          mention: here
          if_mention: failure
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# concurrency 制御（ブランチ名ベース）
# NOTE: workflow_run イベントではPR番号が事前に不明なため、
# ブランチ名で制御する。同一ブランチのPRは1つのため実質PR単位の制御。
concurrency:
  group: auto-fix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false
